        function updateOpacity(opacity) {
            appState.opacity = opacity;
            document.getElementById('opacity-value').textContent = opacity;
        }

        function undoDrawing() {
            if (appState.historyStep > 0) {
                appState.historyStep--;
                restoreCanvas();
                showNotification('Undone!', 'info');
            }
        }

        function redoDrawing() {
            if (appState.historyStep < appState.history.length - 1) {
                appState.historyStep++;
                restoreCanvas();
                showNotification('Redone!', 'info');
            }
        }

        function restoreCanvas() {
            const img = new Image();
            img.onload = () => {
                appState.ctx.clearRect(0, 0, appState.canvas.width, appState.canvas.height);
                appState.ctx.drawImage(img, 0, 0);
            };
            img.src = appState.history[appState.historyStep];
        }

        function clearCanvas() {
            if (confirm('Are you sure you want to clear the canvas?')) {
                appState.ctx.fillStyle = 'white';
                appState.ctx.fillRect(0, 0, appState.canvas.width, appState.canvas.height);
                saveCanvasState();
                showNotification('Canvas cleared!', 'info');
            }
        }

        function saveCanvas() {
            const link = document.createElement('a');
            link.download = 'coloring-page-' + new Date().getTime() + '.png';
            link.href = appState.canvas.toDataURL();
            link.click();
            showNotification('Canvas saved!', 'success');
        }

        function loadTemplate(templateName) {
            // Simplified template loading
            const centerX = appState.canvas.width / 2;
            const centerY = appState.canvas.height / 2;
            
            appState.ctx.fillStyle = 'white';
            appState.ctx.fillRect(0, 0, appState.canvas.width, appState.canvas.height);
            appState.ctx.strokeStyle = '#000000';
            appState.ctx.lineWidth = 2;
            
            // Draw simple template based on name
            appState.ctx.beginPath();
            switch (templateName) {
                case 'butterfly':
                    appState.ctx.ellipse(centerX, centerY, 5, 80, 0, 0, 2 * Math.PI);
                    appState.ctx.ellipse(centerX - 40, centerY - 30, 30, 50, 0, 0, 2 * Math.PI);
                    appState.ctx.ellipse(centerX + 40, centerY - 30, 30, 50, 0, 0, 2 * Math.PI);
                    break;
                case 'flower':
                    for (let i = 0; i < 8; i++) {
                        const angle = (i * Math.PI) / 4;
                        const petalX = centerX + Math.cos(angle) * 40;
                        const petalY = centerY + Math.sin(angle) * 40;
                        appState.ctx.ellipse(petalX, petalY, 15, 30, angle, 0, 2 * Math.PI);
                    }
                    appState.ctx.arc(centerX, centerY, 20, 0, 2 * Math.PI);
                    break;
                case 'star':
                    const spikes = 5;
                    const outerRadius = 60;
                    const innerRadius = 30;
                    for (let i = 0; i < spikes * 2; i++) {
                        const radius = i % 2 === 0 ? outerRadius : innerRadius;
                        const angle = (i * Math.PI) / spikes;
                        const pointX = centerX + Math.cos(angle) * radius;
                        const pointY = centerY + Math.sin(angle) * radius;
                        if (i === 0) appState.ctx.moveTo(pointX, pointY);
                        else appState.ctx.lineTo(pointX, pointY);
                    }
                    appState.ctx.closePath();
                    break;
                case 'heart':
                    appState.ctx.moveTo(centerX, centerY + 30);
                    appState.ctx.bezierCurveTo(centerX - 50, centerY - 30, centerX - 100, centerY + 20, centerX, centerY + 80);
                    appState.ctx.bezierCurveTo(centerX + 100, centerY + 20, centerX + 50, centerY - 30, centerX, centerY + 30);
                    break;
                default:
                    appState.ctx.arc(centerX, centerY, 50, 0, 2 * Math.PI);
            }
            appState.ctx.stroke();
            saveCanvasState();
            showNotification(`${templateName} template loaded!`, 'success');
        }

        // PDF Export Functions
        function initializePDFSection() {
            updatePageDimensions();
            updateMarginDisplay();
            updateSpecifications();
            loadProjectsForPDF();
        }

        function updatePageDimensions() {
            const pageSize = document.getElementById('page-size-pdf').value;
            const customDiv = document.getElementById('custom-dimensions');
            
            if (pageSize === 'custom') {
                customDiv.style.display = 'grid';
            } else {
                customDiv.style.display = 'none';
            }
            
            updatePreviewLayout();
            updateSpecifications();
        }

        function updateMarginDisplay() {
            const marginV = document.getElementById('margin-vertical').value;
            const marginH = document.getElementById('margin-horizontal').value;
            
            document.getElementById('margin-v-value').textContent = marginV;
            document.getElementById('margin-h-value').textContent = marginH;
            
            updateContentArea();
            updatePreviewLayout();
        }

        function updateContentArea() {
            const pageSize = document.getElementById('page-size-pdf').value;
            const marginV = parseFloat(document.getElementById('margin-vertical').value);
            const marginH = parseFloat(document.getElementById('margin-horizontal').value);
            
            let pageWidth, pageHeight;
            
            switch (pageSize) {
                case 'letter': pageWidth = 8.5; pageHeight = 11; break;
                case 'square-8.5': pageWidth = 8.5; pageHeight = 8.5; break;
                case 'square-9': pageWidth = 9; pageHeight = 9; break;
                case 'legal': pageWidth = 8.5; pageHeight = 14; break;
                case 'a4': pageWidth = 8.27; pageHeight = 11.69; break;
                case 'a5': pageWidth = 5.83; pageHeight = 8.27; break;
                case 'tabloid': pageWidth = 11; pageHeight = 17; break;
                case 'custom':
                    pageWidth = parseFloat(document.getElementById('custom-width').value) || 8.5;
                    pageHeight = parseFloat(document.getElementById('custom-height').value) || 8.5;
                    break;
                default: pageWidth = 8.5; pageHeight = 11;
            }
            
            const contentWidth = pageWidth - (marginH * 2);
            const contentHeight = pageHeight - (marginV * 2);
            
            document.getElementById('content-area').textContent = `${contentWidth.toFixed(1)}" × ${contentHeight.toFixed(1)}"`;
            
            return { pageWidth, pageHeight, contentWidth, contentHeight, marginV, marginH };
        }

        function updatePreviewLayout() {
            const preview = document.getElementById('pdf-preview');
            const content = document.getElementById('preview-content');
            const dimensions = updateContentArea();
            
            preview.style.aspectRatio = `${dimensions.pageWidth}/${dimensions.pageHeight}`;
            
            const marginPercentH = (dimensions.marginH / dimensions.pageWidth) * 100;
            const marginPercentV = (dimensions.marginV / dimensions.pageHeight) * 100;
            
            content.style.margin = `${marginPercentV}% ${marginPercentH}%`;
            content.style.width = `${100 - (marginPercentH * 2)}%`;
            content.style.height = `${100 - (marginPercentV * 2)}%`;
            content.style.border = '2px dashed #3b82f6';
            content.style.backgroundColor = '#f8fafc';
        }

        function updateSpecifications() {
            const dimensions = updateContentArea();
            const quality = document.getElementById('pdf-quality').value;
            const colorMode = appState.currentColorMode;
            const includeBleed = document.getElementById('include-bleed')?.checked;
            
            document.getElementById('spec-page-size').textContent = `${dimensions.pageWidth}" × ${dimensions.pageHeight}"`;
            document.getElementById('spec-margins').textContent = `${dimensions.marginV}" top/bottom, ${dimensions.marginH}" left/right`;
            document.getElementById('spec-content-area').textContent = `${dimensions.contentWidth.toFixed(1)}" × ${dimensions.contentHeight.toFixed(1)}"`;
            
            const dpiMap = {
                'web': '72 DPI',
                'print-standard': '150 DPI', 
                'print-high': '300 DPI',
                'professional': '600 DPI'
            };
            document.getElementById('spec-resolution').textContent = dpiMap[quality] || '300 DPI';
            document.getElementById('spec-color-profile').textContent = colorMode.toUpperCase();
            document.getElementById('spec-bleed').textContent = includeBleed ? '0.125" bleed' : 'None';
        }

        function loadProjectsForPDF() {
            const select = document.getElementById('pdf-project');
            if (!select) return;
            
            select.innerHTML = '<option value="">Choose a project to export...</option>';
            
            appState.projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = `${project.title} (${project.pages.length} pages)`;
                select.appendChild(option);
            });
        }

        function loadProjectPages() {
            const projectId = document.getElementById('pdf-project').value;
            const project = appState.projects.find(p => p.id === projectId);
            
            if (!project) {
                document.getElementById('generate-pdf-btn').disabled = true;
                updateContentArea();
                return;
            }
            
            document.getElementById('generate-pdf-btn').disabled = false;
            document.getElementById('end-page').value = project.pages.length;
            
            const storyPages = project.pages.filter(p => p.type === 'story').length;
            const coloringPages = project.pages.filter(p => p.type === 'coloring').length;
            const totalPages = project.pages.length;
            
            document.getElementById('total-pages').textContent = totalPages;
            document.getElementById('story-pages').textContent = storyPages;
            document.getElementById('coloring-pages').textContent = coloringPages;
            
            const quality = document.getElementById('pdf-quality').value;
            const sizeMultiplier = { 'web': 0.3, 'print-standard': 0.8, 'print-high': 1.5, 'professional': 3.0 };
            const estimatedSize = Math.ceil(totalPages * (sizeMultiplier[quality] || 1.5));
            document.getElementById('estimated-size').textContent = estimatedSize + ' MB';
            
            const costPerPage = 0.15;
            const printCost = (totalPages * costPerPage).toFixed(2);
            document.getElementById('print-cost').textContent = '                    </div>
                    
                    <div class="story-text mb-4 text-gray-800 leading-relaxed text-lg bg-white rounded-lg p-4 shadow-inner border-l-4 border-blue-500">
                        ${page.story}
                    </div>
                    
                    <div class="image-prompt-section border-t-2 border-gray-200 pt-4">
                        <details class="text-sm bg-gray-50 rounded-lg">
                            <summary class="cursor-pointer text-gray-700 font-semibold p-3 rounded-lg hover:bg-gray-100 transition-colors flex items-center gap-2">
                                🎨 AI Image Prompt
                                <span class="text-xs bg-gray-200 px-2 py-1 rounded ml-auto">Click to expand</span>
                            </summary>
                            <div class="mt-2 p-4 bg-white rounded border-l-4 border-purple-500">
                                <div class="text-xs text-gray-600 font-mono leading-relaxed">
                                    ${page.imagePrompt}
                                </div>
                                <div class="mt-3 flex gap-2">
                                    <span class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded">
                                        📐 ${appState.currentStory.metadata.aspectRatio}
                                    </span>
                                    <span class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded">
                                        ✏️ Line Weight: ${appState.currentStory.metadata.lineWeight}/10
                                    </span>
                                    <span class="text-xs bg-yellow-100 text-yellow-600 px-2 py-1 rounded">
                                        🎨 ${appState.currentStory.metadata.imageStyle}
                                    </span>
                                </div>
                            </div>
                        </details>
                        
                        <div id="generated-image-${page.pageNumber - 1}" class="mt-4">
                            ${page.imageGenerated ? 
                                `<div class="bg-green-50 border-2 border-green-200 rounded-lg p-4 text-center">
                                    <div class="text-green-600 font-semibold mb-2">✅ Image Generated</div>
                                    <div class="text-sm text-green-500">Click "Generate Image" to regenerate</div>
                                </div>` : 
                                `<div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6 text-center">
                                    <div class="text-blue-600 font-semibold mb-2">🎨 Ready for Image Generation</div>
                                    <div class="text-sm text-blue-500">Click "Generate Image" above to create the illustration</div>
                                    <div class="mt-3">
                                        <button onclick="generateSingleImage(${page.pageNumber - 1})" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                            🎨 Generate Now
                                        </button>
                                    </div>
                                </div>`
                            }
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = `
                <div class="story-cards-container">
                    <div class="mb-6 bg-gradient-to-r from-green-100 to-blue-100 rounded-xl p-4 border-2 border-green-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-bold text-green-800">📖 Story Generated Successfully!</h3>
                                <p class="text-sm text-green-600">${storyData.pages.length} pages • ${storyData.pages.reduce((sum, p) => sum + p.wordCount, 0)} total words • ${storyData.metadata.imageStyle} style</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="generateAllImages()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors text-sm">
                                    🖼️ Generate All Images
                                </button>
                            </div>
                        </div>
                    </div>
                    ${cardsHtml}
                </div>
            `;
        }

        async function generateSingleImage(pageIndex) {
            if (!appState.currentStory || !appState.currentStory.pages[pageIndex]) {
                showNotification('Invalid page index', 'error');
                return;
            }
            
            const page = appState.currentStory.pages[pageIndex];
            const imageContainer = document.getElementById(`generated-image-${pageIndex}`);
            
            imageContainer.innerHTML = '<div class="text-center">🎨 Generating image...<br><small>Using AI image generation</small></div>';
            
            try {
                let imageData;
                
                // Try to use real AI image generation if possible
                if (appState.apiKey) {
                    try {
                        imageData = await generateRealImage(page.imagePrompt);
                    } catch (error) {
                        console.log('Real AI image generation failed, using fallback:', error);
                        imageData = createAdvancedColoringPageFromPrompt(
                            page.imagePrompt,
                            appState.currentStory.metadata.imageStyle,
                            appState.currentStory.metadata.lineWeight,
                            appState.currentStory.metadata.aspectRatio
                        );
                    }
                } else {
                    // Use enhanced placeholder generation
                    imageData = createAdvancedColoringPageFromPrompt(
                        page.imagePrompt,
                        appState.currentStory.metadata.imageStyle,
                        appState.currentStory.metadata.lineWeight,
                        appState.currentStory.metadata.aspectRatio
                    );
                }
                
                page.imageGenerated = true;
                page.imageData = imageData;
                
                imageContainer.innerHTML = `
                    <div class="border rounded p-2">
                        <div class="mb-2">${imageData}</div>
                        <div class="flex gap-2 justify-center">
                            <button onclick="downloadPageImage(${pageIndex})" class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded hover:bg-green-200">📥 Download</button>
                            <button onclick="editPageImage(${pageIndex})" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200">✏️ Edit</button>
                            <button onclick="regeneratePageImage(${pageIndex})" class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded hover:bg-purple-200">🔄 Regenerate</button>
                        </div>
                    </div>
                `;
                
                showNotification(`Image generated for page ${pageIndex + 1}!`, 'success');
                
            } catch (error) {
                imageContainer.innerHTML = '<div class="text-center text-red-500">❌ Failed to generate image</div>';
                showNotification('Failed to generate image: ' + error.message, 'error');
            }
        }

        async function generateRealImage(prompt) {
            if (appState.imageService === 'none' || !appState.imageApiKey) {
                throw new Error('Image generation API not configured');
            }
            
            try {
                let imageUrl;
                
                switch (appState.imageService) {
                    case 'openai':
                        imageUrl = await generateWithOpenAI(prompt);
                        break;
                    case 'stabilityai':
                        imageUrl = await generateWithStabilityAI(prompt);
                        break;
                    case 'replicate':
                        imageUrl = await generateWithReplicate(prompt);
                        break;
                    default:
                        throw new Error('Unsupported image service');
                }
                
                if (imageUrl) {
                    return `
                        <div class="w-full max-w-md mx-auto bg-white rounded-lg shadow-lg border-2 border-gray-200">
                            <div class="p-4 border-b bg-gray-50">
                                <h3 class="font-semibold text-gray-800">AI Generated Coloring Page</h3>
                                <div class="text-xs text-gray-600 mt-1">
                                    Generated with ${appState.imageService} • Model: ${appState.imageModel}
                                </div>
                            </div>
                            <div class="p-4">
                                <img src="${imageUrl}" alt="Generated coloring page" class="w-full h-auto rounded border" 
                                     style="max-height: 400px; object-fit: contain;">
                                <div class="mt-3 text-xs text-gray-500">
                                    <div><strong>Prompt:</strong> ${prompt.substring(0, 100)}${prompt.length > 100 ? '...' : ''}</div>
                                    <div class="mt-1"><strong>Service:</strong> ${appState.imageService} (${appState.imageModel})</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Real image generation failed:', error);
                throw error;
            }
        }

        async function generateWithOpenAI(prompt) {
            const response = await fetch('https://api.openai.com/v1/images/generations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${appState.imageApiKey}`
                },
                body: JSON.stringify({
                    model: appState.imageModel,
                    prompt: prompt + ' coloring book style, black and white line art, no color, clear outlines',
                    n: 1,
                    size: '1024x1024',
                    style: 'natural'
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(`OpenAI API Error: ${error.error?.message || 'Failed to generate image'}`);
            }

            const data = await response.json();
            return data.data[0].url;
        }

        async function generateWithStabilityAI(prompt) {
            const response = await fetch('https://api.stability.ai/v1/generation/stable-diffusion-xl-1024-v1-0/text-to-image', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${appState.imageApiKey}`
                },
                body: JSON.stringify({
                    text_prompts: [{
                        text: prompt + ' coloring book style, black and white line art, no shading, clear outlines for coloring',
                        weight: 1
                    }],
                    cfg_scale: 7,
                    height: 1024,
                    width: 1024,
                    samples: 1,
                    steps: 30
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(`Stability AI Error: ${error.message || 'Failed to generate image'}`);
            }

            const data = await response.json();
            return `data:image/png;base64,${data.artifacts[0].base64}`;
        }

        async function generateWithReplicate(prompt) {
            // Note: Replicate requires a different approach with prediction creation and polling
            // This is a simplified version - you'd need to implement the full polling mechanism
            const response = await fetch('https://api.replicate.com/v1/predictions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Token ${appState.imageApiKey}`
                },
                body: JSON.stringify({
                    version: "stability-ai/sdxl:39ed52f2a78e934b3ba6e2a89f5b1c712de7dfea535525255b1aa35c5565e08b",
                    input: {
                        prompt: prompt + ' coloring book style, black and white line art, clear outlines',
                        negative_prompt: 'color, shading, gradient, photorealistic'
                    }
                })
            });

            if (!response.ok) {
                throw new Error('Replicate API Error');
            }

            const prediction = await response.json();
            
            // In a real implementation, you'd poll the prediction URL until completion
            // For now, we'll simulate this with a timeout
            await sleep(10000);
            
            // Get the completed prediction (this is simplified)
            const resultResponse = await fetch(`https://api.replicate.com/v1/predictions/${prediction.id}`, {
                headers: {
                    'Authorization': `Token ${appState.imageApiKey}`
                }
            });

            if (resultResponse.ok) {
                const result = await resultResponse.json();
                return result.output?.[0] || null;
            }
            
            throw new Error('Replicate generation timeout');
        }

        function createAdvancedColoringPageFromPrompt(prompt, style, lineWeight, aspectRatio) {
            // Enhanced coloring page generator based on detailed prompt
            const aspectRatios = {
                'square': { width: 400, height: 400 },
                'landscape': { width: 400, height: 300 },
                'portrait': { width: 300, height: 400 },
                'wide': { width: 500, height: 280 }
            };
            
            const dimensions = aspectRatios[aspectRatio] || aspectRatios.square;
            
            // Extract key elements from prompt
            let mainElements = [];
            const subjects = {
                'rabbit': { emoji: '🐰', paths: 'M200,150 Q180,120 160,130 Q140,140 150,160 Q160,180 180,175 Q200,170 220,175 Q240,180 250,160 Q260,140 240,130 Q220,120 200,150 Z' },
                'cat': { emoji: '🐱', paths: 'M200,140 Q170,110 140,125 Q120,140 130,165 Q140,190 170,185 Q200,180 230,185 Q260,190 270,165 Q280,140 260,125 Q230,110 200,140 Z' },
                'flower': { emoji: '🌸', paths: 'M200,200 Q180,180 160,200 Q180,220 200,200 Q220,180 240,200 Q220,220 200,200 Z' },
                'tree': { emoji: '🌳', paths: 'M180,250 L220,250 L220,350 L180,350 Z M200,100 Q160,120 140,160 Q140,200 180,220 Q220,220 260,200 Q260,160 240,120 Q200,100 200,100 Z' },
                'house': { emoji: '🏠', paths: 'M120,200 L200,120 L280,200 L280,300 L120,300 Z M200,220 L220,220 L220,280 L180,280 L180,220 Z' },
                'butterfly': { emoji: '🦋', paths: 'M200,150 Q190,130 180,140 Q160,150 170,170 Q180,180 190,175 Q200,170 210,175 Q220,180 230,170 Q240,150 220,140 Q210,130 200,150 Z' },
                'star': { emoji: '⭐', paths: 'M200,120 L210,160 L250,160 L220,185 L230,225 L200,200 L170,225 L180,185 L150,160 L190,160 Z' },
                'heart': { emoji: '❤️', paths: 'M200,180 Q170,150 140,160 Q120,180 140,200 Q160,220 200,250 Q240,220 260,200 Q280,180 260,160 Q230,150 200,180 Z' }
            };
            
            let mainPaths = [];
            
            // Find subjects in prompt
            for (const [key, data] of Object.entries(subjects)) {
                if (prompt.toLowerCase().includes(key)) {
                    mainElements.push(data.emoji);
                    mainPaths.push(data.paths);
                }
            }
            
            if (mainElements.length === 0) {
                mainElements = ['🎨'];
                mainPaths = ['M200,200 m -50,0 a 50,50 0 1,0 100,0 a 50,50 0 1,0 -100,0'];
            }
            
            return `
                <svg width="100%" height="200px" viewBox="0 0 ${dimensions.width} ${dimensions.height}" class="border rounded bg-white">
                    <defs>
                        <pattern id="grid-${aspectRatio}" width="20" height="20" patternUnits="userSpaceOnUse">
                            <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#f8f8f8" stroke-width="0.5"/>
                        </pattern>
                    </defs>
                    
                    <rect width="${dimensions.width}" height="${dimensions.height}" fill="white"/>
                    <rect width="${dimensions.width}" height="${dimensions.height}" fill="url(#grid-${aspectRatio})" opacity="0.3"/>
                    
                    <!-- Main elements from prompt -->
                    ${mainElements.map((emoji, i) => `
                        <text x="${dimensions.width/2 + (i-1)*60}" y="${dimensions.height/2}" text-anchor="middle" font-size="${40 + lineWeight*3}" opacity="0.8">${emoji}</text>
                    `).join('')}
                    
                    <!-- Style-based decorative elements -->
                    <circle cx="${dimensions.width/2}" cy="${dimensions.height/2}" r="${80 + lineWeight*8}" fill="none" stroke="#333" stroke-width="${lineWeight}"/>
                    
                    ${style === 'detailed' || style === 'realistic' ? `
                        <circle cx="${dimensions.width*0.2}" cy="${dimensions.height*0.3}" r="25" fill="none" stroke="#333" stroke-width="${lineWeight*0.8}"/>
                        <circle cx="${dimensions.width*0.8}" cy="${dimensions.height*0.3}" r="25" fill="none" stroke="#333" stroke-width="${lineWeight*0.8}"/>
                        <circle cx="${dimensions.width*0.2}" cy="${dimensions.height*0.7}" r="25" fill="none" stroke="#333" stroke-width="${lineWeight*0.8}"/>
                        <circle cx="${dimensions.width*0.8}" cy="${dimensions.height*0.7}" r="25" fill="none" stroke="#333" stroke-width="${lineWeight*0.8}"/>
                    ` : ''}
                    
                    <!-- Border decoration -->
                    <rect x="10" y="10" width="${dimensions.width-20}" height="${dimensions.height-20}" fill="none" stroke="#333" stroke-width="${lineWeight*0.6}" rx="5"/>
                    
                    <text x="${dimensions.width/2}" y="${dimensions.height-5}" text-anchor="middle" font-size="8" fill="#666">
                        ${style} • Line Weight: ${lineWeight} • ${aspectRatio}
                    </text>
                </svg>
            `;
        }

        async function regeneratePageImage(pageIndex) {
            const page = appState.currentStory.pages[pageIndex];
            if (!page) return;
            
            const imageContainer = document.getElementById(`generated-image-${pageIndex}`);
            imageContainer.innerHTML = '<div class="text-center">🔄 Regenerating image...<br><small>Creating new variation</small></div>';
            
            // Add some variation to the prompt for regeneration
            const variations = [
                ' with more detail',
                ' in a different pose',
                ' from a different angle',
                ' with additional background elements',
                ' with simplified composition'
            ];
            
            const variation = variations[Math.floor(Math.random() * variations.length)];
            const modifiedPrompt = page.imagePrompt + variation;
            
            setTimeout(() => {
                const newImageData = createAdvancedColoringPageFromPrompt(
                    modifiedPrompt,
                    appState.currentStory.metadata.imageStyle,
                    appState.currentStory.metadata.lineWeight,
                    appState.currentStory.metadata.aspectRatio
                );
                
                page.imageData = newImageData;
                
                imageContainer.innerHTML = `
                    <div class="border rounded p-2">
                        <div class="mb-2">${newImageData}</div>
                        <div class="flex gap-2 justify-center">
                            <button onclick="downloadPageImage(${pageIndex})" class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded hover:bg-green-200">📥 Download</button>
                            <button onclick="editPageImage(${pageIndex})" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200">✏️ Edit</button>
                            <button onclick="regeneratePageImage(${pageIndex})" class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded hover:bg-purple-200">🔄 Regenerate</button>
                        </div>
                    </div>
                `;
                
                showNotification(`Image regenerated for page ${pageIndex + 1}!`, 'success');
            }, 2000);
        }

        async function generateAllImages() {
            if (!appState.currentStory || !appState.currentStory.pages) {
                showNotification('No story available', 'warning');
                return;
            }
            
            showNotification('Generating all images... This may take a few minutes.', 'info');
            
            for (let i = 0; i < appState.currentStory.pages.length; i++) {
                await generateSingleImage(i);
                await sleep(1000); // Delay between generations
            }
            
            showNotification('All images generated successfully! 🎉', 'success');
        }

        function downloadPageImage(pageIndex) {
            const page = appState.currentStory.pages[pageIndex];
            if (!page.imageData) {
                showNotification('No image to download', 'warning');
                return;
            }
            
            const svgData = page.imageData.match(/<svg[^>]*>.*<\/svg>/s)[0];
            const svgBlob = new Blob([svgData], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(svgBlob);
            
            const link = document.createElement('a');
            link.download = `story-page-${pageIndex + 1}-${new Date().getTime()}.svg`;
            link.href = url;
            link.click();
            
            URL.revokeObjectURL(url);
            showNotification(`Page ${pageIndex + 1} image downloaded!`, 'success');
        }

        function editPageImage(pageIndex) {
            showSection('canvas');
            showNotification(`Edit page ${pageIndex + 1} image in canvas`, 'info');
        }

        function exportStoryCards() {
            if (!appState.currentStory) {
                showNotification('No story to export', 'warning');
                return;
            }
            
            // Create a comprehensive export of the story cards
            const exportData = {
                title: 'Generated Coloring Book Story',
                generatedAt: new Date().toISOString(),
                metadata: appState.currentStory.metadata,
                pages: appState.currentStory.pages.map(page => ({
                    pageNumber: page.pageNumber,
                    story: page.story,
                    imagePrompt: page.imagePrompt,
                    wordCount: page.wordCount,
                    hasImage: page.imageGenerated
                }))
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.download = `story-cards-${new Date().getTime()}.json`;
            link.href = url;
            link.click();
            
            URL.revokeObjectURL(url);
            showNotification('Story cards exported!', 'success');
        }

        function loadStoryTemplate(templateType) {
            const templates = {
                adventure: {
                    theme: 'Epic adventure through magical lands',
                    characters: 'Brave knight Sir Luna, wise dragon Ember',
                    moral: 'Courage and determination'
                },
                friendship: {
                    theme: 'Forest animals working together',
                    characters: 'Curious rabbit Pip, gentle bear Bruno, clever fox Sage',
                    moral: 'The power of friendship and cooperation'
                },
                fantasy: {
                    theme: 'Enchanted kingdom with magical creatures',
                    characters: 'Young wizard apprentice Zara, talking unicorn Starlight',
                    moral: 'Believing in yourself and using magic responsibly'
                }
            };
            
            const template = templates[templateType];
            if (template) {
                document.getElementById('story-theme').value = template.theme;
                document.getElementById('story-characters').value = template.characters;
                document.getElementById('story-moral').value = template.moral;
                showNotification(`Loaded ${templateType} template`, 'info');
            }
        }

        function saveStory() {
            if (!appState.currentProject) {
                showNotification('Please select a project first', 'warning');
                return;
            }
            
            if (!appState.currentStory) {
                showNotification('No story to save', 'warning');
                return;
            }
            
            const storyPage = {
                id: generateId(),
                type: 'story',
                content: { 
                    text: appState.currentStory,
                    wordCount: appState.currentStory.replace(/<[^>]*>/g, '').split(' ').length,
                    version: 1
                },
                pageNumber: appState.currentProject.pages.length + 1,
                createdAt: new Date().toISOString()
            };
            
            appState.currentProject.pages.push(storyPage);
            appState.currentProject.updatedAt = new Date().toISOString();
            saveProjects();
            showNotification('Story saved to project!', 'success');
        }

        // Canvas and Drawing Functions (simplified for space)
        function initializeCanvas() {
            console.log('Initializing canvas...');
            appState.canvas = document.getElementById('drawingCanvas');
            if (!appState.canvas) {
                console.error('Canvas element not found!');
                return;
            }
            
            appState.ctx = appState.canvas.getContext('2d');
            appState.ctx.fillStyle = 'white';
            appState.ctx.fillRect(0, 0, appState.canvas.width, appState.canvas.height);
            appState.ctx.lineCap = 'round';
            appState.ctx.lineJoin = 'round';
            
            // Bind basic events (simplified)
            appState.canvas.addEventListener('mousedown', startDrawing);
            appState.canvas.addEventListener('mousemove', draw);
            appState.canvas.addEventListener('mouseup', stopDrawing);
            
            saveCanvasState();
            console.log('Canvas initialized successfully');
        }

        function initializeColorPalette() {
            const colors = [
                '#000000', '#FFFFFF', '#FF0000', '#00FF00', '#0000FF', '#FFFF00',
                '#FF00FF', '#00FFFF', '#800000', '#008000', '#000080', '#808000',
                '#800080', '#008080', '#FFA500', '#FFC0CB', '#A52A2A', '#808080',
                '#FFB6C1', '#98FB98', '#87CEEB', '#DDA0DD', '#F0E68C', '#FF6347'
            ];
            
            const palette = document.getElementById('color-palette');
            if (!palette) return;
            
            palette.innerHTML = colors.map((color, index) => `
                <div class="color-swatch w-6 h-6 rounded cursor-pointer border-2 border-gray-300 ${index === 0 ? 'active' : ''}" 
                     style="background-color: ${color}" 
                     onclick="selectColor('${color}', this)"></div>
            `).join('');
        }

        // Simplified drawing functions
        function startDrawing(e) {
            appState.isDrawing = true;
            draw(e);
        }

        function draw(e) {
            if (!appState.isDrawing) return;
            const rect = appState.canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (appState.canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (appState.canvas.height / rect.height);
            
            appState.ctx.globalCompositeOperation = appState.drawingMode === 'erase' ? 'destination-out' : 'source-over';
            appState.ctx.lineWidth = appState.brushSize;
            appState.ctx.strokeStyle = appState.currentColor;
            appState.ctx.globalAlpha = appState.opacity / 100;
            
            appState.ctx.lineTo(x, y);
            appState.ctx.stroke();
            appState.ctx.beginPath();
            appState.ctx.moveTo(x, y);
        }

        function stopDrawing() {
            if (appState.isDrawing) {
                appState.isDrawing = false;
                appState.ctx.beginPath();
                appState.ctx.globalAlpha = 1;
                saveCanvasState();
            }
        }

        function saveCanvasState() {
            appState.historyStep++;
            if (appState.historyStep < appState.history.length) {
                appState.history.length = appState.historyStep;
            }
            appState.history.push(appState.canvas.toDataURL());
        }

        function selectColor(color, element) {
            appState.currentColor = color;
            document.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.classList.remove('active');
            });
            if (element) element.classList.add('active');
        }

        function setDrawingMode(mode) {
            appState.drawingMode = mode;
        }

        function updateBrushSize(size) {
            appState.brushSize = size;
            document.getElementById('brush-size-value').textContent = size;
        }

        function updateOpacity(            };
            
            appState.projects.push(project);
            appState.currentProject = project;
            saveProjects();
            loadProjects();
            showSection('projects');
            showNotification('Project created successfully!', 'success');
        }

        function loadProjects() {
            const projectsGrid = document.getElementById('projects-grid');
            const recentProjects = document.getElementById('recent-projects');
            
            if (appState.projects.length === 0) {
                projectsGrid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500">No projects yet. Create your first project to get started.</div>';
                recentProjects.innerHTML = '<p class="text-gray-500 text-center py-8">No recent projects. Create a new project to get started.</p>';
                return;
            }
            
            projectsGrid.innerHTML = appState.projects.map(project => `
                <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
                    <div class="p-6">
                        <h3 class="text-xl font-semibold mb-2">${project.title}</h3>
                        <p class="text-gray-600 mb-2">${project.description || 'No description'}</p>
                        <p class="text-sm text-gray-500 mb-4">${project.pages.length} pages • ${formatDate(project.createdAt)}</p>
                        <div class="flex gap-2">
                            <button onclick="openProject('${project.id}')" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition-colors">Open</button>
                            <button onclick="duplicateProject('${project.id}')" class="px-3 py-2 bg-green-100 text-green-600 rounded hover:bg-green-200 transition-colors">📋</button>
                            <button onclick="deleteProject('${project.id}')" class="px-3 py-2 bg-red-100 text-red-600 rounded hover:bg-red-200 transition-colors">🗑️</button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            const recent = appState.projects.slice(-3).reverse();
            recentProjects.innerHTML = recent.map(project => `
                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                    <div>
                        <h4 class="font-medium">${project.title}</h4>
                        <p class="text-sm text-gray-500">${project.pages.length} pages • ${formatDate(project.createdAt)}</p>
                    </div>
                    <button onclick="openProject('${project.id}')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors">Open</button>
                </div>
            `).join('');
        }

        function openProject(projectId) {
            appState.currentProject = appState.projects.find(p => p.id === projectId);
            showNotification(`Opened project: ${appState.currentProject.title}`, 'success');
            showSection('story');
        }

        function duplicateProject(projectId) {
            const original = appState.projects.find(p => p.id === projectId);
            if (!original) return;
            
            const duplicate = {
                ...original,
                id: generateId(),
                title: original.title + ' (Copy)',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                pages: [...original.pages.map(page => ({ ...page, id: generateId() }))]
            };
            
            appState.projects.push(duplicate);
            saveProjects();
            loadProjects();
            showNotification('Project duplicated successfully!', 'success');
        }

        function deleteProject(projectId) {
            const project = appState.projects.find(p => p.id === projectId);
            if (!project) return;
            
            if (confirm(`Are you sure you want to delete "${project.title}"? This action cannot be undone.`)) {
                appState.projects = appState.projects.filter(p => p.id !== projectId);
                if (appState.currentProject && appState.currentProject.id === projectId) {
                    appState.currentProject = null;
                }
                saveProjects();
                loadProjects();
                showNotification('Project deleted successfully!', 'success');
            }
        }

        function saveProjects() {
            localStorage.setItem('colorbook-projects', JSON.stringify(appState.projects));
        }

        // KDP Compliance Functions
        function initializeKDPSection() {
            loadProjectsForKDP();
        }

        function loadProjectsForKDP() {
            const select = document.getElementById('kdp-project');
            if (!select) return;
            
            select.innerHTML = '<option value="">Choose a project to analyze...</option>';
            
            appState.projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = `${project.title} (${project.pages.length} pages)`;
                select.appendChild(option);
            });
        }

        function loadKDPProjectCheck() {
            const projectId = document.getElementById('kdp-project').value;
            const project = appState.projects.find(p => p.id === projectId);
            
            if (!project) {
                document.getElementById('kdp-check-btn').disabled = true;
                return;
            }
            
            document.getElementById('kdp-check-btn').disabled = false;
            showNotification('Project loaded for KDP compliance check!', 'success');
        }

        async function runKDPComplianceCheck() {
            const projectId = document.getElementById('kdp-project').value;
            const project = appState.projects.find(p => p.id === projectId);
            
            if (!project) {
                showNotification('Please select a project first', 'warning');
                return;
            }
            
            const progressBar = document.getElementById('kdp-progress');
            const progressFill = document.getElementById('kdp-progress-fill');
            const checkBtn = document.getElementById('kdp-check-btn');
            
            checkBtn.disabled = true;
            progressBar.style.display = 'block';
            
            try {
                // Show progress
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 15;
                    if (progress > 90) progress = 90;
                    progressFill.style.width = progress + '%';
                }, 300);
                
                // Run compliance checks
                const results = await performKDPComplianceCheck(project);
                
                clearInterval(progressInterval);
                progressFill.style.width = '100%';
                
                setTimeout(() => {
                    displayComplianceResults(results);
                    progressBar.style.display = 'none';
                    checkBtn.disabled = false;
                    
                    if (results.hasIssues) {
                        document.getElementById('quick-fixes').style.display = 'block';
                    }
                }, 500);
                
            } catch (error) {
                clearInterval(progressInterval);
                progressBar.style.display = 'none';
                checkBtn.disabled = false;
                showNotification('Error running compliance check: ' + error.message, 'error');
            }
        }

        async function performKDPComplianceCheck(project) {
            // Simulate AI analysis of the project
            await sleep(2000);
            
            const checks = [];
            let passCount = 0;
            let totalChecks = 0;
            
            // Content Guidelines Check
            if (document.getElementById('check-content').checked) {
                const contentCheck = analyzeContent(project);
                checks.push(contentCheck);
                if (contentCheck.status === 'pass') passCount++;
                totalChecks++;
            }
            
            // Technical Requirements Check
            if (document.getElementById('check-technical').checked) {
                const technicalCheck = analyzeTechnicalRequirements(project);
                checks.push(technicalCheck);
                if (technicalCheck.status === 'pass') passCount++;
                totalChecks++;
            }
            
            // Format Specifications Check
            if (document.getElementById('check-format').checked) {
                const formatCheck = analyzeFormatSpecifications(project);
                checks.push(formatCheck);
                if (formatCheck.status === 'pass') passCount++;
                totalChecks++;
            }
            
            // Copyright & IP Check
            if (document.getElementById('check-copyright').checked) {
                const copyrightCheck = analyzeCopyrightCompliance(project);
                checks.push(copyrightCheck);
                if (copyrightCheck.status === 'pass') passCount++;
                totalChecks++;
            }
            
            // Quality Standards Check
            if (document.getElementById('check-quality').checked) {
                const qualityCheck = analyzeQualityStandards(project);
                checks.push(qualityCheck);
                if (qualityCheck.status === 'pass') passCount++;
                totalChecks++;
            }
            
            const score = Math.round((passCount / totalChecks) * 100);
            const hasIssues = checks.some(check => check.status !== 'pass');
            
            return {
                score,
                checks,
                hasIssues,
                project
            };
        }

        function analyzeContent(project) {
            const issues = [];
            const recommendations = [];
            
            // Check page count
            if (project.pages.length < 24) {
                issues.push(`Only ${project.pages.length} pages (minimum 24 required)`);
                recommendations.push('Add more coloring pages to reach the 24-page minimum');
            }
            
            // Check for appropriate content
            const storyPages = project.pages.filter(p => p.type === 'story');
            const coloringPages = project.pages.filter(p => p.type === 'coloring');
            
            if (coloringPages.length === 0) {
                issues.push('No coloring pages found');
                recommendations.push('Add coloring pages with clear, printable designs');
            }
            
            // Check age appropriateness
            const hasAgeInfo = project.metadata.targetAgeGroup;
            if (!hasAgeInfo) {
                issues.push('Target age group not specified');
                recommendations.push('Specify target age group in project metadata');
            }
            
            return {
                category: 'Content Guidelines',
                status: issues.length === 0 ? 'pass' : (issues.length <= 2 ? 'warning' : 'fail'),
                issues,
                recommendations,
                description: 'Content must be appropriate, original, and valuable for customers'
            };
        }

        function analyzeTechnicalRequirements(project) {
            const issues = [];
            const recommendations = [];
            
            // Check dimensions (simulated)
            const dims = project.metadata?.dimensions;
            if (!dims || dims.width < 5 || dims.height < 8) {
                issues.push('Page size below minimum (5" x 8")');
                recommendations.push('Use standard sizes: 6"x9", 7"x10", or 8.5"x11"');
            }
            
            if (dims && (dims.width > 8.5 || dims.height > 11)) {
                issues.push('Page size exceeds maximum (8.5" x 11")');
                recommendations.push('Reduce page size to maximum 8.5" x 11"');
            }
            
            // Check for margins
            issues.push('Interior margins should be at least 0.25" on all sides');
            recommendations.push('Set margins to 0.5" for optimal printing');
            
            return {
                category: 'Technical Requirements',
                status: issues.length <= 1 ? 'pass' : 'warning',
                issues,
                recommendations,
                description: 'File format, size, and technical specifications compliance'
            };
        }

        function analyzeFormatSpecifications(project) {
            const issues = [];
            const recommendations = [];
            
            // Resolution check (simulated)
            issues.push('Verify all images are 300 DPI for print quality');
            recommendations.push('Use the PDF export with "Print High Quality" setting');
            
            // Color mode check
            recommendations.push('Use CMYK color mode for professional printing');
            
            // Bleed check
            if (!document.getElementById('include-bleed')?.checked) {
                issues.push('No bleed area specified');
                recommendations.push('Add 0.125" bleed for professional printing');
            }
            
            return {
                category: 'Format Specifications',
                status: issues.length <= 1 ? 'warning' : 'fail',
                issues,
                recommendations,
                description: 'Print-ready format with proper resolution and color settings'
            };
        }

        function analyzeCopyrightCompliance(project) {
            const issues = [];
            const recommendations = [];
            
            // Check for potential copyright issues (basic text analysis)
            const storyContent = project.pages
                .filter(p => p.type === 'story')
                .map(p => p.content?.text || '')
                .join(' ').toLowerCase();
            
            const copyrightedTerms = [
                'disney', 'mickey mouse', 'pokemon', 'mario', 'superman', 'batman', 
                'spiderman', 'frozen', 'elsa', 'anna', 'harry potter', 'star wars'
            ];
            
            const foundTerms = copyrightedTerms.filter(term => storyContent.includes(term));
            
            if (foundTerms.length > 0) {
                issues.push(`Potential copyrighted content detected: ${foundTerms.join(', ')}`);
                recommendations.push('Remove or replace copyrighted characters with original content');
            }
            
            // General copyright advice
            recommendations.push('Ensure all content is original or properly licensed');
            recommendations.push('Avoid using trademarked characters or brand names');
            
            return {
                category: 'Copyright & Intellectual Property',
                status: foundTerms.length === 0 ? 'pass' : 'fail',
                issues,
                recommendations,
                description: 'Content must be original or properly licensed'
            };
        }

        function analyzeQualityStandards(project) {
            const issues = [];
            const recommendations = [];
            
            // Check content diversity
            const storyPages = project.pages.filter(p => p.type === 'story').length;
            const coloringPages = project.pages.filter(p => p.type === 'coloring').length;
            
            if (coloringPages < storyPages) {
                issues.push('More story pages than coloring pages');
                recommendations.push('Coloring books should focus primarily on coloring content');
            }
            
            // Check for blank pages
            const emptyPages = project.pages.filter(p => !p.content || Object.keys(p.content).length === 0);
            if (emptyPages.length > 0) {
                issues.push(`${emptyPages.length} empty pages detected`);
                recommendations.push('Remove blank pages or add content');
            }
            
            // Quality recommendations
            recommendations.push('Ensure consistent art style throughout the book');
            recommendations.push('Test print a sample page to verify line thickness');
            
            return {
                category: 'Quality Standards',
                status: issues.length === 0 ? 'pass' : 'warning',
                issues,
                recommendations,
                description: 'Professional quality and customer value standards'
            };
        }

        function displayComplianceResults(results) {
            const container = document.getElementById('compliance-results');
            const scoreContainer = document.getElementById('compliance-score');
            const scoreValue = document.getElementById('score-value');
            const scoreBar = document.getElementById('score-bar');
            
            // Show overall score
            scoreContainer.style.display = 'block';
            scoreValue.textContent = results.score + '%';
            scoreBar.style.width = results.score + '%';
            
            // Color code the score
            if (results.score >= 80) {
                scoreValue.className = 'text-2xl font-bold text-green-600';
                scoreBar.className = 'bg-green-600 h-2 rounded-full';
            } else if (results.score >= 60) {
                scoreValue.className = 'text-2xl font-bold text-yellow-600';
                scoreBar.className = 'bg-yellow-600 h-2 rounded-full';
            } else {
                scoreValue.className = 'text-2xl font-bold text-red-600';
                scoreBar.className = 'bg-red-600 h-2 rounded-full';
            }
            
            // Display detailed results
            container.innerHTML = results.checks.map(check => `
                <div class="compliance-check compliance-${check.status}">
                    <div class="flex items-start justify-between mb-2">
                        <h3 class="font-semibold">${check.category}</h3>
                        <span class="text-xs px-2 py-1 rounded ${
                            check.status === 'pass' ? 'bg-green-100 text-green-800' :
                            check.status === 'warning' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-red-100 text-red-800'
                        }">
                            ${check.status.toUpperCase()}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 mb-3">${check.description}</p>
                    
                    ${check.issues.length > 0 ? `
                        <div class="mb-3">
                            <h4 class="text-sm font-medium text-red-700 mb-1">Issues Found:</h4>
                            <ul class="text-sm text-red-600 list-disc list-inside space-y-1">
                                ${check.issues.map(issue => `<li>${issue}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${check.recommendations.length > 0 ? `
                        <div>
                            <h4 class="text-sm font-medium text-blue-700 mb-1">Recommendations:</h4>
                            <ul class="text-sm text-blue-600 list-disc list-inside space-y-1">
                                ${check.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `).join('');
            
            showNotification(`Compliance check complete! Score: ${results.score}%`, 
                results.score >= 80 ? 'success' : results.score >= 60 ? 'warning' : 'error');
        }

        // Quick fix functions
        function autoFixMargins() {
            // Set standard margins for KDP compliance
            const marginInputs = document.querySelectorAll('#margin-vertical, #margin-horizontal');
            marginInputs.forEach(input => {
                input.value = '0.5'; // Set to 0.5 inches
            });
            updateMarginDisplay();
            showNotification('Margins set to KDP-compliant 0.5 inches', 'success');
        }

        function autoFixResolution() {
            // Set high-quality print settings
            const qualitySelect = document.getElementById('pdf-quality');
            if (qualitySelect) {
                qualitySelect.value = 'print-high';
            }
            showNotification('Resolution set to 300 DPI for print quality', 'success');
        }

        function autoFixBleed() {
            // Enable bleed marks
            const bleedCheckbox = document.getElementById('include-bleed');
            if (bleedCheckbox) {
                bleedCheckbox.checked = true;
            }
            showNotification('Bleed marks enabled for professional printing', 'success');
        }

        // Story Generation Functions
        async function handleStoryGeneration(e) {
            e.preventDefault();
            console.log('Starting enhanced story generation...');
            
            if (!appState.apiKey) {
                showNotification('Please configure your API key first', 'warning');
                openApiModal();
                return;
            }
            
            const theme = document.getElementById('story-theme').value;
            const characters = document.getElementById('story-characters').value;
            const ageMin = document.getElementById('age-min').value;
            const ageMax = document.getElementById('age-max').value;
            const isAdult = document.getElementById('adult-audience').checked;
            const numPages = document.getElementById('story-pages').value;
            const wordsPerPage = document.getElementById('words-per-page').value;
            const imageStyle = document.getElementById('story-image-style').value;
            const lineWeight = document.getElementById('story-line-weight').value;
            const aspectRatio = document.getElementById('story-aspect-ratio').value;
            const moral = document.getElementById('story-moral').value;
            
            if (!theme || !characters) {
                showNotification('Please fill in theme and characters', 'warning');
                return;
            }
            
            const storyContainer = document.getElementById('generated-story');
            const progressBar = document.getElementById('story-progress');
            const progressFill = document.getElementById('story-progress-fill');
            
            // Show progress
            progressBar.style.display = 'block';
            storyContainer.innerHTML = '<div class="text-center">🤖 Generating story cards with image prompts...<br><small>Using ' + appState.aiModel + '</small></div>';
            
            // Simulate progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                progressFill.style.width = progress + '%';
            }, 300);
            
            try {
                const storyData = await generateStoryWithImagePrompts({
                    theme, characters, ageMin, ageMax, isAdult, numPages, wordsPerPage, 
                    imageStyle, lineWeight, aspectRatio, moral
                });
                
                clearInterval(progressInterval);
                progressFill.style.width = '100%';
                
                setTimeout(() => {
                    appState.currentStory = storyData;
                    displayStoryCards(storyData);
                    progressBar.style.display = 'none';
                    
                    // Enable buttons
                    document.querySelector('button[onclick="saveStory()"]').disabled = false;
                    document.querySelector('button[onclick="generateAllImages()"]').disabled = false;
                    document.querySelector('button[onclick="exportStoryCards()"]').disabled = false;
                    
                    showNotification(`Story with ${storyData.pages.length} pages generated! 🎉`, 'success');
                }, 500);
                
            } catch (error) {
                console.error('Story generation error:', error);
                clearInterval(progressInterval);
                progressBar.style.display = 'none';
                storyContainer.innerHTML = '<div class="text-center text-red-600">❌ Error generating story. Please try again.<br><small>' + error.message + '</small></div>';
                showNotification('Error generating story: ' + error.message, 'error');
            }
        }

        async function generateStoryWithImagePrompts({
            theme, characters, ageMin, ageMax, isAdult, numPages, wordsPerPage, 
            imageStyle, lineWeight, aspectRatio, moral
        }) {
            const ageGroup = isAdult ? 'adults' : `children aged ${ageMin}-${ageMax} years`;
            const totalWords = numPages * wordsPerPage;
            
            const aspectRatioMap = {
                'square': '1:1',
                'landscape': '4:3', 
                'portrait': '3:4',
                'wide': '16:9'
            };
            
            const lineWeightDesc = {
                1: 'very thin, delicate lines',
                2: 'thin lines', 
                3: 'light-medium lines',
                4: 'medium lines',
                5: 'medium-thick lines',
                6: 'thick lines',
                7: 'very thick lines',
                8: 'bold thick lines',
                9: 'extra bold lines',
                10: 'maximum thickness lines'
            };
            
            const prompt = `Create a ${numPages}-page children's coloring book story with accompanying image prompts. 

🎯 STORY SPECIFICATIONS:
- Target Audience: ${ageGroup}
- Theme: ${theme}
- Main Characters: ${characters}
- Total Pages: ${numPages}
- Words per Page: approximately ${wordsPerPage} words
- Total Story Length: approximately ${totalWords} words
- Moral/Lesson: ${moral || 'friendship and positive values'}

📝 STORY REQUIREMENTS:
- Write exactly ${numPages} pages
- Each page should be approximately ${wordsPerPage} words
- Use engaging, age-appropriate language for ${ageGroup}
- Each page should describe a scene perfect for illustration
- Include character development and interaction
- Build to the moral/lesson naturally
- Make each page complete but part of the larger story

🎨 IMAGE PROMPT REQUIREMENTS:
For each page, create a detailed image prompt for generating a perfect coloring page:
- Style: ${imageStyle} style
- Aspect ratio: ${aspectRatioMap[aspectRatio]}
- Line weight: ${lineWeightDesc[lineWeight]} (${lineWeight}/10)
- Black and white outlines only, suitable for coloring
- Clear, distinct areas for coloring
- Age-appropriate complexity for ${ageGroup}
- Include all characters and scene elements from the story text
- Specify "coloring book style", "black outlines", "no shading", "white background"

📋 OUTPUT FORMAT:
Structure your response EXACTLY like this:

PAGE 1:
STORY: [Write engaging story text for page 1 - approximately ${wordsPerPage} words describing the scene and action]

IMAGE_PROMPT: [Detailed prompt for AI image generation - specify: "${imageStyle} style coloring book illustration, ${aspectRatioMap[aspectRatio]} aspect ratio, ${lineWeightDesc[lineWeight]}, black and white outlines, no shading, white background, showing [describe the exact scene from the story with characters and setting], suitable for coloring, clear distinct areas"]

PAGE 2:
STORY: [Continue the story for page 2 - approximately ${wordsPerPage} words]

IMAGE_PROMPT: [Detailed image prompt for page 2 following same format]

[Continue for all ${numPages} pages...]

IMPORTANT: Each IMAGE_PROMPT must be detailed enough to generate a proper coloring page that matches the story content exactly.`;

            console.log('Sending story+image request to OpenRouter API...');

            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${appState.apiKey}`,
                    'HTTP-Referer': window.location.origin,
                    'X-Title': 'ColorBook Engine'
                },
                body: JSON.stringify({
                    model: appState.aiModel,
                    messages: [{
                        role: 'system',
                        content: 'You are a professional children\'s book author and illustrator who creates engaging stories paired with perfect coloring book image prompts. You always follow the exact format requested and create age-appropriate content that pairs perfectly with illustrations.'
                    }, {
                        role: 'user',
                        content: prompt
                    }],
                    temperature: 0.8,
                    max_tokens: Math.max(2000, numPages * 200)
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || `API request failed: ${response.status}`);
            }

            const data = await response.json();
            console.log('Received story+image data from API');
            
            return parseStoryWithImagePrompts(data.choices[0].message.content, {
                imageStyle, lineWeight, aspectRatio, numPages, wordsPerPage
            });
        }

        function parseStoryWithImagePrompts(content, params) {
            const pages = [];
            const pageMatches = content.match(/PAGE \d+:([\s\S]*?)(?=PAGE \d+:|$)/g);
            
            if (!pageMatches) {
                // Fallback parsing
                throw new Error('Failed to parse story format. Please try again.');
            }
            
            pageMatches.forEach((pageMatch, index) => {
                const storyMatch = pageMatch.match(/STORY:\s*([\s\S]*?)(?=IMAGE_PROMPT:|$)/);
                const imageMatch = pageMatch.match(/IMAGE_PROMPT:\s*([\s\S]*?)$/);
                
                const storyText = storyMatch ? storyMatch[1].trim() : `Page ${index + 1} story content`;
                const imagePrompt = imageMatch ? imageMatch[1].trim() : `${params.imageStyle} style coloring page for page ${index + 1}`;
                
                pages.push({
                    pageNumber: index + 1,
                    story: storyText,
                    imagePrompt: imagePrompt,
                    wordCount: storyText.split(' ').length,
                    imageGenerated: false,
                    imageData: null
                });
            });
            
            return {
                pages: pages,
                metadata: {
                    imageStyle: params.imageStyle,
                    lineWeight: params.lineWeight,
                    aspectRatio: params.aspectRatio,
                    totalPages: params.numPages,
                    targetWordsPerPage: params.wordsPerPage,
                    generatedAt: new Date().toISOString()
                }
            };
        }

        function displayStoryCards(storyData) {
            const container = document.getElementById('generated-story');
            
            const cardsHtml = storyData.pages.map((page, index) => `
                <div class="story-card bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-gray-200 rounded-xl p-6 mb-6 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <div class="bg-blue-600 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg">
                                ${page.pageNumber}
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-blue-800">Page ${page.pageNumber}</h3>
                                <p class="text-sm text-gray-600">${page.wordCount} words • ${appState.currentStory.metadata.imageStyle} style</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <span class="text-xs bg-blue-100 text-blue-600 px-3 py-1 rounded-full font-medium">${page.wordCount} words</span>
                            <button onclick="generateSingleImage(${page.pageNumber - 1})" class="text-xs bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2 rounded-full hover:from-purple-600 hover:to-pink-600 transition-all duration-200 transform hover:scale-105 font-medium shadow-md">
                                🎨 Generate Image
                            </button>
                        </div>
                                <!-- KDP Guidelines Reference -->
                <div class="mt-6 bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">📖 KDP Guidelines Reference</h2>
                    <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                        <div class="compliance-check">
                            <h3 class="font-semibold mb-2">📏 Size & Format</h3>
                            <ul class="text-sm space-y-1">
                                <li>• Minimum size: 5" x 8"</li>
                                <li>• Maximum size: 8.5" x 11"</li>
                                <li>• Bleed: 0.125" on all sides</li>
                                <li>• Spine calculation required</li>
                                <li>• PDF format only</li>
                            </ul>
                        </div>
                        
                        <div class="compliance-check">
                            <h3 class="font-semibold mb-2">🖼️ Image Quality</h3>
                            <ul class="text-sm space-y-1">
                                <li>• Resolution: 300 DPI minimum</li>
                                <li>• Color mode: CMYK for print</li>
                                <li>• No compression artifacts</li>
                                <li>• High contrast lines</li>
                                <li>• Clear, printable images</li>
                            </ul>
                        </div>
                        
                        <div class="compliance-check">
                            <h3 class="font-semibold mb-2">📝 Content Rules</h3>
                            <ul class="text-sm space-y-1">
                                <li>• No offensive content</li>
                                <li>• Age-appropriate material</li>
                                <li>• Original or licensed content</li>
                                <li>• No copyrighted characters</li>
                                <li>• Quality illustrations</li>
                            </ul>
                        </div>
                        
                        <div class="compliance-check">
                            <h3 class="font-semibold mb-2">📄 Page Requirements</h3>
                            <ul class="text-sm space-y-1">
                                <li>• Minimum 24 pages</li>
                                <li>• Interior margins: 0.25"</li>
                                <li>• Consistent page layout</li>
                                <li>• No blank pages</li>
                                <li>• Page numbering optional</li>
                            </ul>
                        </div>
                        
                        <div class="compliance-check">
                            <h3 class="font-semibold mb-2">⚖️ Legal Compliance</h3>
                            <ul class="text-sm space-y-1">
                                <li>• No trademark violations</li>
                                <li>• Public domain content OK</li>
                                <li>• Attribution if required</li>
                                <li>• No misleading content</li>
                                <li>• Age ratings accurate</li>
                            </ul>
                        </div>
                        
                        <div class="compliance-check">
                            <h3 class="font-semibold mb-2">📊 Quality Standards</h3>
                            <ul class="text-sm space-y-1">
                                <li>• Professional presentation</li>
                                <li>• Consistent art style</li>
                                <li>• Error-free content</li>
                                <li>• Readable text/lines</li>
                                <li>• Value for customers</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PDF Section -->
        <div id="pdf-section" class="section p-6" style="display: none;">
            <div class="max-w-6xl mx-auto">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">📄 Professional PDF Export</h1>
                
                <div class="grid gap-6 lg:grid-cols-2">
                    <!-- Export Settings -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Export Configuration</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Select Project</label>
                                <select id="pdf-project" class="w-full p-3 border border-gray-300 rounded-lg" onchange="loadProjectPages()">
                                    <option value="">Choose a project to export...</option>
                                </select>
                            </div>
                            
                            <!-- Page Size with Custom Dimensions -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Page Size</label>
                                <select id="page-size-pdf" class="w-full p-3 border border-gray-300 rounded-lg" onchange="updatePageDimensions()">
                                    <option value="letter">8.5" × 11" (Letter)</option>
                                    <option value="square-8.5">8.5" × 8.5" (Square)</option>
                                    <option value="square-9">9" × 9" (Large Square)</option>
                                    <option value="legal">8.5" × 14" (Legal)</option>
                                    <option value="a4">8.27" × 11.69" (A4)</option>
                                    <option value="a5">5.83" × 8.27" (A5)</option>
                                    <option value="tabloid">11" × 17" (Tabloid)</option>
                                    <option value="custom">Custom Size</option>
                                </select>
                            </div>
                            
                            <!-- Custom Dimensions (shown when custom is selected) -->
                            <div id="custom-dimensions" class="grid grid-cols-2 gap-4" style="display: none;">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Width (inches)</label>
                                    <input type="number" id="custom-width" step="0.1" min="3" max="24" value="8.5" class="w-full p-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Height (inches)</label>
                                    <input type="number" id="custom-height" step="0.1" min="3" max="24" value="8.5" class="w-full p-2 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                            
                            <!-- Margin Controls -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Margins (inches)</label>
                                <div class="grid grid-cols-2 gap-4 mb-2">
                                    <div>
                                        <label class="text-xs text-gray-600">Top/Bottom: <span id="margin-v-value">0.5</span>"</label>
                                        <input type="range" id="margin-vertical" min="0.25" max="2" step="0.125" value="0.5" class="w-full" oninput="updateMarginDisplay()">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-600">Left/Right: <span id="margin-h-value">0.5</span>"</label>
                                        <input type="range" id="margin-horizontal" min="0.25" max="2" step="0.125" value="0.5" class="w-full" oninput="updateMarginDisplay()">
                                    </div>
                                </div>
                                <div class="text-xs text-gray-500 bg-gray-50 p-2 rounded">
                                    Content area: <span id="content-area">7.5" × 10"</span>
                                </div>
                            </div>
                            
                            <!-- Print Quality -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Print Quality</label>
                                <select id="pdf-quality" class="w-full p-3 border border-gray-300 rounded-lg">
                                    <option value="print-high">Print High Quality (300 DPI)</option>
                                    <option value="print-standard">Print Standard (150 DPI)</option>
                                    <option value="web">Web Quality (72 DPI)</option>
                                    <option value="professional">Professional (600 DPI)</option>
                                </select>
                            </div>
                            
                            <!-- Image Handling -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Image Processing</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="flatten-images" class="rounded" checked>
                                        <span class="ml-2 text-sm">Flatten all layers and transparency</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="optimize-images" class="rounded" checked>
                                        <span class="ml-2 text-sm">Optimize images for print</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="stroke-enhance" class="rounded" checked>
                                        <span class="ml-2 text-sm">Enhance line strokes for coloring</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Professional Print Options -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Professional Options</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="include-bleed" class="rounded">
                                        <span class="ml-2 text-sm">Include bleed marks (0.125")</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="include-crop-marks" class="rounded">
                                        <span class="ml-2 text-sm">Include crop marks</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="include-color-bars" class="rounded">
                                        <span class="ml-2 text-sm">Include color registration bars</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Color Mode -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Color Profile</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="setColorMode('rgb')" class="color-mode-btn p-2 border border-gray-300 rounded hover:bg-gray-50 active">RGB (Digital)</button>
                                    <button onclick="setColorMode('cmyk')" class="color-mode-btn p-2 border border-gray-300 rounded hover:bg-gray-50">CMYK (Print)</button>
                                </div>
                            </div>
                            
                            <!-- Content Options -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Include Options</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="include-cover" class="rounded" checked>
                                        <span class="ml-2 text-sm">Cover page with title</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="include-toc" class="rounded" checked>
                                        <span class="ml-2 text-sm">Table of contents</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="include-page-numbers" class="rounded" checked>
                                        <span class="ml-2 text-sm">Page numbers</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="include-instructions" class="rounded">
                                        <span class="ml-2 text-sm">Coloring instructions page</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="double-sided" class="rounded">
                                        <span class="ml-2 text-sm">Double-sided layout (book format)</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Page Range -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Page Range</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" id="start-page" placeholder="Start" class="p-2 border border-gray-300 rounded" value="1">
                                    <input type="number" id="end-page" placeholder="End" class="p-2 border border-gray-300 rounded">
                                </div>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div id="pdf-progress" class="progress-bar" style="display: none;">
                                <div id="pdf-progress-fill" class="progress-fill"></div>
                            </div>
                            
                            <!-- Generate Button -->
                            <button onclick="generateProfessionalPDF()" id="generate-pdf-btn" class="w-full bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition-colors font-semibold" disabled>
                                📥 Generate Professional PDF
                            </button>
                        </div>
                    </div>
                    
                    <!-- Preview Panel -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Print Preview</h2>
                        
                        <!-- Page Preview -->
                        <div id="pdf-preview" class="bg-gray-100 rounded-lg p-4 mb-4 flex items-center justify-center border-2 border-dashed border-gray-300" style="aspect-ratio: 8.5/11;">
                            <div id="preview-content" class="bg-white shadow-lg rounded" style="width: 85%; height: 90%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                <div class="text-center text-gray-500">
                                    📄 Select a project to preview layout
                                    <p class="text-sm mt-2">Margins and content area will be shown</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Page List -->
                        <div id="page-list" class="space-y-2 max-h-60 overflow-y-auto" style="display: none;">
                            <!-- Pages will be listed here -->
                        </div>
                        
                        <!-- Quick Export Options -->
                        <div class="mt-4 space-y-2">
                            <button onclick="quickExportSquare()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 text-sm">
                                🚀 Quick Export: 8.5" × 8.5" Square
                            </button>
                            <button onclick="quickExportLetter()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 text-sm">
                                📄 Quick Export: 8.5" × 11" Letter
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Export Statistics -->
                <div class="mt-6 bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Export Statistics & File Info</h2>
                    <div class="grid gap-4 md:grid-cols-5">
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600" id="total-pages">0</div>
                            <div class="text-sm text-gray-600">Total Pages</div>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="text-2xl font-bold text-green-600" id="story-pages">0</div>
                            <div class="text-sm text-gray-600">Story Pages</div>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg">
                            <div class="text-2xl font-bold text-purple-600" id="coloring-pages">0</div>
                            <div class="text-sm text-gray-600">Coloring Pages</div>
                        </div>
                        <div class="text-center p-4 bg-yellow-50 rounded-lg">
                            <div class="text-2xl font-bold text-yellow-600" id="estimated-size">0 MB</div>
                            <div class="text-sm text-gray-600">Est. File Size</div>
                        </div>
                        <div class="text-center p-4 bg-red-50 rounded-lg">
                            <div class="text-2xl font-bold text-red-600" id="print-cost">$0.00</div>
                            <div class="text-sm text-gray-600">Est. Print Cost</div>
                        </div>
                    </div>
                    
                    <!-- File Specifications -->
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-800 mb-2">Document Specifications</h3>
                            <div class="text-sm space-y-1">
                                <div>Page Size: <span id="spec-page-size">8.5" × 11"</span></div>
                                <div>Margins: <span id="spec-margins">0.5" all sides</span></div>
                                <div>Content Area: <span id="spec-content-area">7.5" × 10"</span></div>
                                <div>Resolution: <span id="spec-resolution">300 DPI</span></div>
                                <div>Color Profile: <span id="spec-color-profile">RGB</span></div>
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-800 mb-2">Print Recommendations</h3>
                            <div class="text-sm space-y-1">
                                <div>Paper: Heavy cardstock (110lb+)</div>
                                <div>Binding: Perfect bound or spiral</div>
                                <div>Finish: Matte or satin</div>
                                <div>Printer: Laser or high-quality inkjet</div>
                                <div>Bleed: <span id="spec-bleed">None</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global app state - Initialize immediately
        const appState = {
            currentProject: null,
            projects: JSON.parse(localStorage.getItem('colorbook-projects') || '[]'),
            currentStory: '',
            canvas: null,
            ctx: null,
            isDrawing: false,
            currentColor: '#000000',
            brushSize: 5,
            opacity: 100,
            drawingMode: 'draw',
            history: [],
            historyStep: -1,
            apiKey: localStorage.getItem('openrouter-api-key') || '',
            aiModel: localStorage.getItem('ai-model') || 'google/gemma-2-9b-it:free',
            imageService: localStorage.getItem('image-service') || 'none',
            imageApiKey: localStorage.getItem('image-api-key') || '',
            imageModel: localStorage.getItem('image-model') || 'dall-e-3',
            currentOrientation: 'portrait',
            currentColorMode: 'rgb',
            lastGeneratedImage: null,
            lastConvertedImage: null
        };

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing ColorBook Engine...');
            
            // Load saved image API settings
            appState.imageService = localStorage.getItem('image-service') || 'none';
            appState.imageApiKey = localStorage.getItem('image-api-key') || '';
            appState.imageModel = localStorage.getItem('image-model') || 'dall-e-3';
            
            // Initialize components
            initializeCanvas();
            initializeColorPalette();
            loadProjects();
            showSection('dashboard');
            updateApiStatus();
            
            // Event listeners
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);
            document.getElementById('story-form').addEventListener('submit', handleStoryGeneration);
            document.getElementById('image-form').addEventListener('submit', handleImageGeneration);
            
            // PDF section event listeners
            ['custom-width', 'custom-height'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', () => {
                        updateContentArea();
                        updatePreviewLayout();
                        updateSpecifications();
                    });
                }
            });
            
            // Drag and drop setup
            setupDragAndDrop();
            setupPhotoUpload();
            
            console.log('ColorBook Engine initialized successfully!');
        });

        // Notification System
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notification-icon');
            const messageEl = document.getElementById('notification-message');
            
            const icons = {
                success: '✅',
                error: '❌',
                info: 'ℹ️',
                warning: '⚠️'
            };
            
            icon.textContent = icons[type] || icons.info;
            messageEl.textContent = message;
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // API Configuration Functions
        function openApiModal() {
            document.getElementById('api-modal').classList.remove('hidden');
            document.getElementById('openrouter-key').value = appState.apiKey;
            document.getElementById('ai-model').value = appState.aiModel;
            document.getElementById('image-service').value = appState.imageService;
            document.getElementById('image-api-key').value = appState.imageApiKey;
            document.getElementById('image-model').value = appState.imageModel;
            toggleImageApiFields();
        }

        function toggleImageApiFields() {
            const service = document.getElementById('image-service').value;
            const fields = document.getElementById('image-api-fields');
            fields.style.display = service === 'none' ? 'none' : 'block';
            
            // Update model options based on service
            const modelSelect = document.getElementById('image-model');
            modelSelect.innerHTML = '';
            
            const modelOptions = {
                'openai': [
                    { value: 'dall-e-3', text: 'DALL-E 3 (Latest)' },
                    { value: 'dall-e-2', text: 'DALL-E 2' }
                ],
                'stabilityai': [
                    { value: 'stable-diffusion-xl-1024-v1-0', text: 'Stable Diffusion XL' },
                    { value: 'stable-diffusion-v1-6', text: 'Stable Diffusion v1.6' }
                ],
                'replicate': [
                    { value: 'stability-ai/sdxl', text: 'SDXL via Replicate' },
                    { value: 'lucataco/animate-diff', text: 'AnimateDiff' }
                ],
                'midjourney': [
                    { value: 'midjourney-v6', text: 'Midjourney v6' },
                    { value: 'midjourney-v5', text: 'Midjourney v5' }
                ]
            };
            
            if (modelOptions[service]) {
                modelOptions[service].forEach(option => {
                    const optionEl = document.createElement('option');
                    optionEl.value = option.value;
                    optionEl.textContent = option.text;
                    modelSelect.appendChild(optionEl);
                });
            }
        }

        async function saveApiConfig() {
            const apiKey = document.getElementById('openrouter-key').value;
            const model = document.getElementById('ai-model').value;
            const imageService = document.getElementById('image-service').value;
            const imageApiKey = document.getElementById('image-api-key').value;
            const imageModel = document.getElementById('image-model').value;
            
            if (!apiKey.trim()) {
                showNotification('Please enter your OpenRouter API key for text generation', 'warning');
                return;
            }
            
            appState.apiKey = apiKey;
            appState.aiModel = model;
            appState.imageService = imageService;
            appState.imageApiKey = imageApiKey;
            appState.imageModel = imageModel;
            
            localStorage.setItem('openrouter-api-key', apiKey);
            localStorage.setItem('ai-model', model);
            localStorage.setItem('image-service', imageService);
            localStorage.setItem('image-api-key', imageApiKey);
            localStorage.setItem('image-model', imageModel);
            
            // Test the text API connection
            try {
                showNotification('Testing API connections...', 'info');
                
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'ColorBook Engine'
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: 'user', content: 'Hello' }],
                        max_tokens: 10
                    })
                });

                if (response.ok) {
                    updateApiStatus();
                    closeApiModal();
                    
                    let message = 'Text generation API configured successfully! 🎉';
                    if (imageService !== 'none') {
                        message += ' Image generation is also configured.';
                    } else {
                        message += ' Using advanced placeholder generation for images.';
                    }
                    showNotification(message, 'success');
                } else {
                    const error = await response.json();
                    showNotification(`Text API Error: ${error.error?.message || 'Invalid configuration'}`, 'error');
                }
            } catch (error) {
                showNotification('Failed to test text API connection. Please check your key.', 'error');
            }
        }

        function updateApiStatus() {
            const status = document.getElementById('api-status');
            if (appState.apiKey) {
                const modelName = appState.aiModel.split('/').pop().split(':')[0];
                const isFree = appState.aiModel.includes(':free');
                const imageStatus = appState.imageService !== 'none' ? ' + Images' : '';
                status.innerHTML = `Configured ✅ <span class="model-badge ${isFree ? 'model-free' : 'model-paid'}">${modelName.toUpperCase()}</span>${imageStatus}`;
                status.className = 'text-green-600 font-medium';
            } else {
                status.textContent = 'Not Configured';
                status.className = 'text-red-600 font-medium';
            }
        }

        function closeApiModal() {
            document.getElementById('api-modal').classList.add('hidden');
        }

        // Navigation
        function showSection(sectionName) {
            console.log('Showing section:', sectionName);
            
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.style.display = 'block';
                setTimeout(() => {
                    targetSection.classList.add('active', 'fade-in');
                }, 10);
            }
            
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-blue-100', 'text-blue-800');
            });
            
            const activeBtn = document.querySelector(`[data-section="${sectionName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('bg-blue-100', 'text-blue-800');
            }
            
            closeMobileMenu();
            
            // Section-specific initializations
            if (sectionName === 'pdf') {
                initializePDFSection();
            } else if (sectionName === 'kdp') {
                initializeKDPSection();
            }
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('-translate-x-full');
        }

        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.add('-translate-x-full');
        }

        // Project Management
        function createNewProject() {
            const title = prompt('Enter project title:');
            if (!title) return;
            
            const description = prompt('Enter project description (optional):') || '';
            
            const project = {
                id: generateId(),
                title: title,
                description: description,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                pages: [],
                metadata: {
                    author: 'Creator',
                    targetAgeGroup: '6-8',
                    dimensions: { width: 8.5, height: 11, unit: 'in' },
                    bindingType: 'perfect',
                    tags: []
                }
                                    <div class="p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition-colors" onclick="loadStoryTemplate('adventure')">
                            <h3 class="font-medium mb-2">🗺️ Adventure Quest</h3>
                            <p class="text-sm text-gray-600">Heroes on a journey to save their homeland</p>
                            <span class="difficulty-badge difficulty-medium mt-2">Medium</span>
                        </div>
                        <div class="p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition-colors" onclick="loadStoryTemplate('friendship')">
                            <h3 class="font-medium mb-2">🤝 Friendship Tale</h3>
                            <p class="text-sm text-gray-600">Animals learning to work together</p>
                            <span class="difficulty-badge difficulty-easy mt-2">Easy</span>
                        </div>
                        <div class="p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition-colors" onclick="loadStoryTemplate('fantasy')">
                            <h3 class="font-medium mb-2">🐉 Fantasy World</h3>
                            <p class="text-sm text-gray-600">Magical creatures and enchanted lands</p>
                            <span class="difficulty-badge difficulty-hard mt-2">Advanced</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Images Section -->
        <div id="images-section" class="section p-6" style="display: none;">
            <div class="max-w-6xl mx-auto">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">🖼️ AI Image Generation</h1>
                
                <div class="grid gap-6 lg:grid-cols-2">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Image Generation Parameters</h2>
                        <form id="image-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Detailed Prompt</label>
                                <textarea id="image-prompt" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent h-24" placeholder="A friendly cartoon rabbit sitting in a magical garden, surrounded by large colorful flowers and butterflies, black outline style for coloring book, simple lines, no shading"></textarea>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Art Style</label>
                                    <select id="image-style" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="coloring-book">Coloring Book</option>
                                        <option value="cartoon">Cartoon</option>
                                        <option value="realistic">Realistic</option>
                                        <option value="manga">Manga/Anime</option>
                                        <option value="simple">Simple/Minimalist</option>
                                        <option value="detailed">Detailed/Complex</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Target Age</label>
                                    <select id="image-age-target" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="preschool">Preschool (3-5)</option>
                                        <option value="elementary">Elementary (6-8)</option>
                                        <option value="tween">Tween (9-12)</option>
                                        <option value="teen">Teen (13+)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Line Weight: <span id="line-weight-value">5</span></label>
                                <input type="range" id="line-weight" min="1" max="10" value="5" class="w-full" oninput="document.getElementById('line-weight-value').textContent = this.value">
                                <div class="text-xs text-gray-500 flex justify-between mt-1">
                                    <span>Thin</span><span>Thick</span>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Complexity: <span id="complexity-value">5</span></label>
                                <input type="range" id="complexity" min="1" max="10" value="5" class="w-full" oninput="document.getElementById('complexity-value').textContent = this.value">
                                <div class="text-xs text-gray-500 flex justify-between mt-1">
                                    <span>Simple</span><span>Complex</span>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Characters to Include</label>
                                <input type="text" id="image-characters" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Based on current story characters (optional)">
                            </div>
                            
                            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                                ✨ Generate Coloring Page
                            </button>
                        </form>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Generated Image</h2>
                        <div id="image-progress" class="progress-bar mb-4" style="display: none;">
                            <div id="image-progress-fill" class="progress-fill"></div>
                        </div>
                        <div id="generated-image-container" class="bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 aspect-square flex items-center justify-center text-gray-500 mb-4">
                            <div class="text-center">
                                🖼️ Generated coloring page will appear here
                                <p class="text-sm mt-2">Note: Currently using placeholder image generation</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="downloadGeneratedImage()" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors" disabled>
                                📥 Download
                            </button>
                            <button onclick="saveToProject()" class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors" disabled>
                                💾 Save to Project
                            </button>
                            <button onclick="editInCanvas()" class="flex-1 bg-yellow-600 text-white py-2 rounded-lg hover:bg-yellow-700 transition-colors" disabled>
                                ✏️ Edit
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Photo Converter Section -->
        <div id="convert-section" class="section p-6" style="display: none;">
            <div class="max-w-6xl mx-auto">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">🔄 Photo to Coloring Page Converter</h1>
                
                <div class="grid gap-6 lg:grid-cols-2">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Upload Photo</h2>
                        
                        <div id="photo-upload-zone" class="drag-drop-zone mb-4">
                            <input type="file" id="photo-input" accept="image/*" class="hidden" onchange="handlePhotoUpload(event)">
                            <div class="text-center">
                                ☁️ Drop your photo here
                                <p class="text-gray-500 mb-4">or click to browse</p>
                                <button onclick="document.getElementById('photo-input').click()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                    Choose File
                                </button>
                            </div>
                        </div>
                        
                        <div id="photo-preview-container" class="hidden mb-4" style="display: none;">
                            <img id="photo-preview" class="image-preview mx-auto">
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Conversion Style</label>
                                <select id="conversion-style" class="w-full p-3 border border-gray-300 rounded-lg">
                                    <option value="edge-detection">Edge Detection (Canny)</option>
                                    <option value="kmeans-cluster">K-Means Clustering</option>
                                    <option value="gaussian-blur">Gaussian Blur + Edges</option>
                                    <option value="pencil-sketch">Pencil Sketch</option>
                                    <option value="cartoon">Cartoon Style</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Colors: <span id="color-count-value">8</span></label>
                                    <input type="range" id="color-count" min="3" max="20" value="8" class="w-full" oninput="document.getElementById('color-count-value').textContent = this.value">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Detail Level: <span id="detail-level-value">5</span></label>
                                    <input type="range" id="detail-level" min="1" max="10" value="5" class="w-full" oninput="document.getElementById('detail-level-value').textContent = this.value">
                                </div>
                            </div>
                            
                            <button onclick="convertPhoto()" id="convert-btn" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-colors" disabled>
                                🔄 Convert to Coloring Page
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Converted Result</h2>
                        <div id="conversion-progress" class="progress-bar mb-4" style="display: none;">
                            <div id="conversion-progress-fill" class="progress-fill"></div>
                        </div>
                        <div id="converted-result" class="bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 aspect-square flex items-center justify-center text-gray-500 mb-4">
                            <div class="text-center">
                                🖼️ Converted coloring page will appear here
                            </div>
                        </div>
                        
                        <div id="color-palette-result" class="hidden mb-4" style="display: none;">
                            <h3 class="text-sm font-medium text-gray-700 mb-2">Extracted Color Palette</h3>
                            <div id="palette-colors" class="flex gap-2 flex-wrap"></div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="downloadConverted()" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors" disabled>
                                📥 Download
                            </button>
                            <button onclick="saveConvertedToProject()" class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors" disabled>
                                💾 Save to Project
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Canvas Section -->
        <div id="canvas-section" class="section p-6" style="display: none;">
            <div class="max-w-7xl mx-auto">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">🖌️ Professional Drawing Canvas</h1>
                
                <div class="grid gap-6 lg:grid-cols-4">
                    <div class="bg-white rounded-lg shadow-md p-4">
                        <h3 class="font-semibold mb-4">Drawing Tools</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mode</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="setDrawingMode('draw')" class="mode-btn bg-blue-100 text-blue-800 p-2 rounded text-sm font-medium active">
                                        🖌️ Draw
                                    </button>
                                    <button onclick="setDrawingMode('erase')" class="mode-btn bg-red-100 text-red-800 p-2 rounded text-sm font-medium">
                                        🧽 Erase
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Colors</label>
                                <div id="color-palette" class="grid grid-cols-6 gap-1 mb-2"></div>
                                <input type="color" id="custom-color" class="w-full h-8 rounded border" value="#000000" onchange="selectCustomColor(this.value)">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Brush Size: <span id="brush-size-value">5</span></label>
                                <input type="range" id="brush-size" min="1" max="50" value="5" class="w-full" oninput="updateBrushSize(this.value)">
                                <div id="brush-preview" class="bg-black rounded-full mx-auto mt-2" style="width: 5px; height: 5px;"></div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Opacity: <span id="opacity-value">100</span>%</label>
                                <input type="range" id="opacity-slider" min="10" max="100" value="100" class="w-full" oninput="updateOpacity(this.value)">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Templates</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="template-preview" onclick="loadTemplate('butterfly')">🦋</div>
                                    <div class="template-preview" onclick="loadTemplate('flower')">🌸</div>
                                    <div class="template-preview" onclick="loadTemplate('star')">⭐</div>
                                    <div class="template-preview" onclick="loadTemplate('heart')">❤️</div>
                                    <div class="template-preview" onclick="loadTemplate('tree')">🌳</div>
                                    <div class="template-preview" onclick="loadTemplate('house')">🏠</div>
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <button onclick="undoDrawing()" class="w-full bg-yellow-600 text-white py-2 rounded hover:bg-yellow-700 transition-colors">
                                    ↶ Undo
                                </button>
                                <button onclick="redoDrawing()" class="w-full bg-orange-600 text-white py-2 rounded hover:bg-orange-700 transition-colors">
                                    ↷ Redo
                                </button>
                                <button onclick="clearCanvas()" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700 transition-colors">
                                    🗑️ Clear
                                </button>
                                <button onclick="saveCanvas()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 transition-colors">
                                    💾 Save
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="lg:col-span-3 bg-white rounded-lg shadow-md p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Canvas</h3>
                            <div class="flex gap-2">
                                <button onclick="toggleGrid()" class="px-3 py-1 bg-gray-100 text-gray-700 rounded text-sm hover:bg-gray-200">
                                    📏 Grid
                                </button>
                                <button onclick="fullscreen()" class="px-3 py-1 bg-gray-100 text-gray-700 rounded text-sm hover:bg-gray-200">
                                    ⛶ Fullscreen
                                </button>
                            </div>
                        </div>
                        <div class="canvas-container">
                            <canvas id="drawingCanvas" width="800" height="600" class="max-w-full h-auto"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Layout Section -->
        <div id="layout-section" class="section p-6" style="display: none;">
            <div class="max-w-6xl mx-auto">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">📐 Layout Designer</h1>
                
                <div class="grid gap-6 lg:grid-cols-3">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Page Settings</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Page Size</label>
                                <select id="page-size" class="w-full p-3 border border-gray-300 rounded-lg" onchange="updatePageLayout()">
                                    <option value="letter">8.5" x 11" (Letter)</option>
                                    <option value="legal">8.5" x 14" (Legal)</option>
                                    <option value="a4">8.27" x 11.69" (A4)</option>
                                    <option value="a5">5.83" x 8.27" (A5)</option>
                                    <option value="custom">Custom Size</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Orientation</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="setOrientation('portrait')" class="p-2 border border-gray-300 rounded hover:bg-gray-50 orientation-btn active">Portrait</button>
                                    <button onclick="setOrientation('landscape')" class="p-2 border border-gray-300 rounded hover:bg-gray-50 orientation-btn">Landscape</button>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Margins: <span id="margin-value">1</span>"</label>
                                <input type="range" id="margin-slider" min="0.25" max="2" step="0.25" value="1" class="w-full" oninput="updateMargins(this.value)">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Binding</label>
                                <select id="binding-type" class="w-full p-3 border border-gray-300 rounded-lg">
                                    <option value="perfect">Perfect Binding</option>
                                    <option value="spiral">Spiral Binding</option>
                                    <option value="saddle">Saddle Stitch</option>
                                    <option value="hardcover">Hardcover</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="lg:col-span-2 bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Page Layout Preview</h2>
                        <div id="layout-preview" class="bg-gray-100 rounded-lg p-8 aspect-[8.5/11] flex items-center justify-center border-2 border-dashed border-gray-300 relative">
                            <div id="layout-content" class="w-full h-full relative bg-white shadow-sm">
                                <div class="absolute inset-4 border border-gray-300 rounded">
                                    <div class="w-full h-full flex items-center justify-center text-gray-500">
                                        <div class="text-center">
                                            📐 Drag elements here to design your page
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Layout Elements</h2>
                    <div class="grid gap-4 md:grid-cols-6">
                        <div class="element-tool border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors" draggable="true" data-element="image">
                            🖼️<p class="text-sm font-medium mt-2">Coloring Image</p>
                        </div>
                        <div class="element-tool border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors" draggable="true" data-element="text">
                            📝<p class="text-sm font-medium mt-2">Text Block</p>
                        </div>
                        <div class="element-tool border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors" draggable="true" data-element="border">
                            ⬜<p class="text-sm font-medium mt-2">Border/Frame</p>
                        </div>
                        <div class="element-tool border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors" draggable="true" data-element="page-number">
                            #<p class="text-sm font-medium mt-2">Page Number</p>
                        </div>
                        <div class="element-tool border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors" draggable="true" data-element="title">
                            📋<p class="text-sm font-medium mt-2">Title/Header</p>
                        </div>
                        <div class="element-tool border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors" draggable="true" data-element="decoration">
                            ✨<p class="text-sm font-medium mt-2">Decoration</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- KDP Compliance Section -->
        <div id="kdp-section" class="section p-6" style="display: none;">
            <div class="max-w-6xl mx-auto">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">✅ Amazon KDP Compliance Checker</h1>
                
                <div class="grid gap-6 lg:grid-cols-2">
                    <!-- Compliance Check Panel -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Project Compliance Check</h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Select Project to Check</label>
                                <select id="kdp-project" class="w-full p-3 border border-gray-300 rounded-lg" onchange="loadKDPProjectCheck()">
                                    <option value="">Choose a project to analyze...</option>
                                </select>
                            </div>
                            
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" id="check-content" class="rounded" checked>
                                    <span class="ml-2 text-sm">Content Guidelines</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="check-technical" class="rounded" checked>
                                    <span class="ml-2 text-sm">Technical Requirements</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="check-format" class="rounded" checked>
                                    <span class="ml-2 text-sm">Format Specifications</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="check-copyright" class="rounded" checked>
                                    <span class="ml-2 text-sm">Copyright & IP</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="check-quality" class="rounded" checked>
                                    <span class="ml-2 text-sm">Quality Standards</span>
                                </label>
                            </div>
                            
                            <div id="kdp-progress" class="progress-bar" style="display: none;">
                                <div id="kdp-progress-fill" class="progress-fill"></div>
                            </div>
                            
                            <button onclick="runKDPComplianceCheck()" id="kdp-check-btn" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors" disabled>
                                🔍 Run Compliance Check
                            </button>
                        </div>
                        
                        <!-- Quick Fix Actions -->
                        <div id="quick-fixes" class="mt-6 space-y-2" style="display: none;">
                            <h3 class="font-semibold text-gray-800">Quick Fixes</h3>
                            <button onclick="autoFixMargins()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 text-sm">
                                📏 Auto-Fix Margins
                            </button>
                            <button onclick="autoFixResolution()" class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700 text-sm">
                                🖼️ Optimize Resolution
                            </button>
                            <button onclick="autoFixBleed()" class="w-full bg-yellow-600 text-white py-2 rounded hover:bg-yellow-700 text-sm">
                                ✂️ Add Bleed Areas
                            </button>
                        </div>
                    </div>
                    
                    <!-- Results Panel -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Compliance Results</h2>
                        
                        <div id="compliance-results" class="space-y-4">
                            <div class="text-center text-gray-500 py-8">
                                📋 Select a project and run compliance check to see results
                            </div>
                        </div>
                        
                        <!-- Overall Score -->
                        <div id="compliance-score" class="mt-6 p-4 bg-gray-50 rounded-lg" style="display: none;">
                            <div class="flex items-center justify-between">
                                <span class="font-semibold">Overall Compliance Score</span>
                                <span id="score-value" class="text-2xl font-bold text-green-600">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                <div id="score-bar" class="bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- KDP Guidelines Reference -->
                <div class="mt-6 bg-white rounded-lg shadow-md p-6">
                    <h2<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ColorBook Engine - Professional Creator Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        
        .sidebar-scrollbar::-webkit-scrollbar { width: 4px; }
        .sidebar-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .sidebar-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .canvas-container { position: relative; display: inline-block; }
        #drawingCanvas { border: 2px solid #e2e8f0; border-radius: 8px; cursor: crosshair; background: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        
        .tool-btn { transition: all 0.2s ease; }
        .tool-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        
        .color-swatch { transition: all 0.2s ease; }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch.active { transform: scale(1.2); box-shadow: 0 0 0 3px #3b82f6; }
        
        .template-preview { aspect-ratio: 1; border: 2px solid #e2e8f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 2rem; cursor: pointer; transition: all 0.2s ease; }
        .template-preview:hover { border-color: #3b82f6; background-color: #eff6ff; }
        
        .loading-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .drag-drop-zone { border: 2px dashed #cbd5e1; border-radius: 8px; padding: 2rem; text-align: center; transition: all 0.3s ease; }
        .drag-drop-zone.drag-over { border-color: #3b82f6; background-color: #eff6ff; }
        
        .progress-bar { width: 100%; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: #3b82f6; transition: width 0.3s ease; }
        
        .notification { position: fixed; top: 1rem; right: 1rem; z-index: 1000; background: white; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); padding: 1rem; transform: translateX(100%); transition: transform 0.3s ease; }
        .notification.show { transform: translateX(0); }
        
        .difficulty-badge { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500; }
        .difficulty-easy { background: #dcfce7; color: #166534; }
        .difficulty-medium { background: #fef3c7; color: #92400e; }
        .difficulty-hard { background: #fee2e2; color: #991b1b; }
        
        .image-preview { max-width: 200px; max-height: 200px; object-fit: cover; border-radius: 8px; border: 2px solid #e5e7eb; }
        
        .api-config { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
        
        .palette-color { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.2s ease; }
        .palette-color:hover { transform: scale(1.1); }
        
        .model-badge { display: inline-block; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.625rem; font-weight: 500; margin-left: 0.25rem; }
        .model-free { background: #dcfce7; color: #166534; }
        .model-paid { background: #fef3c7; color: #92400e; }
        
        .compliance-check { border-left: 4px solid #3b82f6; background: #eff6ff; padding: 1rem; margin: 0.5rem 0; border-radius: 0 8px 8px 0; }
        .compliance-pass { border-left-color: #059669; background: #ecfdf5; }
        .compliance-warning { border-left-color: #d97706; background: #fffbeb; }
        .compliance-fail { border-left-color: #dc2626; background: #fef2f2; }
        
        /* Icon fallbacks */
        .icon-fallback { display: inline-block; width: 1rem; height: 1rem; text-align: center; line-height: 1rem; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Notification System -->
    <div id="notification" class="notification">
        <div class="flex items-center gap-2">
            <div id="notification-icon">ℹ️</div>
            <div id="notification-message"></div>
        </div>
    </div>

    <!-- API Configuration Modal -->
    <div id="api-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4">🤖 AI Configuration</h2>
            
            <!-- Text Generation Setup -->
            <div class="space-y-4 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">📝 Text Generation (OpenRouter)</h3>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">OpenRouter API Key</label>
                    <input type="password" id="openrouter-key" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="sk-or-v1-...">
                    <p class="text-sm text-gray-500 mt-1">Get your key at <a href="https://openrouter.ai/keys" target="_blank" class="text-blue-600">openrouter.ai/keys</a></p>
                    <p class="text-xs text-green-600 mt-1">💡 Many models are completely FREE to use!</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">AI Model</label>
                    <select id="ai-model" class="w-full p-3 border border-gray-300 rounded-lg">
                        <optgroup label="🆓 FREE Models (Recommended)">
                            <option value="google/gemma-2-9b-it:free">Gemma 2 9B (FREE) - Google</option>
                            <option value="meta-llama/llama-3.1-8b-instruct:free">Llama 3.1 8B (FREE) - Meta</option>
                            <option value="microsoft/phi-3-mini-128k-instruct:free">Phi-3 Mini (FREE) - Microsoft</option>
                            <option value="huggingfaceh4/zephyr-7b-beta:free">Zephyr 7B (FREE) - HuggingFace</option>
                            <option value="openchat/openchat-7b:free">OpenChat 7B (FREE)</option>
                            <option value="gryphe/mythomist-7b:free">Mythomist 7B (FREE)</option>
                        </optgroup>
                        <optgroup label="💰 Premium Models">
                            <option value="openai/gpt-4o">GPT-4O - OpenAI</option>
                            <option value="openai/gpt-4-turbo">GPT-4 Turbo - OpenAI</option>
                            <option value="anthropic/claude-3-5-sonnet">Claude 3.5 Sonnet - Anthropic</option>
                            <option value="google/gemini-pro-1.5">Gemini Pro 1.5 - Google</option>
                            <option value="meta-llama/llama-3.1-70b-instruct">Llama 3.1 70B - Meta</option>
                        </optgroup>
                    </select>
                </div>
            </div>
            
            <!-- Image Generation Setup -->
            <div class="space-y-4 mb-6 border-t pt-4">
                <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">🎨 Image Generation (Optional)</h3>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Image Generation Service</label>
                    <select id="image-service" class="w-full p-3 border border-gray-300 rounded-lg" onchange="toggleImageApiFields()">
                        <option value="none">None (Use Advanced Placeholders)</option>
                        <option value="openai">OpenAI DALL-E</option>
                        <option value="stabilityai">Stability AI</option>
                        <option value="midjourney">Midjourney (via API)</option>
                        <option value="replicate">Replicate</option>
                    </select>
                </div>
                <div id="image-api-fields" style="display: none;">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Image API Key</label>
                        <input type="password" id="image-api-key" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Enter your image API key">
                        <p class="text-sm text-gray-500 mt-1">Required for real image generation</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Model/Engine</label>
                        <select id="image-model" class="w-full p-3 border border-gray-300 rounded-lg">
                            <option value="dall-e-3">DALL-E 3 (OpenAI)</option>
                            <option value="dall-e-2">DALL-E 2 (OpenAI)</option>
                            <option value="stable-diffusion-xl">Stable Diffusion XL</option>
                            <option value="midjourney-v6">Midjourney v6</option>
                        </select>
                    </div>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p class="text-sm text-blue-700">
                        <strong>💡 Note:</strong> Image generation is optional. The app works great with advanced placeholder generation. 
                        Real AI image generation requires separate API access and costs.
                    </p>
                </div>
            </div>
            
            <div class="flex gap-2 mt-6">
                <button onclick="saveApiConfig()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Save & Test</button>
                <button onclick="closeApiModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div id="sidebar" class="fixed left-0 top-0 h-full w-64 bg-white shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out z-40 md:translate-x-0">
        <div class="p-6 border-b">
            <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                🎨 ColorBook Engine Pro
            </h1>
            <button onclick="openApiModal()" class="text-xs text-blue-600 hover:text-blue-800 mt-1">⚙️ Configure AI (FREE models available!)</button>
        </div>
        
        <nav class="p-4 sidebar-scrollbar overflow-y-auto h-full">
            <ul class="space-y-2">
                <li><button onclick="showSection('dashboard')" class="w-full text-left p-3 rounded-lg hover:bg-blue-50 transition-colors flex items-center gap-3 nav-btn" data-section="dashboard">🏠 Dashboard</button></li>
                <li><button onclick="showSection('projects')" class="w-full text-left p-3 rounded-lg hover:bg-blue-50 transition-colors flex items-center gap-3 nav-btn" data-section="projects">📁 Projects</button></li>
                <li><button onclick="showSection('story')" class="w-full text-left p-3 rounded-lg hover:bg-blue-50 transition-colors flex items-center gap-3 nav-btn" data-section="story">📖 AI Story Generator</button></li>
                <li><button onclick="showSection('images')" class="w-full text-left p-3 rounded-lg hover:bg-blue-50 transition-colors flex items-center gap-3 nav-btn" data-section="images">🖼️ AI Images</button></li>
                <li><button onclick="showSection('convert')" class="w-full text-left p-3 rounded-lg hover:bg-blue-50 transition-colors flex items-center gap-3 nav-btn" data-section="convert">🔄 Photo Converter</button></li>
                <li><button onclick="showSection('canvas')" class="w-full text-left p-3 rounded-lg hover:bg-blue-50 transition-colors flex items-center gap-3 nav-btn" data-section="canvas">🖌️ Drawing Canvas</button></li>
                <li><button onclick="showSection('layout')" class="w-full text-left p-3 rounded-lg hover:bg-blue-50 transition-colors flex items-center gap-3 nav-btn" data-section="layout">📐 Layout Designer</button></li>
                <li><button onclick="showSection('kdp')" class="w-full text-left p-3 rounded-lg hover:bg-blue-50 transition-colors flex items-center gap-3 nav-btn" data-section="kdp">✅ KDP Compliance</button></li>
                <li><button onclick="showSection('pdf')" class="w-full text-left p-3 rounded-lg hover:bg-blue-50 transition-colors flex items-center gap-3 nav-btn" data-section="pdf">📄 PDF Export</button></li>
            </ul>
        </nav>
    </div>

    <!-- Mobile menu button -->
    <button id="mobileMenuBtn" class="md:hidden fixed top-4 left-4 z-50 p-2 bg-white rounded-lg shadow-lg">
        ☰
    </button>

    <!-- Main Content -->
    <div class="md:ml-64 min-h-screen">
        <!-- Dashboard Section -->
        <div id="dashboard-section" class="section active p-6">
            <div class="max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Dashboard</h1>
                        <p class="text-gray-600 mt-1">Professional Coloring Book Creator Studio</p>
                    </div>
                    <button onclick="createNewProject()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                        ➕ New Project
                    </button>
                </div>

                <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3 mb-8">
                    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer" onclick="showSection('story')">
                        <div class="bg-blue-100 p-3 rounded-lg mb-4 w-fit">📖</div>
                        <h3 class="text-xl font-semibold mb-2">AI Story Generator</h3>
                        <p class="text-gray-600">Generate engaging stories with FREE AI models <span class="model-badge model-free">FREE</span></p>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer" onclick="showSection('images')">
                        <div class="bg-green-100 p-3 rounded-lg mb-4 w-fit">🖼️</div>
                        <h3 class="text-xl font-semibold mb-2">AI Image Generation</h3>
                        <p class="text-gray-600">Create custom coloring pages with AI prompting</p>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer" onclick="showSection('convert')">
                        <div class="bg-purple-100 p-3 rounded-lg mb-4 w-fit">🔄</div>
                        <h3 class="text-xl font-semibold mb-2">Photo Converter</h3>
                        <p class="text-gray-600">Convert photos to coloring pages using ML algorithms</p>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer" onclick="showSection('canvas')">
                        <div class="bg-yellow-100 p-3 rounded-lg mb-4 w-fit">🖌️</div>
                        <h3 class="text-xl font-semibold mb-2">Drawing Canvas</h3>
                        <p class="text-gray-600">Professional drawing tools with advanced features</p>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer" onclick="showSection('kdp')">
                        <div class="bg-green-100 p-3 rounded-lg mb-4 w-fit">✅</div>
                        <h3 class="text-xl font-semibold mb-2">KDP Compliance</h3>
                        <p class="text-gray-600">Check Amazon KDP publishing guidelines compliance</p>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer" onclick="showSection('pdf')">
                        <div class="bg-red-100 p-3 rounded-lg mb-4 w-fit">📄</div>
                        <h3 class="text-xl font-semibold mb-2">PDF Export</h3>
                        <p class="text-gray-600">Generate high-quality print-ready PDFs</p>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Recent Projects</h2>
                    <div id="recent-projects" class="space-y-4">
                        <p class="text-gray-500 text-center py-8">No recent projects. Create a new project to get started.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Projects Section -->
        <div id="projects-section" class="section p-6" style="display: none;">
            <div class="max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-900">Projects</h1>
                    <button onclick="createNewProject()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                        ➕ New Project
                    </button>
                </div>
                <div id="projects-grid" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3"></div>
            </div>
        </div>

        <!-- Story Section -->
        <div id="story-section" class="section p-6" style="display: none;">
            <div class="max-w-4xl mx-auto">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">🤖 AI Story Generator</h1>
                
                <div class="api-config" id="story-api-status">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">API Status: <span id="api-status">Not Configured</span></span>
                        <button onclick="openApiModal()" class="text-sm bg-blue-100 text-blue-600 px-3 py-1 rounded">Configure FREE AI</button>
                    </div>
                </div>
                
                <div class="grid gap-6 md:grid-cols-2 mb-8">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Story Parameters</h2>
                        <form id="story-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Theme/Setting</label>
                                <input type="text" id="story-theme" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., Magical forest adventure, Space exploration">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Main Characters</label>
                                <input type="text" id="story-characters" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., Brave rabbit named Luna, wise owl Professor Hoot">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Target Age Group</label>
                                <div class="flex gap-2 items-center">
                                    <input type="number" id="age-min" min="2" max="18" value="6" class="w-20 p-2 border border-gray-300 rounded-lg">
                                    <span class="text-gray-500">to</span>
                                    <input type="number" id="age-max" min="2" max="18" value="8" class="w-20 p-2 border border-gray-300 rounded-lg">
                                    <span class="text-gray-500">years, or</span>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="adult-audience" class="mr-2">
                                        <span class="text-sm">Adult</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Number of Pages</label>
                                    <input type="number" id="story-pages" min="1" max="50" value="5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Words per Page</label>
                                    <input type="number" id="words-per-page" min="10" max="500" value="80" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Image Style for Illustrations</label>
                                <select id="story-image-style" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="coloring-book">Coloring Book Style</option>
                                    <option value="cartoon">Cartoon</option>
                                    <option value="realistic">Realistic</option>
                                    <option value="manga">Manga/Anime</option>
                                    <option value="simple">Simple/Minimalist</option>
                                    <option value="detailed">Detailed/Complex</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Line Weight: <span id="story-line-weight-value">3</span></label>
                                    <input type="range" id="story-line-weight" min="1" max="10" value="3" class="w-full" oninput="document.getElementById('story-line-weight-value').textContent = this.value">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Aspect Ratio</label>
                                    <select id="story-aspect-ratio" class="w-full p-2 border border-gray-300 rounded-lg">
                                        <option value="square">Square (1:1)</option>
                                        <option value="landscape">Landscape (4:3)</option>
                                        <option value="portrait">Portrait (3:4)</option>
                                        <option value="wide">Wide (16:9)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Moral/Lesson (Optional)</label>
                                <input type="text" id="story-moral" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., Friendship, kindness, perseverance">
                            </div>
                            
                            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                                ✨ Generate Story + Image Prompts
                            </button>
                        </form>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Generated Story & Image Prompts</h2>
                        <div id="story-progress" class="progress-bar mb-4" style="display: none;">
                            <div id="story-progress-fill" class="progress-fill"></div>
                        </div>
                        <div id="generated-story" class="bg-gray-50 rounded-lg p-4 min-h-[300px] border-2 border-dashed border-gray-300 max-h-[400px] overflow-y-auto">
                            <div class="text-center text-gray-500 flex items-center justify-center h-full">
                                📖 Your AI-generated story cards will appear here
                                <p class="text-sm mt-2">Configure API and fill the form to generate</p>
                            </div>
                        </div>
                        <div class="mt-4 flex gap-2">
                            <button onclick="saveStory()" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors" disabled>
                                💾 Save Story
                            </button>
                            <button onclick="generateAllImages()" class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors" disabled>
                                🖼️ Generate All Images
                            </button>
                            <button onclick="exportStoryCards()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors" disabled>
                                📄 Export Cards
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Story Templates</h2>
                    <div class="grid gap-4 md:grid-cols-3">
                        <div class="p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition-colors" onclick="loadStoryTemplate('adventure')">
                            <h3 class="font-medium mb-2">🗺️ Adventure Quest</h + printCost;
            
            const pageList = document.getElementById('page-list');
            pageList.innerHTML = project.pages.map((page, index) => `
                <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg bg-gray-50 text-sm">
                    <div class="flex items-center gap-3">
                        <span class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold">
                            ${index + 1}
                        </span>
                        <div>
                            <div class="font-medium">${page.type === 'story' ? '📖 Story' : '🎨 Coloring'}</div>
                            <div class="text-xs text-gray-500">${formatDate(page.createdAt)}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-600">
                            ${page.type === 'story' ? `${page.content?.wordCount || 0} words` : 'Coloring page'}
                        </div>
                        ${page.content?.imageData ? '<span class="text-xs text-green-600">✅ Has image</span>' : '<span class="text-xs text-gray-400">📷 No image</span>'}
                    </div>
                </div>
            `).join('');
            pageList.style.display = 'block';
            
            updatePreviewWithProject(project);
            updateSpecifications();
            showNotification('Project loaded for PDF export!', 'success');
        }

        function updatePreviewWithProject(project) {
            const content = document.getElementById('preview-content');
            content.innerHTML = `
                <div class="p-4 h-full flex flex-col justify-center items-center text-center">
                    <h3 class="font-bold text-lg mb-2">${project.title}</h3>
                    <div class="text-sm text-gray-600 mb-4">
                        ${project.pages.length} pages • Professional layout
                    </div>
                    <div class="text-xs text-gray-500 space-y-1">
                        <div>📖 ${project.pages.filter(p => p.type === 'story').length} story pages</div>
                        <div>🎨 ${project.pages.filter(p => p.type === 'coloring').length} coloring pages</div>
                    </div>
                    <div class="mt-4 text-xs text-blue-600 bg-blue-50 px-3 py-1 rounded">
                        Print-ready layout with margins
                    </div>
                </div>
            `;
        }

        async function generateProfessionalPDF() {
            const projectId = document.getElementById('pdf-project').value;
            const project = appState.projects.find(p => p.id === projectId);
            
            if (!project) {
                showNotification('Please select a project first', 'warning');
                return;
            }
            
            const progressBar = document.getElementById('pdf-progress');
            const progressFill = document.getElementById('pdf-progress-fill');
            const generateBtn = document.getElementById('generate-pdf-btn');
            
            generateBtn.disabled = true;
            progressBar.style.display = 'block';
            
            try {
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('PDF library not loaded');
                }
                
                const { jsPDF } = window.jspdf;
                const dimensions = updateContentArea();
                
                const pdf = new jsPDF({
                    orientation: dimensions.pageWidth > dimensions.pageHeight ? 'landscape' : 'portrait',
                    unit: 'in',
                    format: [dimensions.pageWidth, dimensions.pageHeight],
                    compress: true
                });
                
                let progress = 0;
                const totalSteps = project.pages.length + 3; // Including cover, TOC, instructions
                
                // Generate cover page
                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(36);
                pdf.text(project.title, dimensions.pageWidth / 2, dimensions.marginV + 2, { align: 'center' });
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(18);
                pdf.text('A Creative Coloring Book', dimensions.pageWidth / 2, dimensions.marginV + 2.5, { align: 'center' });
                
                progress++;
                progressFill.style.width = (progress / totalSteps * 100) + '%';
                await sleep(100);
                
                // Generate project pages
                for (let i = 0; i < project.pages.length; i++) {
                    const page = project.pages[i];
                    pdf.addPage();
                    
                    if (page.type === 'story') {
                        pdf.setFont('helvetica', 'normal');
                        pdf.setFontSize(14);
                        const cleanText = page.content?.text?.replace(/<[^>]*>/g, '') || 'Story content';
                        const textLines = pdf.splitTextToSize(cleanText, dimensions.contentWidth);
                        
                        let textY = dimensions.marginV + 0.5;
                        textLines.forEach(line => {
                            if (textY < dimensions.pageHeight - dimensions.marginV - 0.5) {
                                pdf.text(line, dimensions.marginH, textY);
                                textY += 0.2;
                            }
                        });
                    } else {
                        pdf.setFont('helvetica', 'bold');
                        pdf.setFontSize(16);
                        pdf.text('Coloring Page', dimensions.pageWidth / 2, dimensions.marginV + 0.3, { align: 'center' });
                        
                        const imageAreaWidth = dimensions.contentWidth * 0.9;
                        const imageAreaHeight = dimensions.contentHeight * 0.8;
                        const imageX = dimensions.marginH + (dimensions.contentWidth - imageAreaWidth) / 2;
                        const imageY = dimensions.marginV + 0.6;
                        
                        pdf.setDrawColor(0, 0, 0);
                        pdf.setLineWidth(0.02);
                        pdf.rect(imageX, imageY, imageAreaWidth, imageAreaHeight);
                        pdf.text('🎨 Coloring Area 🎨', dimensions.pageWidth / 2, imageY + imageAreaHeight/2, { align: 'center' });
                    }
                    
                    progress++;
                    progressFill.style.width = (progress / totalSteps * 100) + '%';
                    await sleep(50);
                }
                
                const qualityTag = document.getElementById('pdf-quality').value.replace('print-', '').replace('-', '_');
                const sizeTag = `${dimensions.pageWidth}x${dimensions.pageHeight}`;
                const filename = `${project.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_${sizeTag}_${qualityTag}_${new Date().getTime()}.pdf`;
                
                pdf.save(filename);
                
                progressBar.style.display = 'none';
                generateBtn.disabled = false;
                
                showNotification(`Professional PDF generated successfully! 🎉\nFile: ${filename}`, 'success');
                
            } catch (error) {
                console.error('PDF generation error:', error);
                progressBar.style.display = 'none';
                generateBtn.disabled = false;
                showNotification('Error generating PDF: ' + error.message, 'error');
            }
        }

        function setColorMode(mode) {
            appState.currentColorMode = mode;
            document.querySelectorAll('.color-mode-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-100', 'border-blue-500');
            });
            
            const activeBtn = document.querySelector(`button[onclick="setColorMode('${mode}')"]`);
            if (activeBtn) {
                activeBtn.classList.add('active', 'bg-blue-100', 'border-blue-500');
            }
            
            updateSpecifications();
        }

        async function quickExportSquare() {
            document.getElementById('page-size-pdf').value = 'square-8.5';
            document.getElementById('margin-vertical').value = '0.5';
            document.getElementById('margin-horizontal').value = '0.5';
            document.getElementById('pdf-quality').value = 'print-high';
            document.getElementById('flatten-images').checked = true;
            document.getElementById('optimize-images').checked = true;
            
            updatePageDimensions();
            updateMarginDisplay();
            
            const projectId = document.getElementById('pdf-project').value;
            if (!projectId) {
                showNotification('Please select a project first', 'warning');
                return;
            }
            
            await generateProfessionalPDF();
        }

        async function quickExportLetter() {
            document.getElementById('page-size-pdf').value = 'letter';
            document.getElementById('margin-vertical').value = '0.75';
            document.getElementById('margin-horizontal').value = '0.5';
            document.getElementById('pdf-quality').value = 'print-high';
            document.getElementById('flatten-images').checked = true;
            document.getElementById('optimize-images').checked = true;
            
            updatePageDimensions();
            updateMarginDisplay();
            
            const projectId = document.getElementById('pdf-project').value;
            if (!projectId) {
                showNotification('Please select a project first', 'warning');
                return;
            }
            
            await generateProfessionalPDF();
        }

        // Utility Functions
        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Additional stub functions for completeness
        function toggleGrid() { showNotification('Grid toggle feature coming soon!', 'info'); }
        function fullscreen() { 
            const canvas = appState.canvas;
            if (canvas.requestFullscreen) canvas.requestFullscreen();
        }
        function updatePageLayout() { updatePreviewLayout(); }
        function setOrientation(orientation) { 
            appState.currentOrientation = orientation;
            updatePageLayout();
        }
        function updateMargins(value) {
            document.getElementById('margin-value').textContent = value;
            updatePageLayout();
        }
        function setupDragAndDrop() { console.log('Drag and drop setup placeholder'); }
        function setupPhotoUpload() { console.log('Photo upload setup placeholder'); }
        function handlePhotoUpload(event) { showNotification('Photo upload feature placeholder', 'info'); }
        function convertPhoto() { showNotification('Photo conversion feature placeholder', 'info'); }
        function handleImageGeneration(e) { 
            e.preventDefault();
            showNotification('Image generation feature placeholder', 'info'); 
        }
        function downloadGeneratedImage() { showNotification('Download feature placeholder', 'info'); }
        function saveToProject() { showNotification('Save to project feature placeholder', 'info'); }
        function editInCanvas() { showNotification('Edit in canvas feature placeholder', 'info'); }
        function downloadConverted() { showNotification('Download converted feature placeholder', 'info'); }
        function saveConvertedToProject() { showNotification('Save converted feature placeholder', 'info'); }
        function selectCustomColor(color) { selectColor(color); }

        // Initialize when page loads
        window.addEventListener('load', function() {
            console.log('ColorBook Engine loaded successfully! 🎉');
            showNotification('Welcome to ColorBook Engine! Configure your FREE AI to get started. 🚀', 'info');
        });
    </script>
</body>
</html>                    </div>
                    
                    <div class="story-text mb-4 text-gray-800 leading-relaxed text-lg bg-white rounded-lg p-4 shadow-inner border-l-4 border-blue-500">
                        ${page.story}
                    </div>
                    
                    <div class="image-prompt-section border-t-2 border-gray-200 pt-4">
                        <details class="text-sm bg-gray-50 rounded-lg">
                            <summary class="cursor-pointer text-gray-700 font-semibold p-3 rounded-lg hover:bg-gray-100 transition-colors flex items-center gap-2">
                                🎨 AI Image Prompt
                                <span class="text-xs bg-gray-200 px-2 py-1 rounded ml-auto">Click to expand</span>
                            </summary>
                            <div class="mt-2 p-4 bg-white rounded border-l-4 border-purple-500">
                                <div class="text-xs text-gray-600 font-mono leading-relaxed">
                                    ${page.imagePrompt}
                                </div>
                                <div class="mt-3 flex gap-2">
                                    <span class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded">
                                        📐 ${appState.currentStory.metadata.aspectRatio}
                                    </span>
                                    <span class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded">
                                        ✏️ Line Weight: ${appState.currentStory.metadata.lineWeight}/10
                                    </span>
                                    <span class="text-xs bg-yellow-100 text-yellow-600 px-2 py-1 rounded">
                                        🎨 ${appState.currentStory.metadata.imageStyle}
                                    </span>
                                </div>
                            </div>
                        </details>
                        
                        <div id="generated-image-${page.pageNumber - 1}" class="mt-4">
                            ${page.imageGenerated ? 
                                `<div class="bg-green-50 border-2 border-green-200 rounded-lg p-4 text-center">
                                    <div class="text-green-600 font-semibold mb-2">✅ Image Generated</div>
                                    <div class="text-sm text-green-500">Click "Generate Image" to regenerate</div>
                                </div>` : 
                                `<div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6 text-center">
                                    <div class="text-blue-600 font-semibold mb-2">🎨 Ready for Image Generation</div>
                                    <div class="text-sm text-blue-500">Click "Generate Image" above to create the illustration</div>
                                    <div class="mt-3">
                                        <button onclick="generateSingleImage(${page.pageNumber - 1})" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                            🎨 Generate Now
                                        </button>
                                    </div>
                                </div>`
                            }
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = `
                <div class="story-cards-container">
                    <div class="mb-6 bg-gradient-to-r from-green-100 to-blue-100 rounded-xl p-4 border-2 border-green-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-bold text-green-800">📖 Story Generated Successfully!</h3>
                                <p class="text-sm text-green-600">${storyData.pages.length} pages • ${storyData.pages.reduce((sum, p) => sum + p.wordCount, 0)} total words • ${storyData.metadata.imageStyle} style</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="generateAllImages()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors text-sm">
                                    🖼️ Generate All Images
                                </button>
                            </div>
                        </div>
                    </div>
                    ${cardsHtml}
                </div>
            `;
        }

        async function generateSingleImage(pageIndex) {
            if (!appState.currentStory || !appState.currentStory.pages[pageIndex]) {
                showNotification('Invalid page index', 'error');
                return;
            }
            
            const page = appState.currentStory.pages[pageIndex];
            const imageContainer = document.getElementById(`generated-image-${pageIndex}`);
            
            imageContainer.innerHTML = '<div class="text-center">🎨 Generating image...<br><small>Using AI image generation</small></div>';
            
            try {
                let imageData;
                
                // Try to use real AI image generation if possible
                if (appState.apiKey) {
                    try {
                        imageData = await generateRealImage(page.imagePrompt);
                    } catch (error) {
                        console.log('Real AI image generation failed, using fallback:', error);
                        imageData = createAdvancedColoringPageFromPrompt(
                            page.imagePrompt,
                            appState.currentStory.metadata.imageStyle,
                            appState.currentStory.metadata.lineWeight,
                            appState.currentStory.metadata.aspectRatio
                        );
                    }
                } else {
                    // Use enhanced placeholder generation
                    imageData = createAdvancedColoringPageFromPrompt(
                        page.imagePrompt,
                        appState.currentStory.metadata.imageStyle,
                        appState.currentStory.metadata.lineWeight,
                        appState.currentStory.metadata.aspectRatio
                    );
                }
                
                page.imageGenerated = true;
                page.imageData = imageData;
                
                imageContainer.innerHTML = `
                    <div class="border rounded p-2">
                        <div class="mb-2">${imageData}</div>
                        <div class="flex gap-2 justify-center">
                            <button onclick="downloadPageImage(${pageIndex})" class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded hover:bg-green-200">📥 Download</button>
                            <button onclick="editPageImage(${pageIndex})" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200">✏️ Edit</button>
                            <button onclick="regeneratePageImage(${pageIndex})" class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded hover:bg-purple-200">🔄 Regenerate</button>
                        </div>
                    </div>
                `;
                
                showNotification(`Image generated for page ${pageIndex + 1}!`, 'success');
                
            } catch (error) {
                imageContainer.innerHTML = '<div class="text-center text-red-500">❌ Failed to generate image</div>';
                showNotification('Failed to generate image: ' + error.message, 'error');
            }
        }

        async function generateRealImage(prompt) {
            if (appState.imageService === 'none' || !appState.imageApiKey) {
                throw new Error('Image generation API not configured');
            }
            
            try {
                let imageUrl;
                
                switch (appState.imageService) {
                    case 'openai':
                        imageUrl = await generateWithOpenAI(prompt);
                        break;
                    case 'stabilityai':
                        imageUrl = await generateWithStabilityAI(prompt);
                        break;
                    case 'replicate':
                        imageUrl = await generateWithReplicate(prompt);
                        break;
                    default:
                        throw new Error('Unsupported image service');
                }
                
                if (imageUrl) {
                    return `
                        <div class="w-full max-w-md mx-auto bg-white rounded-lg shadow-lg border-2 border-gray-200">
                            <div class="p-4 border-b bg-gray-50">
                                <h3 class="font-semibold text-gray-800">AI Generated Coloring Page</h3>
                                <div class="text-xs text-gray-600 mt-1">
                                    Generated with ${appState.imageService} • Model: ${appState.imageModel}
                                </div>
                            </div>
                            <div class="p-4">
                                <img src="${imageUrl}" alt="Generated coloring page" class="w-full h-auto rounded border" 
                                     style="max-height: 400px; object-fit: contain;">
                                <div class="mt-3 text-xs text-gray-500">
                                    <div><strong>Prompt:</strong> ${prompt.substring(0, 100)}${prompt.length > 100 ? '...' : ''}</div>
                                    <div class="mt-1"><strong>Service:</strong> ${appState.imageService} (${appState.imageModel})</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Real image generation failed:', error);
                throw error;
            }
        }

        async function generateWithOpenAI(prompt) {
            const response = await fetch('https://api.openai.com/v1/images/generations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${appState.imageApiKey}`
                },
                body: JSON.stringify({
                    model: appState.imageModel,
                    prompt: prompt + ' coloring book style, black and white line art, no color, clear outlines',
                    n: 1,
                    size: '1024x1024',
                    style: 'natural'
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(`OpenAI API Error: ${error.error?.message || 'Failed to generate image'}`);
            }

            const data = await response.json();
            return data.data[0].url;
        }

        async function generateWithStabilityAI(prompt) {
            const response = await fetch('https://api.stability.ai/v1/generation/stable-diffusion-xl-1024-v1-0/text-to-image', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${appState.imageApiKey}`
                },
                body: JSON.stringify({
                    text_prompts: [{
                        text: prompt + ' coloring book style, black and white line art, no shading, clear outlines for coloring',
                        weight: 1
                    }],
                    cfg_scale: 7,
                    height: 1024,
                    width: 1024,
                    samples: 1,
                    steps: 30
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(`Stability AI Error: ${error.message || 'Failed to generate image'}`);
            }

            const data = await response.json();
            return `data:image/png;base64,${data.artifacts[0].base64}`;
        }

        async function generateWithReplicate(prompt) {
            // Note: Replicate requires a different approach with prediction creation and polling
            // This is a simplified version - you'd need to implement the full polling mechanism
            const response = await fetch('https://api.replicate.com/v1/predictions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Token ${appState.imageApiKey}`
                },
                body: JSON.stringify({
                    version: "stability-ai/sdxl:39ed52f2a78e934b3ba6e2a89f5b1c712de7dfea535525255b1aa35c5565e08b",
                    input: {
                        prompt: prompt + ' coloring book style, black and white line art, clear outlines',
                        negative_prompt: 'color, shading, gradient, photorealistic'
                    }
                })
            });

            if (!response.ok) {
                throw new Error('Replicate API Error');
            }

            const prediction = await response.json();
            
            // In a real implementation, you'd poll the prediction URL until completion
            // For now, we'll simulate this with a timeout
            await sleep(10000);
            
            // Get the completed prediction (this is simplified)
            const resultResponse = await fetch(`https://api.replicate.com/v1/predictions/${prediction.id}`, {
                headers: {
                    'Authorization': `Token ${appState.imageApiKey}`
                }
            });

            if (resultResponse.ok) {
                const result = await resultResponse.json();
                return result.output?.[0] || null;
            }
            
            throw new Error('Replicate generation timeout');
        }

        function createAdvancedColoringPageFromPrompt(prompt, style, lineWeight, aspectRatio) {
            // Enhanced coloring page generator based on detailed prompt
            const aspectRatios = {
                'square': { width: 400, height: 400 },
                'landscape': { width: 400, height: 300 },
                'portrait': { width: 300, height: 400 },
                'wide': { width: 500, height: 280 }
            };
            
            const dimensions = aspectRatios[aspectRatio] || aspectRatios.square;
            
            // Extract key elements from prompt
            let mainElements = [];
            const subjects = {
                'rabbit': { emoji: '🐰', paths: 'M200,150 Q180,120 160,130 Q140,140 150,160 Q160,180 180,175 Q200,170 220,175 Q240,180 250,160 Q260,140 240,130 Q220,120 200,150 Z' },
                'cat': { emoji: '🐱', paths: 'M200,140 Q170,110 140,125 Q120,140 130,165 Q140,190 170,185 Q200,180 230,185 Q260,190 270,165 Q280,140 260,125 Q230,110 200,140 Z' },
                'flower': { emoji: '🌸', paths: 'M200,200 Q180,180 160,200 Q180,220 200,200 Q220,180 240,200 Q220,220 200,200 Z' },
                'tree': { emoji: '🌳', paths: 'M180,250 L220,250 L220,350 L180,350 Z M200,100 Q160,120 140,160 Q140,200 180,220 Q220,220 260,200 Q260,160 240,120 Q200,100 200,100 Z' },
                'house': { emoji: '🏠', paths: 'M120,200 L200,120 L280,200 L280,300 L120,300 Z M200,220 L220,220 L220,280 L180,280 L180,220 Z' },
                'butterfly': { emoji: '🦋', paths: 'M200,150 Q190,130 180,140 Q160,150 170,170 Q180,180 190,175 Q200,170 210,175 Q220,180 230,170 Q240,150 220,140 Q210,130 200,150 Z' },
                'star': { emoji: '⭐', paths: 'M200,120 L210,160 L250,160 L220,185 L230,225 L200,200 L170,225 L180,185 L150,160 L190,160 Z' },
                'heart': { emoji: '❤️', paths: 'M200,180 Q170,150 140,160 Q120,180 140,200 Q160,220 200,250 Q240,220 260,200 Q280,180 260,160 Q230,150 200,180 Z' }
            };
            
            let mainPaths = [];
            
            // Find subjects in prompt
            for (const [key, data] of Object.entries(subjects)) {
                if (prompt.toLowerCase().includes(key)) {
                    mainElements.push(data.emoji);
                    mainPaths.push(data.paths);
                }
            }
            
            if (mainElements.length === 0) {
                mainElements = ['🎨'];
                mainPaths = ['M200,200 m -50,0 a 50,50 0 1,0 100,0 a 50,50 0 1,0 -100,0'];
            }
            
            return `
                <svg width="100%" height="200px" viewBox="0 0 ${dimensions.width} ${dimensions.height}" class="border rounded bg-white">
                    <defs>
                        <pattern id="grid-${aspectRatio}" width="20" height="20" patternUnits="userSpaceOnUse">
                            <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#f8f8f8" stroke-width="0.5"/>
                        </pattern>
                    </defs>
                    
                    <rect width="${dimensions.width}" height="${dimensions.height}" fill="white"/>
                    <rect width="${dimensions.width}" height="${dimensions.height}" fill="url(#grid-${aspectRatio})" opacity="0.3"/>
                    
                    <!-- Main elements from prompt -->
                    ${mainElements.map((emoji, i) => `
                        <text x="${dimensions.width/2 + (i-1)*60}" y="${dimensions.height/2}" text-anchor="middle" font-size="${40 + lineWeight*3}" opacity="0.8">${emoji}</text>
                    `).join('')}
                    
                    <!-- Style-based decorative elements -->
                    <circle cx="${dimensions.width/2}" cy="${dimensions.height/2}" r="${80 + lineWeight*8}" fill="none" stroke="#333" stroke-width="${lineWeight}"/>
                    
                    ${style === 'detailed' || style === 'realistic' ? `
                        <circle cx="${dimensions.width*0.2}" cy="${dimensions.height*0.3}" r="25" fill="none" stroke="#333" stroke-width="${lineWeight*0.8}"/>
                        <circle cx="${dimensions.width*0.8}" cy="${dimensions.height*0.3}" r="25" fill="none" stroke="#333" stroke-width="${lineWeight*0.8}"/>
                        <circle cx="${dimensions.width*0.2}" cy="${dimensions.height*0.7}" r="25" fill="none" stroke="#333" stroke-width="${lineWeight*0.8}"/>
                        <circle cx="${dimensions.width*0.8}" cy="${dimensions.height*0.7}" r="25" fill="none" stroke="#333" stroke-width="${lineWeight*0.8}"/>
                    ` : ''}
                    
                    <!-- Border decoration -->
                    <rect x="10" y="10" width="${dimensions.width-20}" height="${dimensions.height-20}" fill="none" stroke="#333" stroke-width="${lineWeight*0.6}" rx="5"/>
                    
                    <text x="${dimensions.width/2}" y="${dimensions.height-5}" text-anchor="middle" font-size="8" fill="#666">
                        ${style} • Line Weight: ${lineWeight} • ${aspectRatio}
                    </text>
                </svg>
            `;
        }

        async function regeneratePageImage(pageIndex) {
            const page = appState.currentStory.pages[pageIndex];
            if (!page) return;
            
            const imageContainer = document.getElementById(`generated-image-${pageIndex}`);
            imageContainer.innerHTML = '<div class="text-center">🔄 Regenerating image...<br><small>Creating new variation</small></div>';
            
            // Add some variation to the prompt for regeneration
            const variations = [
                ' with more detail',
                ' in a different pose',
                ' from a different angle',
                ' with additional background elements',
                ' with simplified composition'
            ];
            
            const variation = variations[Math.floor(Math.random() * variations.length)];
            const modifiedPrompt = page.imagePrompt + variation;
            
            setTimeout(() => {
                const newImageData = createAdvancedColoringPageFromPrompt(
                    modifiedPrompt,
                    appState.currentStory.metadata.imageStyle,
                    appState.currentStory.metadata.lineWeight,
                    appState.currentStory.metadata.aspectRatio
                );
                
                page.imageData = newImageData;
                
                imageContainer.innerHTML = `
                    <div class="border rounded p-2">
                        <div class="mb-2">${newImageData}</div>
                        <div class="flex gap-2 justify-center">
                            <button onclick="downloadPageImage(${pageIndex})" class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded hover:bg-green-200">📥 Download</button>
                            <button onclick="editPageImage(${pageIndex})" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200">✏️ Edit</button>
                            <button onclick="regeneratePageImage(${pageIndex})" class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded hover:bg-purple-200">🔄 Regenerate</button>
                        </div>
                    </div>
                `;
                
                showNotification(`Image regenerated for page ${pageIndex + 1}!`, 'success');
            }, 2000);
        }

        async function generateAllImages() {
            if (!appState.currentStory || !appState.currentStory.pages) {
                showNotification('No story available', 'warning');
                return;
            }
            
            showNotification('Generating all images... This may take a few minutes.', 'info');
            
            for (let i = 0; i < appState.currentStory.pages.length; i++) {
                await generateSingleImage(i);
                await sleep(1000); // Delay between generations
            }
            
            showNotification('All images generated successfully! 🎉', 'success');
        }

        function downloadPageImage(pageIndex) {
            const page = appState.currentStory.pages[pageIndex];
            if (!page.imageData) {
                showNotification('No image to download', 'warning');
                return;
            }
            
            const svgData = page.imageData.match(/<svg[^>]*>.*<\/svg>/s)[0];
            const svgBlob = new Blob([svgData], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(svgBlob);
            
            const link = document.createElement('a');
            link.download = `story-page-${pageIndex + 1}-${new Date().getTime()}.svg`;
            link.href = url;
            link.click();
            
            URL.revokeObjectURL(url);
            showNotification(`Page ${pageIndex + 1} image downloaded!`, 'success');
        }

        function editPageImage(pageIndex) {
            showSection('canvas');
            showNotification(`Edit page ${pageIndex + 1} image in canvas`, 'info');
        }

        function exportStoryCards() {
            if (!appState.currentStory) {
                showNotification('No story to export', 'warning');
                return;
            }
            
            // Create a comprehensive export of the story cards
            const exportData = {
                title: 'Generated Coloring Book Story',
                generatedAt: new Date().toISOString(),
                metadata: appState.currentStory.metadata,
                pages: appState.currentStory.pages.map(page => ({
                    pageNumber: page.pageNumber,
                    story: page.story,
                    imagePrompt: page.imagePrompt,
                    wordCount: page.wordCount,
                    hasImage: page.imageGenerated
                }))
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.download = `story-cards-${new Date().getTime()}.json`;
            link.href = url;
            link.click();
            
            URL.revokeObjectURL(url);
            showNotification('Story cards exported!', 'success');
        }

        function loadStoryTemplate(templateType) {
            const templates = {
                adventure: {
                    theme: 'Epic adventure through magical lands',
                    characters: 'Brave knight Sir Luna, wise dragon Ember',
                    moral: 'Courage and determination'
                },
                friendship: {
                    theme: 'Forest animals working together',
                    characters: 'Curious rabbit Pip, gentle bear Bruno, clever fox Sage',
                    moral: 'The power of friendship and cooperation'
                },
                fantasy: {
                    theme: 'Enchanted kingdom with magical creatures',
                    characters: 'Young wizard apprentice Zara, talking unicorn Starlight',
                    moral: 'Believing in yourself and using magic responsibly'
                }
            };
            
            const template = templates[templateType];
            if (template) {
                document.getElementById('story-theme').value = template.theme;
                document.getElementById('story-characters').value = template.characters;
                document.getElementById('story-moral').value = template.moral;
                showNotification(`Loaded ${templateType} template`, 'info');
            }
        }

        function saveStory() {
            if (!appState.currentProject) {
                showNotification('Please select a project first', 'warning');
                return;
            }
            
            if (!appState.currentStory) {
                showNotification('No story to save', 'warning');
                return;
            }
            
            const storyPage = {
                id: generateId(),
                type: 'story',
                content: { 
                    text: appState.currentStory,
                    wordCount: appState.currentStory.replace(/<[^>]*>/g, '').split(' ').length,
                    version: 1
                },
                pageNumber: appState.currentProject.pages.length + 1,
                createdAt: new Date().toISOString()
            };
            
            appState.currentProject.pages.push(storyPage);
            appState.currentProject.updatedAt = new Date().toISOString();
            saveProjects();
            showNotification('Story saved to project!', 'success');
        }

        // Canvas and Drawing Functions (simplified for space)
        function initializeCanvas() {
            console.log('Initializing canvas...');
            appState.canvas = document.getElementById('drawingCanvas');
            if (!appState.canvas) {
                console.error('Canvas element not found!');
                return;
            }
            
            appState.ctx = appState.canvas.getContext('2d');
            appState.ctx.fillStyle = 'white';
            appState.ctx.fillRect(0, 0, appState.canvas.width, appState.canvas.height);
            appState.ctx.lineCap = 'round';
            appState.ctx.lineJoin = 'round';
            
            // Bind basic events (simplified)
            appState.canvas.addEventListener('mousedown', startDrawing);
            appState.canvas.addEventListener('mousemove', draw);
            appState.canvas.addEventListener('mouseup', stopDrawing);
            
            saveCanvasState();
            console.log('Canvas initialized successfully');
        }

        function initializeColorPalette() {
            const colors = [
                '#000000', '#FFFFFF', '#FF0000', '#00FF00', '#0000FF', '#FFFF00',
                '#FF00FF', '#00FFFF', '#800000', '#008000', '#000080', '#808000',
                '#800080', '#008080', '#FFA500', '#FFC0CB', '#A52A2A', '#808080',
                '#FFB6C1', '#98FB98', '#87CEEB', '#DDA0DD', '#F0E68C', '#FF6347'
            ];
            
            const palette = document.getElementById('color-palette');
            if (!palette) return;
            
            palette.innerHTML = colors.map((color, index) => `
                <div class="color-swatch w-6 h-6 rounded cursor-pointer border-2 border-gray-300 ${index === 0 ? 'active' : ''}" 
                     style="background-color: ${color}" 
                     onclick="selectColor('${color}', this)"></div>
            `).join('');
        }

        // Simplified drawing functions
        function startDrawing(e) {
            appState.isDrawing = true;
            draw(e);
        }

        function draw(e) {
            if (!appState.isDrawing) return;
            const rect = appState.canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (appState.canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (appState.canvas.height / rect.height);
            
            appState.ctx.globalCompositeOperation = appState.drawingMode === 'erase' ? 'destination-out' : 'source-over';
            appState.ctx.lineWidth = appState.brushSize;
            appState.ctx.strokeStyle = appState.currentColor;
            appState.ctx.globalAlpha = appState.opacity / 100;
            
            appState.ctx.lineTo(x, y);
            appState.ctx.stroke();
            appState.ctx.beginPath();
            appState.ctx.moveTo(x, y);
        }

        function stopDrawing() {
            if (appState.isDrawing) {
                appState.isDrawing = false;
                appState.ctx.beginPath();
                appState.ctx.globalAlpha = 1;
                saveCanvasState();
            }
        }

        function saveCanvasState() {
            appState.historyStep++;
            if (appState.historyStep < appState.history.length) {
                appState.history.length = appState.historyStep;
            }
            appState.history.push(appState.canvas.toDataURL());
        }

        function selectColor(color, element) {
            appState.currentColor = color;
            document.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.classList.remove('active');
            });
            if (element) element.classList.add('active');
        }

        function setDrawingMode(mode) {
            appState.drawingMode = mode;
        }

        function updateBrushSize(size) {
            appState.brushSize = size;
            document.getElementById('brush-size-value').textContent = size;
        }

        function updateOpacity(            };
            
            appState.projects.push(project);
            appState.currentProject = project;
            saveProjects();
            loadProjects();
            showSection('projects');
            showNotification('Project created successfully!', 'success');
        }

        function loadProjects() {
            const projectsGrid = document.getElementById('projects-grid');
            const recentProjects = document.getElementById('recent-projects');
            
            if (appState.projects.length === 0) {
                projectsGrid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500">No projects yet. Create your first project to get started.</div>';
                recentProjects.innerHTML = '<p class="text-gray-500 text-center py-8">No recent projects. Create a new project to get started.</p>';
                return;
            }
            
            projectsGrid.innerHTML = appState.projects.map(project => `
                <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
                    <div class="p-6">
                        <h3 class="text-xl font-semibold mb-2">${project.title}</h3>
                        <p class="text-gray-600 mb-2">${project.description || 'No description'}</p>
                        <p class="text-sm text-gray-500 mb-4">${project.pages.length} pages • ${formatDate(project.createdAt)}</p>
                        <div class="flex gap-2">
                            <button onclick="openProject('${project.id}')" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition-colors">Open</button>
                            <button onclick="duplicateProject('${project.id}')" class="px-3 py-2 bg-green-100 text-green-600 rounded hover:bg-green-200 transition-colors">📋</button>
                            <button onclick="deleteProject('${project.id}')" class="px-3 py-2 bg-red-100 text-red-600 rounded hover:bg-red-200 transition-colors">🗑️</button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            const recent = appState.projects.slice(-3).reverse();
            recentProjects.innerHTML = recent.map(project => `
                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                    <div>
                        <h4 class="font-medium">${project.title}</h4>
                        <p class="text-sm text-gray-500">${project.pages.length} pages • ${formatDate(project.createdAt)}</p>
                    </div>
                    <button onclick="openProject('${project.id}')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors">Open</button>
                </div>
            `).join('');
        }

        function openProject(projectId) {
            appState.currentProject = appState.projects.find(p => p.id === projectId);
            showNotification(`Opened project: ${appState.currentProject.title}`, 'success');
            showSection('story');
        }

        function duplicateProject(projectId) {
            const original = appState.projects.find(p => p.id === projectId);
            if (!original) return;
            
            const duplicate = {
                ...original,
                id: generateId(),
                title: original.title + ' (Copy)',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                pages: [...original.pages.map(page => ({ ...page, id: generateId() }))]
            };
            
            appState.projects.push(duplicate);
            saveProjects();
            loadProjects();
            showNotification('Project duplicated successfully!', 'success');
        }

        function deleteProject(projectId) {
            const project = appState.projects.find(p => p.id === projectId);
            if (!project) return;
            
            if (confirm(`Are you sure you want to delete "${project.title}"? This action cannot be undone.`)) {
                appState.projects = appState.projects.filter(p => p.id !== projectId);
                if (appState.currentProject && appState.currentProject.id === projectId) {
                    appState.currentProject = null;
                }
                saveProjects();
                loadProjects();
                showNotification('Project deleted successfully!', 'success');
            }
        }

        function saveProjects() {
            localStorage.setItem('colorbook-projects', JSON.stringify(appState.projects));
        }

        // KDP Compliance Functions
        function initializeKDPSection() {
            loadProjectsForKDP();
        }

        function loadProjectsForKDP() {
            const select = document.getElementById('kdp-project');
            if (!select) return;
            
            select.innerHTML = '<option value="">Choose a project to analyze...</option>';
            
            appState.projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = `${project.title} (${project.pages.length} pages)`;
                select.appendChild(option);
            });
        }

        function loadKDPProjectCheck() {
            const projectId = document.getElementById('kdp-project').value;
            const project = appState.projects.find(p => p.id === projectId);
            
            if (!project) {
                document.getElementById('kdp-check-btn').disabled = true;
                return;
            }
            
            document.getElementById('kdp-check-btn').disabled = false;
            showNotification('Project loaded for KDP compliance check!', 'success');
        }

        async function runKDPComplianceCheck() {
            const projectId = document.getElementById('kdp-project').value;
            const project = appState.projects.find(p => p.id === projectId);
            
            if (!project) {
                showNotification('Please select a project first', 'warning');
                return;
            }
            
            const progressBar = document.getElementById('kdp-progress');
            const progressFill = document.getElementById('kdp-progress-fill');
            const checkBtn = document.getElementById('kdp-check-btn');
            
            checkBtn.disabled = true;
            progressBar.style.display = 'block';
            
            try {
                // Show progress
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 15;
                    if (progress > 90) progress = 90;
                    progressFill.style.width = progress + '%';
                }, 300);
                
                // Run compliance checks
                const results = await performKDPComplianceCheck(project);
                
                clearInterval(progressInterval);
                progressFill.style.width = '100%';
                
                setTimeout(() => {
                    displayComplianceResults(results);
                    progressBar.style.display = 'none';
                    checkBtn.disabled = false;
                    
                    if (results.hasIssues) {
                        document.getElementById('quick-fixes').style.display = 'block';
                    }
                }, 500);
                
            } catch (error) {
                clearInterval(progressInterval);
                progressBar.style.display = 'none';
                checkBtn.disabled = false;
                showNotification('Error running compliance check: ' + error.message, 'error');
            }
        }

        async function performKDPComplianceCheck(project) {
            // Simulate AI analysis of the project
            await sleep(2000);
            
            const checks = [];
            let passCount = 0;
            let totalChecks = 0;
            
            // Content Guidelines Check
            if (document.getElementById('check-content').checked) {
                const contentCheck = analyzeContent(project);
                checks.push(contentCheck);
                if (contentCheck.status === 'pass') passCount++;
                totalChecks++;
            }
            
            // Technical Requirements Check
            if (document.getElementById('check-technical').checked) {
                const technicalCheck = analyzeTechnicalRequirements(project);
                checks.push(technicalCheck);
                if (technicalCheck.status === 'pass') passCount++;
                totalChecks++;
            }
            
            // Format Specifications Check
            if (document.getElementById('check-format').checked) {
                const formatCheck = analyzeFormatSpecifications(project);
                checks.push(formatCheck);
                if (formatCheck.status === 'pass') passCount++;
                totalChecks++;
            }
            
            // Copyright & IP Check
            if (document.getElementById('check-copyright').checked) {
                const copyrightCheck = analyzeCopyrightCompliance(project);
                checks.push(copyrightCheck);
                if (copyrightCheck.status === 'pass') passCount++;
                totalChecks++;
            }
            
            // Quality Standards Check
            if (document.getElementById('check-quality').checked) {
                const qualityCheck = analyzeQualityStandards(project);
                checks.push(qualityCheck);
                if (qualityCheck.status === 'pass') passCount++;
                totalChecks++;
            }
            
            const score = Math.round((passCount / totalChecks) * 100);
            const hasIssues = checks.some(check => check.status !== 'pass');
            
            return {
                score,
                checks,
                hasIssues,
                project
            };
        }

        function analyzeContent(project) {
            const issues = [];
            const recommendations = [];
            
            // Check page count
            if (project.pages.length < 24) {
                issues.push(`Only ${project.pages.length} pages (minimum 24 required)`);
                recommendations.push('Add more coloring pages to reach the 24-page minimum');
            }
            
            // Check for appropriate content
            const storyPages = project.pages.filter(p => p.type === 'story');
            const coloringPages = project.pages.filter(p => p.type === 'coloring');
            
            if (coloringPages.length === 0) {
                issues.push('No coloring pages found');
                recommendations.push('Add coloring pages with clear, printable designs');
            }
            
            // Check age appropriateness
            const hasAgeInfo = project.metadata.targetAgeGroup;
            if (!hasAgeInfo) {
                issues.push('Target age group not specified');
                recommendations.push('Specify target age group in project metadata');
            }
            
            return {
                category: 'Content Guidelines',
                status: issues.length === 0 ? 'pass' : (issues.length <= 2 ? 'warning' : 'fail'),
                issues,
                recommendations,
                description: 'Content must be appropriate, original, and valuable for customers'
            };
        }

        function analyzeTechnicalRequirements(project) {
            const issues = [];
            const recommendations = [];
            
            // Check dimensions (simulated)
            const dims = project.metadata?.dimensions;
            if (!dims || dims.width < 5 || dims.height < 8) {
                issues.push('Page size below minimum (5" x 8")');
                recommendations.push('Use standard sizes: 6"x9", 7"x10", or 8.5"x11"');
            }
            
            if (dims && (dims.width > 8.5 || dims.height > 11)) {
                issues.push('Page size exceeds maximum (8.5" x 11")');
                recommendations.push('Reduce page size to maximum 8.5" x 11"');
            }
            
            // Check for margins
            issues.push('Interior margins should be at least 0.25" on all sides');
            recommendations.push('Set margins to 0.5" for optimal printing');
            
            return {
                category: 'Technical Requirements',
                status: issues.length <= 1 ? 'pass' : 'warning',
                issues,
                recommendations,
                description: 'File format, size, and technical specifications compliance'
            };
        }

        function analyzeFormatSpecifications(project) {
            const issues = [];
            const recommendations = [];
            
            // Resolution check (simulated)
            issues.push('Verify all images are 300 DPI for print quality');
            recommendations.push('Use the PDF export with "Print High Quality" setting');
            
            // Color mode check
            recommendations.push('Use CMYK color mode for professional printing');
            
            // Bleed check
            if (!document.getElementById('include-bleed')?.checked) {
                issues.push('No bleed area specified');
                recommendations.push('Add 0.125" bleed for professional printing');
            }
            
            return {
                category: 'Format Specifications',
                status: issues.length <= 1 ? 'warning' : 'fail',
                issues,
                recommendations,
                description: 'Print-ready format with proper resolution and color settings'
            };
        }

        function analyzeCopyrightCompliance(project) {
            const issues = [];
            const recommendations = [];
            
            // Check for potential copyright issues (basic text analysis)
            const storyContent = project.pages
                .filter(p => p.type === 'story')
                .map(p => p.content?.text || '')
                .join(' ').toLowerCase();
            
            const copyrightedTerms = [
                'disney', 'mickey mouse', 'pokemon', 'mario', 'superman', 'batman', 
                'spiderman', 'frozen', 'elsa', 'anna', 'harry potter', 'star wars'
            ];
            
            const foundTerms = copyrightedTerms.filter(term => storyContent.includes(term));
            
            if (foundTerms.length > 0) {
                issues.push(`Potential copyrighted content detected: ${foundTerms.join(', ')}`);
                recommendations.push('Remove or replace copyrighted characters with original content');
            }
            
            // General copyright advice
            recommendations.push('Ensure all content is original or properly licensed');
            recommendations.push('Avoid using trademarked characters or brand names');
            
            return {
                category: 'Copyright & Intellectual Property',
                status: foundTerms.length === 0 ? 'pass' : 'fail',
                issues,
                recommendations,
                description: 'Content must be original or properly licensed'
            };
        }

        function analyzeQualityStandards(project) {
            const issues = [];
            const recommendations = [];
            
            // Check content diversity
            const storyPages = project.pages.filter(p => p.type === 'story').length;
            const coloringPages = project.pages.filter(p => p.type === 'coloring').length;
            
            if (coloringPages < storyPages) {
                issues.push('More story pages than coloring pages');
                recommendations.push('Coloring books should focus primarily on coloring content');
            }
            
            // Check for blank pages
            const emptyPages = project.pages.filter(p => !p.content || Object.keys(p.content).length === 0);
            if (emptyPages.length > 0) {
                issues.push(`${emptyPages.length} empty pages detected`);
                recommendations.push('Remove blank pages or add content');
            }
            
            // Quality recommendations
            recommendations.push('Ensure consistent art style throughout the book');
            recommendations.push('Test print a sample page to verify line thickness');
            
            return {
                category: 'Quality Standards',
                status: issues.length === 0 ? 'pass' : 'warning',
                issues,
                recommendations,
                description: 'Professional quality and customer value standards'
            };
        }

        function displayComplianceResults(results) {
            const container = document.getElementById('compliance-results');
            const scoreContainer = document.getElementById('compliance-score');
            const scoreValue = document.getElementById('score-value');
            const scoreBar = document.getElementById('score-bar');
            
            // Show overall score
            scoreContainer.style.display = 'block';
            scoreValue.textContent = results.score + '%';
            scoreBar.style.width = results.score + '%';
            
            // Color code the score
            if (results.score >= 80) {
                scoreValue.className = 'text-2xl font-bold text-green-600';
                scoreBar.className = 'bg-green-600 h-2 rounded-full';
            } else if (results.score >= 60) {
                scoreValue.className = 'text-2xl font-bold text-yellow-600';
                scoreBar.className = 'bg-yellow-600 h-2 rounded-full';
            } else {
                scoreValue.className = 'text-2xl font-bold text-red-600';
                scoreBar.className = 'bg-red-600 h-2 rounded-full';
            }
            
            // Display detailed results
            container.innerHTML = results.checks.map(check => `
                <div class="compliance-check compliance-${check.status}">
                    <div class="flex items-start justify-between mb-2">
                        <h3 class="font-semibold">${check.category}</h3>
                        <span class="text-xs px-2 py-1 rounded ${
                            check.status === 'pass' ? 'bg-green-100 text-green-800' :
                            check.status === 'warning' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-red-100 text-red-800'
                        }">
                            ${check.status.toUpperCase()}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 mb-3">${check.description}</p>
                    
                    ${check.issues.length > 0 ? `
                        <div class="mb-3">
                            <h4 class="text-sm font-medium text-red-700 mb-1">Issues Found:</h4>
                            <ul class="text-sm text-red-600 list-disc list-inside space-y-1">
                                ${check.issues.map(issue => `<li>${issue}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${check.recommendations.length > 0 ? `
                        <div>
                            <h4 class="text-sm font-medium text-blue-700 mb-1">Recommendations:</h4>
                            <ul class="text-sm text-blue-600 list-disc list-inside space-y-1">
                                ${check.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `).join('');
            
            showNotification(`Compliance check complete! Score: ${results.score}%`, 
                results.score >= 80 ? 'success' : results.score >= 60 ? 'warning' : 'error');
        }

        // Quick fix functions
        function autoFixMargins() {
            // Set standard margins for KDP compliance
            const marginInputs = document.querySelectorAll('#margin-vertical, #margin-horizontal');
            marginInputs.forEach(input => {
                input.value = '0.5'; // Set to 0.5 inches
            });
            updateMarginDisplay();
            showNotification('Margins set to KDP-compliant 0.5 inches', 'success');
        }

        function autoFixResolution() {
            // Set high-quality print settings
            const qualitySelect = document.getElementById('pdf-quality');
            if (qualitySelect) {
                qualitySelect.value = 'print-high';
            }
            showNotification('Resolution set to 300 DPI for print quality', 'success');
        }

        function autoFixBleed() {
            // Enable bleed marks
            const bleedCheckbox = document.getElementById('include-bleed');
            if (bleedCheckbox) {
                bleedCheckbox.checked = true;
            }
            showNotification('Bleed marks enabled for professional printing', 'success');
        }

        // Story Generation Functions
        async function handleStoryGeneration(e) {
            e.preventDefault();
            console.log('Starting enhanced story generation...');
            
            if (!appState.apiKey) {
                showNotification('Please configure your API key first', 'warning');
                openApiModal();
                return;
            }
            
            const theme = document.getElementById('story-theme').value;
            const characters = document.getElementById('story-characters').value;
            const ageMin = document.getElementById('age-min').value;
            const ageMax = document.getElementById('age-max').value;
            const isAdult = document.getElementById('adult-audience').checked;
            const numPages = document.getElementById('story-pages').value;
            const wordsPerPage = document.getElementById('words-per-page').value;
            const imageStyle = document.getElementById('story-image-style').value;
            const lineWeight = document.getElementById('story-line-weight').value;
            const aspectRatio = document.getElementById('story-aspect-ratio').value;
            const moral = document.getElementById('story-moral').value;
            
            if (!theme || !characters) {
                showNotification('Please fill in theme and characters', 'warning');
                return;
            }
            
            const storyContainer = document.getElementById('generated-story');
            const progressBar = document.getElementById('story-progress');
            const progressFill = document.getElementById('story-progress-fill');
            
            // Show progress
            progressBar.style.display = 'block';
            storyContainer.innerHTML = '<div class="text-center">🤖 Generating story cards with image prompts...<br><small>Using ' + appState.aiModel + '</small></div>';
            
            // Simulate progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                progressFill.style.width = progress + '%';
            }, 300);
            
            try {
                const storyData = await generateStoryWithImagePrompts({
                    theme, characters, ageMin, ageMax, isAdult, numPages, wordsPerPage, 
                    imageStyle, lineWeight, aspectRatio, moral
                });
                
                clearInterval(progressInterval);
                progressFill.style.width = '100%';
                
                setTimeout(() => {
                    appState.currentStory = storyData;
                    displayStoryCards(storyData);
                    progressBar.style.display = 'none';
                    
                    // Enable buttons
                    document.querySelector('button[onclick="saveStory()"]').disabled = false;
                    document.querySelector('button[onclick="generateAllImages()"]').disabled = false;
                    document.querySelector('button[onclick="exportStoryCards()"]').disabled = false;
                    
                    showNotification(`Story with ${storyData.pages.length} pages generated! 🎉`, 'success');
                }, 500);
                
            } catch (error) {
                console.error('Story generation error:', error);
                clearInterval(progressInterval);
                progressBar.style.display = 'none';
                storyContainer.innerHTML = '<div class="text-center text-red-600">❌ Error generating story. Please try again.<br><small>' + error.message + '</small></div>';
                showNotification('Error generating story: ' + error.message, 'error');
            }
        }

        async function generateStoryWithImagePrompts({
            theme, characters, ageMin, ageMax, isAdult, numPages, wordsPerPage, 
            imageStyle, lineWeight, aspectRatio, moral
        }) {
            const ageGroup = isAdult ? 'adults' : `children aged ${ageMin}-${ageMax} years`;
            const totalWords = numPages * wordsPerPage;
            
            const aspectRatioMap = {
                'square': '1:1',
                'landscape': '4:3', 
                'portrait': '3:4',
                'wide': '16:9'
            };
            
            const lineWeightDesc = {
                1: 'very thin, delicate lines',
                2: 'thin lines', 
                3: 'light-medium lines',
                4: 'medium lines',
                5: 'medium-thick lines',
                6: 'thick lines',
                7: 'very thick lines',
                8: 'bold thick lines',
                9: 'extra bold lines',
                10: 'maximum thickness lines'
            };
            
            const prompt = `Create a ${numPages}-page children's coloring book story with accompanying image prompts. 

🎯 STORY SPECIFICATIONS:
- Target Audience: ${ageGroup}
- Theme: ${theme}
- Main Characters: ${characters}
- Total Pages: ${numPages}
- Words per Page: approximately ${wordsPerPage} words
- Total Story Length: approximately ${totalWords} words
- Moral/Lesson: ${moral || 'friendship and positive values'}

📝 STORY REQUIREMENTS:
- Write exactly ${numPages} pages
- Each page should be approximately ${wordsPerPage} words
- Use engaging, age-appropriate language for ${ageGroup}
- Each page should describe a scene perfect for illustration
- Include character development and interaction
- Build to the moral/lesson naturally
- Make each page complete but part of the larger story

🎨 IMAGE PROMPT REQUIREMENTS:
For each page, create a detailed image prompt for generating a perfect coloring page:
- Style: ${imageStyle} style
- Aspect ratio: ${aspectRatioMap[aspectRatio]}
- Line weight: ${lineWeightDesc[lineWeight]} (${lineWeight}/10)
- Black and white outlines only, suitable for coloring
- Clear, distinct areas for coloring
- Age-appropriate complexity for ${ageGroup}
- Include all characters and scene elements from the story text
- Specify "coloring book style", "black outlines", "no shading", "white background"

📋 OUTPUT FORMAT:
Structure your response EXACTLY like this:

PAGE 1:
STORY: [Write engaging story text for page 1 - approximately ${wordsPerPage} words describing the scene and action]

IMAGE_PROMPT: [Detailed prompt for AI image generation - specify: "${imageStyle} style coloring book illustration, ${aspectRatioMap[aspectRatio]} aspect ratio, ${lineWeightDesc[lineWeight]}, black and white outlines, no shading, white background, showing [describe the exact scene from the story with characters and setting], suitable for coloring, clear distinct areas"]

PAGE 2:
STORY: [Continue the story for page 2 - approximately ${wordsPerPage} words]

IMAGE_PROMPT: [Detailed image prompt for page 2 following same format]

[Continue for all ${numPages} pages...]

IMPORTANT: Each IMAGE_PROMPT must be detailed enough to generate a proper coloring page that matches the story content exactly.`;

            console.log('Sending story+image request to OpenRouter API...');

            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${appState.apiKey}`,
                    'HTTP-Referer': window.location.origin,
                    'X-Title': 'ColorBook Engine'
                },
                body: JSON.stringify({
                    model: appState.aiModel,
                    messages: [{
                        role: 'system',
                        content: 'You are a professional children\'s book author and illustrator who creates engaging stories paired with perfect coloring book image prompts. You always follow the exact format requested and create age-appropriate content that pairs perfectly with illustrations.'
                    }, {
                        role: 'user',
                        content: prompt
                    }],
                    temperature: 0.8,
                    max_tokens: Math.max(2000, numPages * 200)
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || `API request failed: ${response.status}`);
            }

            const data = await response.json();
            console.log('Received story+image data from API');
            
            return parseStoryWithImagePrompts(data.choices[0].message.content, {
                imageStyle, lineWeight, aspectRatio, numPages, wordsPerPage
            });
        }

        function parseStoryWithImagePrompts(content, params) {
            const pages = [];
            const pageMatches = content.match(/PAGE \d+:([\s\S]*?)(?=PAGE \d+:|$)/g);
            
            if (!pageMatches) {
                // Fallback parsing
                throw new Error('Failed to parse story format. Please try again.');
            }
            
            pageMatches.forEach((pageMatch, index) => {
                const storyMatch = pageMatch.match(/STORY:\s*([\s\S]*?)(?=IMAGE_PROMPT:|$)/);
                const imageMatch = pageMatch.match(/IMAGE_PROMPT:\s*([\s\S]*?)$/);
                
                const storyText = storyMatch ? storyMatch[1].trim() : `Page ${index + 1} story content`;
                const imagePrompt = imageMatch ? imageMatch[1].trim() : `${params.imageStyle} style coloring page for page ${index + 1}`;
                
                pages.push({
                    pageNumber: index + 1,
                    story: storyText,
                    imagePrompt: imagePrompt,
                    wordCount: storyText.split(' ').length,
                    imageGenerated: false,
                    imageData: null
                });
            });
            
            return {
                pages: pages,
                metadata: {
                    imageStyle: params.imageStyle,
                    lineWeight: params.lineWeight,
                    aspectRatio: params.aspectRatio,
                    totalPages: params.numPages,
                    targetWordsPerPage: params.wordsPerPage,
                    generatedAt: new Date().toISOString()
                }
            };
        }

        function displayStoryCards(storyData) {
            const container = document.getElementById('generated-story');
            
            const cardsHtml = storyData.pages.map((page, index) => `
                <div class="story-card bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-gray-200 rounded-xl p-6 mb-6 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <div class="bg-blue-600 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg">
                                ${page.pageNumber}
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-blue-800">Page ${page.pageNumber}</h3>
                                <p class="text-sm text-gray-600">${page.wordCount} words • ${appState.currentStory.metadata.imageStyle} style</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <span class="text-xs bg-blue-100 text-blue-600 px-3 py-1 rounded-full font-medium">${page.wordCount} words</span>
                            <button onclick="generateSingleImage(${page.pageNumber - 1})" class="text-xs bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2 rounded-full hover:from-purple-600 hover:to-pink-600 transition-all duration-200 transform hover:scale-105 font-medium shadow-md">
                                🎨 Generate Image
                            </button>
                        </div>
                                <!-- KDP Guidelines Reference -->
                <div class="mt-6 bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">📖 KDP Guidelines Reference</h2>
                    <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                        <div class="compliance-check">
                            <h3 class="font-semibold mb-2">📏 Size & Format</h3>
                            <ul class="text-sm space-y-1">
                                <li>• Minimum size: 5" x 8"</li>
                                <li>• Maximum size: 8.5" x 11"</li>
                                <li>• Bleed: 0.125" on all sides</li>
                                <li>• Spine calculation required</li>
                                <li>• PDF format only</li>
                            </ul>
                        </div>
                        
                        <div class="compliance-check">
                            <h3 class="font-semibold mb-2">🖼️ Image Quality</h3>
                            <ul class="text-sm space-y-1">
                                <li>• Resolution: 300 DPI minimum</li>
                                <li>• Color mode: CMYK for print</li>
                                <li>• No compression artifacts</li>
                                <li>• High contrast lines</li>
                                <li>• Clear, printable images</li>
                            </ul>
                        </div>
                        
                        <div class="compliance-check">
                            <h3 class="font-semibold mb-2">📝 Content Rules</h3>
                            <ul class="text-sm space-y-1">
                                <li>• No offensive content</li>
                                <li>• Age-appropriate material</li>
                                <li>• Original or licensed content</li>
                                <li>• No copyrighted characters</li>
                                <li>• Quality illustrations</li>
                            </ul>
                        </div>
                        
                        <div class="compliance-check">
                            <h3 class="font-semibold mb-2">📄 Page Requirements</h3>
                            <ul class="text-sm space-y-1">
                                <li>• Minimum 24 pages</li>
                                <li>• Interior margins: 0.25"</li>
                                <li>• Consistent page layout</li>
                                <li>• No blank pages</li>
                                <li>• Page numbering optional</li>
                            </ul>
                        </div>
                        
                        <div class="compliance-check">
                            <h3 class="font-semibold mb-2">⚖️ Legal Compliance</h3>
                            <ul class="text-sm space-y-1">
                                <li>• No trademark violations</li>
                                <li>• Public domain content OK</li>
                                <li>• Attribution if required</li>
                                <li>• No misleading content</li>
                                <li>• Age ratings accurate</li>
                            </ul>
                        </div>
                        
                        <div class="compliance-check">
                            <h3 class="font-semibold mb-2">📊 Quality Standards</h3>
                            <ul class="text-sm space-y-1">
                                <li>• Professional presentation</li>
                                <li>• Consistent art style</li>
                                <li>• Error-free content</li>
                                <li>• Readable text/lines</li>
                                <li>• Value for customers</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PDF Section -->
        <div id="pdf-section" class="section p-6" style="display: none;">
            <div class="max-w-6xl mx-auto">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">📄 Professional PDF Export</h1>
                
                <div class="grid gap-6 lg:grid-cols-2">
                    <!-- Export Settings -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Export Configuration</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Select Project</label>
                                <select id="pdf-project" class="w-full p-3 border border-gray-300 rounded-lg" onchange="loadProjectPages()">
                                    <option value="">Choose a project to export...</option>
                                </select>
                            </div>
                            
                            <!-- Page Size with Custom Dimensions -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Page Size</label>
                                <select id="page-size-pdf" class="w-full p-3 border border-gray-300 rounded-lg" onchange="updatePageDimensions()">
                                    <option value="letter">8.5" × 11" (Letter)</option>
                                    <option value="square-8.5">8.5" × 8.5" (Square)</option>
                                    <option value="square-9">9" × 9" (Large Square)</option>
                                    <option value="legal">8.5" × 14" (Legal)</option>
                                    <option value="a4">8.27" × 11.69" (A4)</option>
                                    <option value="a5">5.83" × 8.27" (A5)</option>
                                    <option value="tabloid">11" × 17" (Tabloid)</option>
                                    <option value="custom">Custom Size</option>
                                </select>
                            </div>
                            
                            <!-- Custom Dimensions (shown when custom is selected) -->
                            <div id="custom-dimensions" class="grid grid-cols-2 gap-4" style="display: none;">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Width (inches)</label>
                                    <input type="number" id="custom-width" step="0.1" min="3" max="24" value="8.5" class="w-full p-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Height (inches)</label>
                                    <input type="number" id="custom-height" step="0.1" min="3" max="24" value="8.5" class="w-full p-2 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                            
                            <!-- Margin Controls -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Margins (inches)</label>
                                <div class="grid grid-cols-2 gap-4 mb-2">
                                    <div>
                                        <label class="text-xs text-gray-600">Top/Bottom: <span id="margin-v-value">0.5</span>"</label>
                                        <input type="range" id="margin-vertical" min="0.25" max="2" step="0.125" value="0.5" class="w-full" oninput="updateMarginDisplay()">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-600">Left/Right: <span id="margin-h-value">0.5</span>"</label>
                                        <input type="range" id="margin-horizontal" min="0.25" max="2" step="0.125" value="0.5" class="w-full" oninput="updateMarginDisplay()">
                                    </div>
                                </div>
                                <div class="text-xs text-gray-500 bg-gray-50 p-2 rounded">
                                    Content area: <span id="content-area">7.5" × 10"</span>
                                </div>
                            </div>
                            
                            <!-- Print Quality -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Print Quality</label>
                                <select id="pdf-quality" class="w-full p-3 border border-gray-300 rounded-lg">
                                    <option value="print-high">Print High Quality (300 DPI)</option>
                                    <option value="print-standard">Print Standard (150 DPI)</option>
                                    <option value="web">Web Quality (72 DPI)</option>
                                    <option value="professional">Professional (600 DPI)</option>
                                </select>
                            </div>
                            
                            <!-- Image Handling -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Image Processing</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="flatten-images" class="rounded" checked>
                                        <span class="ml-2 text-sm">Flatten all layers and transparency</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="optimize-images" class="rounded" checked>
                                        <span class="ml-2 text-sm">Optimize images for print</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="stroke-enhance" class="rounded" checked>
                                        <span class="ml-2 text-sm">Enhance line strokes for coloring</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Professional Print Options -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Professional Options</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="include-bleed" class="rounded">
                                        <span class="ml-2 text-sm">Include bleed marks (0.125")</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="include-crop-marks" class="rounded">
                                        <span class="ml-2 text-sm">Include crop marks</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="include-color-bars" class="rounded">
                                        <span class="ml-2 text-sm">Include color registration bars</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Color Mode -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Color Profile</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="setColorMode('rgb')" class="color-mode-btn p-2 border border-gray-300 rounded hover:bg-gray-50 active">RGB (Digital)</button>
                                    <button onclick="setColorMode('cmyk')" class="color-mode-btn p-2 border border-gray-300 rounded hover:bg-gray-50">CMYK (Print)</button>
                                </div>
                            </div>
                            
                            <!-- Content Options -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Include Options</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="include-cover" class="rounded" checked>
                                        <span class="ml-2 text-sm">Cover page with title</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="include-toc" class="rounded" checked>
                                        <span class="ml-2 text-sm">Table of contents</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="include-page-numbers" class="rounded" checked>
                                        <span class="ml-2 text-sm">Page numbers</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="include-instructions" class="rounded">
                                        <span class="ml-2 text-sm">Coloring instructions page</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="double-sided" class="rounded">
                                        <span class="ml-2 text-sm">Double-sided layout (book format)</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Page Range -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Page Range</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" id="start-page" placeholder="Start" class="p-2 border border-gray-300 rounded" value="1">
                                    <input type="number" id="end-page" placeholder="End" class="p-2 border border-gray-300 rounded">
                                </div>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div id="pdf-progress" class="progress-bar" style="display: none;">
                                <div id="pdf-progress-fill" class="progress-fill"></div>
                            </div>
                            
                            <!-- Generate Button -->
                            <button onclick="generateProfessionalPDF()" id="generate-pdf-btn" class="w-full bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition-colors font-semibold" disabled>
                                📥 Generate Professional PDF
                            </button>
                        </div>
                    </div>
                    
                    <!-- Preview Panel -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Print Preview</h2>
                        
                        <!-- Page Preview -->
                        <div id="pdf-preview" class="bg-gray-100 rounded-lg p-4 mb-4 flex items-center justify-center border-2 border-dashed border-gray-300" style="aspect-ratio: 8.5/11;">
                            <div id="preview-content" class="bg-white shadow-lg rounded" style="width: 85%; height: 90%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                <div class="text-center text-gray-500">
                                    📄 Select a project to preview layout
                                    <p class="text-sm mt-2">Margins and content area will be shown</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Page List -->
                        <div id="page-list" class="space-y-2 max-h-60 overflow-y-auto" style="display: none;">
                            <!-- Pages will be listed here -->
                        </div>
                        
                        <!-- Quick Export Options -->
                        <div class="mt-4 space-y-2">
                            <button onclick="quickExportSquare()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 text-sm">
                                🚀 Quick Export: 8.5" × 8.5" Square
                            </button>
                            <button onclick="quickExportLetter()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 text-sm">
                                📄 Quick Export: 8.5" × 11" Letter
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Export Statistics -->
                <div class="mt-6 bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Export Statistics & File Info</h2>
                    <div class="grid gap-4 md:grid-cols-5">
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600" id="total-pages">0</div>
                            <div class="text-sm text-gray-600">Total Pages</div>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="text-2xl font-bold text-green-600" id="story-pages">0</div>
                            <div class="text-sm text-gray-600">Story Pages</div>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg">
                            <div class="text-2xl font-bold text-purple-600" id="coloring-pages">0</div>
                            <div class="text-sm text-gray-600">Coloring Pages</div>
                        </div>
                        <div class="text-center p-4 bg-yellow-50 rounded-lg">
                            <div class="text-2xl font-bold text-yellow-600" id="estimated-size">0 MB</div>
                            <div class="text-sm text-gray-600">Est. File Size</div>
                        </div>
                        <div class="text-center p-4 bg-red-50 rounded-lg">
                            <div class="text-2xl font-bold text-red-600" id="print-cost">$0.00</div>
                            <div class="text-sm text-gray-600">Est. Print Cost</div>
                        </div>
                    </div>
                    
                    <!-- File Specifications -->
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-800 mb-2">Document Specifications</h3>
                            <div class="text-sm space-y-1">
                                <div>Page Size: <span id="spec-page-size">8.5" × 11"</span></div>
                                <div>Margins: <span id="spec-margins">0.5" all sides</span></div>
                                <div>Content Area: <span id="spec-content-area">7.5" × 10"</span></div>
                                <div>Resolution: <span id="spec-resolution">300 DPI</span></div>
                                <div>Color Profile: <span id="spec-color-profile">RGB</span></div>
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-800 mb-2">Print Recommendations</h3>
                            <div class="text-sm space-y-1">
                                <div>Paper: Heavy cardstock (110lb+)</div>
                                <div>Binding: Perfect bound or spiral</div>
                                <div>Finish: Matte or satin</div>
                                <div>Printer: Laser or high-quality inkjet</div>
                                <div>Bleed: <span id="spec-bleed">None</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global app state - Initialize immediately
        const appState = {
            currentProject: null,
            projects: JSON.parse(localStorage.getItem('colorbook-projects') || '[]'),
            currentStory: '',
            canvas: null,
            ctx: null,
            isDrawing: false,
            currentColor: '#000000',
            brushSize: 5,
            opacity: 100,
            drawingMode: 'draw',
            history: [],
            historyStep: -1,
            apiKey: localStorage.getItem('openrouter-api-key') || '',
            aiModel: localStorage.getItem('ai-model') || 'google/gemma-2-9b-it:free',
            imageService: localStorage.getItem('image-service') || 'none',
            imageApiKey: localStorage.getItem('image-api-key') || '',
            imageModel: localStorage.getItem('image-model') || 'dall-e-3',
            currentOrientation: 'portrait',
            currentColorMode: 'rgb',
            lastGeneratedImage: null,
            lastConvertedImage: null
        };

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing ColorBook Engine...');
            
            // Load saved image API settings
            appState.imageService = localStorage.getItem('image-service') || 'none';
            appState.imageApiKey = localStorage.getItem('image-api-key') || '';
            appState.imageModel = localStorage.getItem('image-model') || 'dall-e-3';
            
            // Initialize components
            initializeCanvas();
            initializeColorPalette();
            loadProjects();
            showSection('dashboard');
            updateApiStatus();
            
            // Event listeners
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);
            document.getElementById('story-form').addEventListener('submit', handleStoryGeneration);
            document.getElementById('image-form').addEventListener('submit', handleImageGeneration);
            
            // PDF section event listeners
            ['custom-width', 'custom-height'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', () => {
                        updateContentArea();
                        updatePreviewLayout();
                        updateSpecifications();
                    });
                }
            });
            
            // Drag and drop setup
            setupDragAndDrop();
            setupPhotoUpload();
            
            console.log('ColorBook Engine initialized successfully!');
        });

        // Notification System
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notification-icon');
            const messageEl = document.getElementById('notification-message');
            
            const icons = {
                success: '✅',
                error: '❌',
                info: 'ℹ️',
                warning: '⚠️'
            };
            
            icon.textContent = icons[type] || icons.info;
            messageEl.textContent = message;
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // API Configuration Functions
        function openApiModal() {
            document.getElementById('api-modal').classList.remove('hidden');
            document.getElementById('openrouter-key').value = appState.apiKey;
            document.getElementById('ai-model').value = appState.aiModel;
            document.getElementById('image-service').value = appState.imageService;
            document.getElementById('image-api-key').value = appState.imageApiKey;
            document.getElementById('image-model').value = appState.imageModel;
            toggleImageApiFields();
        }

        function toggleImageApiFields() {
            const service = document.getElementById('image-service').value;
            const fields = document.getElementById('image-api-fields');
            fields.style.display = service === 'none' ? 'none' : 'block';
            
            // Update model options based on service
            const modelSelect = document.getElementById('image-model');
            modelSelect.innerHTML = '';
            
            const modelOptions = {
                'openai': [
                    { value: 'dall-e-3', text: 'DALL-E 3 (Latest)' },
                    { value: 'dall-e-2', text: 'DALL-E 2' }
                ],
                'stabilityai': [
                    { value: 'stable-diffusion-xl-1024-v1-0', text: 'Stable Diffusion XL' },
                    { value: 'stable-diffusion-v1-6', text: 'Stable Diffusion v1.6' }
                ],
                'replicate': [
                    { value: 'stability-ai/sdxl', text: 'SDXL via Replicate' },
                    { value: 'lucataco/animate-diff', text: 'AnimateDiff' }
                ],
                'midjourney': [
                    { value: 'midjourney-v6', text: 'Midjourney v6' },
                    { value: 'midjourney-v5', text: 'Midjourney v5' }
                ]
            };
            
            if (modelOptions[service]) {
                modelOptions[service].forEach(option => {
                    const optionEl = document.createElement('option');
                    optionEl.value = option.value;
                    optionEl.textContent = option.text;
                    modelSelect.appendChild(optionEl);
                });
            }
        }

        async function saveApiConfig() {
            const apiKey = document.getElementById('openrouter-key').value;
            const model = document.getElementById('ai-model').value;
            const imageService = document.getElementById('image-service').value;
            const imageApiKey = document.getElementById('image-api-key').value;
            const imageModel = document.getElementById('image-model').value;
            
            if (!apiKey.trim()) {
                showNotification('Please enter your OpenRouter API key for text generation', 'warning');
                return;
            }
            
            appState.apiKey = apiKey;
            appState.aiModel = model;
            appState.imageService = imageService;
            appState.imageApiKey = imageApiKey;
            appState.imageModel = imageModel;
            
            localStorage.setItem('openrouter-api-key', apiKey);
            localStorage.setItem('ai-model', model);
            localStorage.setItem('image-service', imageService);
            localStorage.setItem('image-api-key', imageApiKey);
            localStorage.setItem('image-model', imageModel);
            
            // Test the text API connection
            try {
                showNotification('Testing API connections...', 'info');
                
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'ColorBook Engine'
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: 'user', content: 'Hello' }],
                        max_tokens: 10
                    })
                });

                if (response.ok) {
                    updateApiStatus();
                    closeApiModal();
                    
                    let message = 'Text generation API configured successfully! 🎉';
                    if (imageService !== 'none') {
                        message += ' Image generation is also configured.';
                    } else {
                        message += ' Using advanced placeholder generation for images.';
                    }
                    showNotification(message, 'success');
                } else {
                    const error = await response.json();
                    showNotification(`Text API Error: ${error.error?.message || 'Invalid configuration'}`, 'error');
                }
            } catch (error) {
                showNotification('Failed to test text API connection. Please check your key.', 'error');
            }
        }

        function updateApiStatus() {
            const status = document.getElementById('api-status');
            if (appState.apiKey) {
                const modelName = appState.aiModel.split('/').pop().split(':')[0];
                const isFree = appState.aiModel.includes(':free');
                const imageStatus = appState.imageService !== 'none' ? ' + Images' : '';
                status.innerHTML = `Configured ✅ <span class="model-badge ${isFree ? 'model-free' : 'model-paid'}">${modelName.toUpperCase()}</span>${imageStatus}`;
                status.className = 'text-green-600 font-medium';
            } else {
                status.textContent = 'Not Configured';
                status.className = 'text-red-600 font-medium';
            }
        }

        function closeApiModal() {
            document.getElementById('api-modal').classList.add('hidden');
        }

        // Navigation
        function showSection(sectionName) {
            console.log('Showing section:', sectionName);
            
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.style.display = 'block';
                setTimeout(() => {
                    targetSection.classList.add('active', 'fade-in');
                }, 10);
            }
            
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-blue-100', 'text-blue-800');
            });
            
            const activeBtn = document.querySelector(`[data-section="${sectionName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('bg-blue-100', 'text-blue-800');
            }
            
            closeMobileMenu();
            
            // Section-specific initializations
            if (sectionName === 'pdf') {
                initializePDFSection();
            } else if (sectionName === 'kdp') {
                initializeKDPSection();
            }
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('-translate-x-full');
        }

        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.add('-translate-x-full');
        }

        // Project Management
        function createNewProject() {
            const title = prompt('Enter project title:');
            if (!title) return;
            
            const description = prompt('Enter project description (optional):') || '';
            
            const project = {
                id: generateId(),
                title: title,
                description: description,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                pages: [],
                metadata: {
                    author: 'Creator',
                    targetAgeGroup: '6-8',
                    dimensions: { width: 8.5, height: 11, unit: 'in' },
                    bindingType: 'perfect',
                    tags: []
                }
                                    <div class="p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition-colors" onclick="loadStoryTemplate('adventure')">
                            <h3 class="font-medium mb-2">🗺️ Adventure Quest</h3>
                            <p class="text-sm text-gray-600">Heroes on a journey to save their homeland</p>
                            <span class="difficulty-badge difficulty-medium mt-2">Medium</span>
                        </div>
                        <div class="p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition-colors" onclick="loadStoryTemplate('friendship')">
                            <h3 class="font-medium mb-2">🤝 Friendship Tale</h3>
                            <p class="text-sm text-gray-600">Animals learning to work together</p>
                            <span class="difficulty-badge difficulty-easy mt-2">Easy</span>
                        </div>
                        <div class="p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition-colors" onclick="loadStoryTemplate('fantasy')">
                            <h3 class="font-medium mb-2">🐉 Fantasy World</h3>
                            <p class="text-sm text-gray-600">Magical creatures and enchanted lands</p>
                            <span class="difficulty-badge difficulty-hard mt-2">Advanced</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Images Section -->
        <div id="images-section" class="section p-6" style="display: none;">
            <div class="max-w-6xl mx-auto">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">🖼️ AI Image Generation</h1>
                
                <div class="grid gap-6 lg:grid-cols-2">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Image Generation Parameters</h2>
                        <form id="image-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Detailed Prompt</label>
                                <textarea id="image-prompt" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent h-24" placeholder="A friendly cartoon rabbit sitting in a magical garden, surrounded by large colorful flowers and butterflies, black outline style for coloring book, simple lines, no shading"></textarea>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Art Style</label>
                                    <select id="image-style" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="coloring-book">Coloring Book</option>
                                        <option value="cartoon">Cartoon</option>
                                        <option value="realistic">Realistic</option>
                                        <option value="manga">Manga/Anime</option>
                                        <option value="simple">Simple/Minimalist</option>
                                        <option value="detailed">Detailed/Complex</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Target Age</label>
                                    <select id="image-age-target" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="preschool">Preschool (3-5)</option>
                                        <option value="elementary">Elementary (6-8)</option>
                                        <option value="tween">Tween (9-12)</option>
                                        <option value="teen">Teen (13+)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Line Weight: <span id="line-weight-value">5</span></label>
                                <input type="range" id="line-weight" min="1" max="10" value="5" class="w-full" oninput="document.getElementById('line-weight-value').textContent = this.value">
                                <div class="text-xs text-gray-500 flex justify-between mt-1">
                                    <span>Thin</span><span>Thick</span>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Complexity: <span id="complexity-value">5</span></label>
                                <input type="range" id="complexity" min="1" max="10" value="5" class="w-full" oninput="document.getElementById('complexity-value').textContent = this.value">
                                <div class="text-xs text-gray-500 flex justify-between mt-1">
                                    <span>Simple</span><span>Complex</span>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Characters to Include</label>
                                <input type="text" id="image-characters" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Based on current story characters (optional)">
                            </div>
                            
                            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                                ✨ Generate Coloring Page
                            </button>
                        </form>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Generated Image</h2>
                        <div id="image-progress" class="progress-bar mb-4" style="display: none;">
                            <div id="image-progress-fill" class="progress-fill"></div>
                        </div>
                        <div id="generated-image-container" class="bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 aspect-square flex items-center justify-center text-gray-500 mb-4">
                            <div class="text-center">
                                🖼️ Generated coloring page will appear here
                                <p class="text-sm mt-2">Note: Currently using placeholder image generation</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="downloadGeneratedImage()" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors" disabled>
                                📥 Download
                            </button>
                            <button onclick="saveToProject()" class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors" disabled>
                                💾 Save to Project
                            </button>
                            <button onclick="editInCanvas()" class="flex-1 bg-yellow-600 text-white py-2 rounded-lg hover:bg-yellow-700 transition-colors" disabled>
                                ✏️ Edit
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Photo Converter Section -->
        <div id="convert-section" class="section p-6" style="display: none;">
            <div class="max-w-6xl mx-auto">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">🔄 Photo to Coloring Page Converter</h1>
                
                <div class="grid gap-6 lg:grid-cols-2">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Upload Photo</h2>
                        
                        <div id="photo-upload-zone" class="drag-drop-zone mb-4">
                            <input type="file" id="photo-input" accept="image/*" class="hidden" onchange="handlePhotoUpload(event)">
                            <div class="text-center">
                                ☁️ Drop your photo here
                                <p class="text-gray-500 mb-4">or click to browse</p>
                                <button onclick="document.getElementById('photo-input').click()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                    Choose File
                                </button>
                            </div>
                        </div>
                        
                        <div id="photo-preview-container" class="hidden mb-4" style="display: none;">
                            <img id="photo-preview" class="image-preview mx-auto">
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Conversion Style</label>
                                <select id="conversion-style" class="w-full p-3 border border-gray-300 rounded-lg">
                                    <option value="edge-detection">Edge Detection (Canny)</option>
                                    <option value="kmeans-cluster">K-Means Clustering</option>
                                    <option value="gaussian-blur">Gaussian Blur + Edges</option>
                                    <option value="pencil-sketch">Pencil Sketch</option>
                                    <option value="cartoon">Cartoon Style</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Colors: <span id="color-count-value">8</span></label>
                                    <input type="range" id="color-count" min="3" max="20" value="8" class="w-full" oninput="document.getElementById('color-count-value').textContent = this.value">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Detail Level: <span id="detail-level-value">5</span></label>
                                    <input type="range" id="detail-level" min="1" max="10" value="5" class="w-full" oninput="document.getElementById('detail-level-value').textContent = this.value">
                                </div>
                            </div>
                            
                            <button onclick="convertPhoto()" id="convert-btn" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-colors" disabled>
                                🔄 Convert to Coloring Page
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Converted Result</h2>
                        <div id="conversion-progress" class="progress-bar mb-4" style="display: none;">
                            <div id="conversion-progress-fill" class="progress-fill"></div>
                        </div>
                        <div id="converted-result" class="bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 aspect-square flex items-center justify-center text-gray-500 mb-4">
                            <div class="text-center">
                                🖼️ Converted coloring page will appear here
                            </div>
                        </div>
                        
                        <div id="color-palette-result" class="hidden mb-4" style="display: none;">
                            <h3 class="text-sm font-medium text-gray-700 mb-2">Extracted Color Palette</h3>
                            <div id="palette-colors" class="flex gap-2 flex-wrap"></div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="downloadConverted()" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors" disabled>
                                📥 Download
                            </button>
                            <button onclick="saveConvertedToProject()" class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors" disabled>
                                💾 Save to Project
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Canvas Section -->
        <div id="canvas-section" class="section p-6" style="display: none;">
            <div class="max-w-7xl mx-auto">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">🖌️ Professional Drawing Canvas</h1>
                
                <div class="grid gap-6 lg:grid-cols-4">
                    <div class="bg-white rounded-lg shadow-md p-4">
                        <h3 class="font-semibold mb-4">Drawing Tools</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mode</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="setDrawingMode('draw')" class="mode-btn bg-blue-100 text-blue-800 p-2 rounded text-sm font-medium active">
                                        🖌️ Draw
                                    </button>
                                    <button onclick="setDrawingMode('erase')" class="mode-btn bg-red-100 text-red-800 p-2 rounded text-sm font-medium">
                                        🧽 Erase
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Colors</label>
                                <div id="color-palette" class="grid grid-cols-6 gap-1 mb-2"></div>
                                <input type="color" id="custom-color" class="w-full h-8 rounded border" value="#000000" onchange="selectCustomColor(this.value)">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Brush Size: <span id="brush-size-value">5</span></label>
                                <input type="range" id="brush-size" min="1" max="50" value="5" class="w-full" oninput="updateBrushSize(this.value)">
                                <div id="brush-preview" class="bg-black rounded-full mx-auto mt-2" style="width: 5px; height: 5px;"></div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Opacity: <span id="opacity-value">100</span>%</label>
                                <input type="range" id="opacity-slider" min="10" max="100" value="100" class="w-full" oninput="updateOpacity(this.value)">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Templates</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="template-preview" onclick="loadTemplate('butterfly')">🦋</div>
                                    <div class="template-preview" onclick="loadTemplate('flower')">🌸</div>
                                    <div class="template-preview" onclick="loadTemplate('star')">⭐</div>
                                    <div class="template-preview" onclick="loadTemplate('heart')">❤️</div>
                                    <div class="template-preview" onclick="loadTemplate('tree')">🌳</div>
                                    <div class="template-preview" onclick="loadTemplate('house')">🏠</div>
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <button onclick="undoDrawing()" class="w-full bg-yellow-600 text-white py-2 rounded hover:bg-yellow-700 transition-colors">
                                    ↶ Undo
                                </button>
                                <button onclick="redoDrawing()" class="w-full bg-orange-600 text-white py-2 rounded hover:bg-orange-700 transition-colors">
                                    ↷ Redo
                                </button>
                                <button onclick="clearCanvas()" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700 transition-colors">
                                    🗑️ Clear
                                </button>
                                <button onclick="saveCanvas()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 transition-colors">
                                    💾 Save
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="lg:col-span-3 bg-white rounded-lg shadow-md p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Canvas</h3>
                            <div class="flex gap-2">
                                <button onclick="toggleGrid()" class="px-3 py-1 bg-gray-100 text-gray-700 rounded text-sm hover:bg-gray-200">
                                    📏 Grid
                                </button>
                                <button onclick="fullscreen()" class="px-3 py-1 bg-gray-100 text-gray-700 rounded text-sm hover:bg-gray-200">
                                    ⛶ Fullscreen
                                </button>
                            </div>
                        </div>
                        <div class="canvas-container">
                            <canvas id="drawingCanvas" width="800" height="600" class="max-w-full h-auto"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Layout Section -->
        <div id="layout-section" class="section p-6" style="display: none;">
            <div class="max-w-6xl mx-auto">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">📐 Layout Designer</h1>
                
                <div class="grid gap-6 lg:grid-cols-3">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Page Settings</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Page Size</label>
                                <select id="page-size" class="w-full p-3 border border-gray-300 rounded-lg" onchange="updatePageLayout()">
                                    <option value="letter">8.5" x 11" (Letter)</option>
                                    <option value="legal">8.5" x 14" (Legal)</option>
                                    <option value="a4">8.27" x 11.69" (A4)</option>
                                    <option value="a5">5.83" x 8.27" (A5)</option>
                                    <option value="custom">Custom Size</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Orientation</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="setOrientation('portrait')" class="p-2 border border-gray-300 rounded hover:bg-gray-50 orientation-btn active">Portrait</button>
                                    <button onclick="setOrientation('landscape')" class="p-2 border border-gray-300 rounded hover:bg-gray-50 orientation-btn">Landscape</button>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Margins: <span id="margin-value">1</span>"</label>
                                <input type="range" id="margin-slider" min="0.25" max="2" step="0.25" value="1" class="w-full" oninput="updateMargins(this.value)">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Binding</label>
                                <select id="binding-type" class="w-full p-3 border border-gray-300 rounded-lg">
                                    <option value="perfect">Perfect Binding</option>
                                    <option value="spiral">Spiral Binding</option>
                                    <option value="saddle">Saddle Stitch</option>
                                    <option value="hardcover">Hardcover</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="lg:col-span-2 bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Page Layout Preview</h2>
                        <div id="layout-preview" class="bg-gray-100 rounded-lg p-8 aspect-[8.5/11] flex items-center justify-center border-2 border-dashed border-gray-300 relative">
                            <div id="layout-content" class="w-full h-full relative bg-white shadow-sm">
                                <div class="absolute inset-4 border border-gray-300 rounded">
                                    <div class="w-full h-full flex items-center justify-center text-gray-500">
                                        <div class="text-center">
                                            📐 Drag elements here to design your page
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Layout Elements</h2>
                    <div class="grid gap-4 md:grid-cols-6">
                        <div class="element-tool border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors" draggable="true" data-element="image">
                            🖼️<p class="text-sm font-medium mt-2">Coloring Image</p>
                        </div>
                        <div class="element-tool border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors" draggable="true" data-element="text">
                            📝<p class="text-sm font-medium mt-2">Text Block</p>
                        </div>
                        <div class="element-tool border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors" draggable="true" data-element="border">
                            ⬜<p class="text-sm font-medium mt-2">Border/Frame</p>
                        </div>
                        <div class="element-tool border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors" draggable="true" data-element="page-number">
                            #<p class="text-sm font-medium mt-2">Page Number</p>
                        </div>
                        <div class="element-tool border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors" draggable="true" data-element="title">
                            📋<p class="text-sm font-medium mt-2">Title/Header</p>
                        </div>
                        <div class="element-tool border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors" draggable="true" data-element="decoration">
                            ✨<p class="text-sm font-medium mt-2">Decoration</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- KDP Compliance Section -->
        <div id="kdp-section" class="section p-6" style="display: none;">
            <div class="max-w-6xl mx-auto">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">✅ Amazon KDP Compliance Checker</h1>
                
                <div class="grid gap-6 lg:grid-cols-2">
                    <!-- Compliance Check Panel -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Project Compliance Check</h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Select Project to Check</label>
                                <select id="kdp-project" class="w-full p-3 border border-gray-300 rounded-lg" onchange="loadKDPProjectCheck()">
                                    <option value="">Choose a project to analyze...</option>
                                </select>
                            </div>
                            
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" id="check-content" class="rounded" checked>
                                    <span class="ml-2 text-sm">Content Guidelines</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="check-technical" class="rounded" checked>
                                    <span class="ml-2 text-sm">Technical Requirements</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="check-format" class="rounded" checked>
                                    <span class="ml-2 text-sm">Format Specifications</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="check-copyright" class="rounded" checked>
                                    <span class="ml-2 text-sm">Copyright & IP</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="check-quality" class="rounded" checked>
                                    <span class="ml-2 text-sm">Quality Standards</span>
                                </label>
                            </div>
                            
                            <div id="kdp-progress" class="progress-bar" style="display: none;">
                                <div id="kdp-progress-fill" class="progress-fill"></div>
                            </div>
                            
                            <button onclick="runKDPComplianceCheck()" id="kdp-check-btn" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors" disabled>
                                🔍 Run Compliance Check
                            </button>
                        </div>
                        
                        <!-- Quick Fix Actions -->
                        <div id="quick-fixes" class="mt-6 space-y-2" style="display: none;">
                            <h3 class="font-semibold text-gray-800">Quick Fixes</h3>
                            <button onclick="autoFixMargins()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 text-sm">
                                📏 Auto-Fix Margins
                            </button>
                            <button onclick="autoFixResolution()" class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700 text-sm">
                                🖼️ Optimize Resolution
                            </button>
                            <button onclick="autoFixBleed()" class="w-full bg-yellow-600 text-white py-2 rounded hover:bg-yellow-700 text-sm">
                                ✂️ Add Bleed Areas
                            </button>
                        </div>
                    </div>
                    
                    <!-- Results Panel -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Compliance Results</h2>
                        
                        <div id="compliance-results" class="space-y-4">
                            <div class="text-center text-gray-500 py-8">
                                📋 Select a project and run compliance check to see results
                            </div>
                        </div>
                        
                        <!-- Overall Score -->
                        <div id="compliance-score" class="mt-6 p-4 bg-gray-50 rounded-lg" style="display: none;">
                            <div class="flex items-center justify-between">
                                <span class="font-semibold">Overall Compliance Score</span>
                                <span id="score-value" class="text-2xl font-bold text-green-600">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                <div id="score-bar" class="bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- KDP Guidelines Reference -->
                <div class="mt-6 bg-white rounded-lg shadow-md p-6">
                    <h2<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ColorBook Engine - Professional Creator Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        
        .sidebar-scrollbar::-webkit-scrollbar { width: 4px; }
        .sidebar-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .sidebar-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .canvas-container { position: relative; display: inline-block; }
        #drawingCanvas { border: 2px solid #e2e8f0; border-radius: 8px; cursor: crosshair; background: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        
        .tool-btn { transition: all 0.2s ease; }
        .tool-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        
        .color-swatch { transition: all 0.2s ease; }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch.active { transform: scale(1.2); box-shadow: 0 0 0 3px #3b82f6; }
        
        .template-preview { aspect-ratio: 1; border: 2px solid #e2e8f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 2rem; cursor: pointer; transition: all 0.2s ease; }
        .template-preview:hover { border-color: #3b82f6; background-color: #eff6ff; }
        
        .loading-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .drag-drop-zone { border: 2px dashed #cbd5e1; border-radius: 8px; padding: 2rem; text-align: center; transition: all 0.3s ease; }
        .drag-drop-zone.drag-over { border-color: #3b82f6; background-color: #eff6ff; }
        
        .progress-bar { width: 100%; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: #3b82f6; transition: width 0.3s ease; }
        
        .notification { position: fixed; top: 1rem; right: 1rem; z-index: 1000; background: white; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); padding: 1rem; transform: translateX(100%); transition: transform 0.3s ease; }
        .notification.show { transform: translateX(0); }
        
        .difficulty-badge { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500; }
        .difficulty-easy { background: #dcfce7; color: #166534; }
        .difficulty-medium { background: #fef3c7; color: #92400e; }
        .difficulty-hard { background: #fee2e2; color: #991b1b; }
        
        .image-preview { max-width: 200px; max-height: 200px; object-fit: cover; border-radius: 8px; border: 2px solid #e5e7eb; }
        
        .api-config { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
        
        .palette-color { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.2s ease; }
        .palette-color:hover { transform: scale(1.1); }
        
        .model-badge { display: inline-block; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.625rem; font-weight: 500; margin-left: 0.25rem; }
        .model-free { background: #dcfce7; color: #166534; }
        .model-paid { background: #fef3c7; color: #92400e; }
        
        .compliance-check { border-left: 4px solid #3b82f6; background: #eff6ff; padding: 1rem; margin: 0.5rem 0; border-radius: 0 8px 8px 0; }
        .compliance-pass { border-left-color: #059669; background: #ecfdf5; }
        .compliance-warning { border-left-color: #d97706; background: #fffbeb; }
        .compliance-fail { border-left-color: #dc2626; background: #fef2f2; }
        
        /* Icon fallbacks */
        .icon-fallback { display: inline-block; width: 1rem; height: 1rem; text-align: center; line-height: 1rem; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Notification System -->
    <div id="notification" class="notification">
        <div class="flex items-center gap-2">
            <div id="notification-icon">ℹ️</div>
            <div id="notification-message"></div>
        </div>
    </div>

    <!-- API Configuration Modal -->
    <div id="api-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4">🤖 AI Configuration</h2>
            
            <!-- Text Generation Setup -->
            <div class="space-y-4 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">📝 Text Generation (OpenRouter)</h3>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">OpenRouter API Key</label>
                    <input type="password" id="openrouter-key" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="sk-or-v1-...">
                    <p class="text-sm text-gray-500 mt-1">Get your key at <a href="https://openrouter.ai/keys" target="_blank" class="text-blue-600">openrouter.ai/keys</a></p>
                    <p class="text-xs text-green-600 mt-1">💡 Many models are completely FREE to use!</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">AI Model</label>
                    <select id="ai-model" class="w-full p-3 border border-gray-300 rounded-lg">
                        <optgroup label="🆓 FREE Models (Recommended)">
                            <option value="google/gemma-2-9b-it:free">Gemma 2 9B (FREE) - Google</option>
                            <option value="meta-llama/llama-3.1-8b-instruct:free">Llama 3.1 8B (FREE) - Meta</option>
                            <option value="microsoft/phi-3-mini-128k-instruct:free">Phi-3 Mini (FREE) - Microsoft</option>
                            <option value="huggingfaceh4/zephyr-7b-beta:free">Zephyr 7B (FREE) - HuggingFace</option>
                            <option value="openchat/openchat-7b:free">OpenChat 7B (FREE)</option>
                            <option value="gryphe/mythomist-7b:free">Mythomist 7B (FREE)</option>
                        </optgroup>
                        <optgroup label="💰 Premium Models">
                            <option value="openai/gpt-4o">GPT-4O - OpenAI</option>
                            <option value="openai/gpt-4-turbo">GPT-4 Turbo - OpenAI</option>
                            <option value="anthropic/claude-3-5-sonnet">Claude 3.5 Sonnet - Anthropic</option>
                            <option value="google/gemini-pro-1.5">Gemini Pro 1.5 - Google</option>
                            <option value="meta-llama/llama-3.1-70b-instruct">Llama 3.1 70B - Meta</option>
                        </optgroup>
                    </select>
                </div>
            </div>
            
            <!-- Image Generation Setup -->
            <div class="space-y-4 mb-6 border-t pt-4">
                <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">🎨 Image Generation (Optional)</h3>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Image Generation Service</label>
                    <select id="image-service" class="w-full p-3 border border-gray-300 rounded-lg" onchange="toggleImageApiFields()">
                        <option value="none">None (Use Advanced Placeholders)</option>
                        <option value="openai">OpenAI DALL-E</option>
                        <option value="stabilityai">Stability AI</option>
                        <option value="midjourney">Midjourney (via API)</option>
                        <option value="replicate">Replicate</option>
                    </select>
                </div>
                <div id="image-api-fields" style="display: none;">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Image API Key</label>
                        <input type="password" id="image-api-key" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Enter your image API key">
                        <p class="text-sm text-gray-500 mt-1">Required for real image generation</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Model/Engine</label>
                        <select id="image-model" class="w-full p-3 border border-gray-300 rounded-lg">
                            <option value="dall-e-3">DALL-E 3 (OpenAI)</option>
                            <option value="dall-e-2">DALL-E 2 (OpenAI)</option>
                            <option value="stable-diffusion-xl">Stable Diffusion XL</option>
                            <option value="midjourney-v6">Midjourney v6</option>
                        </select>
                    </div>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p class="text-sm text-blue-700">
                        <strong>💡 Note:</strong> Image generation is optional. The app works great with advanced placeholder generation. 
                        Real AI image generation requires separate API access and costs.
                    </p>
                </div>
            </div>
            
            <div class="flex gap-2 mt-6">
                <button onclick="saveApiConfig()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Save & Test</button>
                <button onclick="closeApiModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div id="sidebar" class="fixed left-0 top-0 h-full w-64 bg-white shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out z-40 md:translate-x-0">
        <div class="p-6 border-b">
            <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                🎨 ColorBook Engine Pro
            </h1>
            <button onclick="openApiModal()" class="text-xs text-blue-600 hover:text-blue-800 mt-1">⚙️ Configure AI (FREE models available!)</button>
        </div>
        
        <nav class="p-4 sidebar-scrollbar overflow-y-auto h-full">
            <ul class="space-y-2">
                <li><button onclick="showSection('dashboard')" class="w-full text-left p-3 rounded-lg hover:bg-blue-50 transition-colors flex items-center gap-3 nav-btn" data-section="dashboard">🏠 Dashboard</button></li>
                <li><button onclick="showSection('projects')" class="w-full text-left p-3 rounded-lg hover:bg-blue-50 transition-colors flex items-center gap-3 nav-btn" data-section="projects">📁 Projects</button></li>
                <li><button onclick="showSection('story')" class="w-full text-left p-3 rounded-lg hover:bg-blue-50 transition-colors flex items-center gap-3 nav-btn" data-section="story">📖 AI Story Generator</button></li>
                <li><button onclick="showSection('images')" class="w-full text-left p-3 rounded-lg hover:bg-blue-50 transition-colors flex items-center gap-3 nav-btn" data-section="images">🖼️ AI Images</button></li>
                <li><button onclick="showSection('convert')" class="w-full text-left p-3 rounded-lg hover:bg-blue-50 transition-colors flex items-center gap-3 nav-btn" data-section="convert">🔄 Photo Converter</button></li>
                <li><button onclick="showSection('canvas')" class="w-full text-left p-3 rounded-lg hover:bg-blue-50 transition-colors flex items-center gap-3 nav-btn" data-section="canvas">🖌️ Drawing Canvas</button></li>
                <li><button onclick="showSection('layout')" class="w-full text-left p-3 rounded-lg hover:bg-blue-50 transition-colors flex items-center gap-3 nav-btn" data-section="layout">📐 Layout Designer</button></li>
                <li><button onclick="showSection('kdp')" class="w-full text-left p-3 rounded-lg hover:bg-blue-50 transition-colors flex items-center gap-3 nav-btn" data-section="kdp">✅ KDP Compliance</button></li>
                <li><button onclick="showSection('pdf')" class="w-full text-left p-3 rounded-lg hover:bg-blue-50 transition-colors flex items-center gap-3 nav-btn" data-section="pdf">📄 PDF Export</button></li>
            </ul>
        </nav>
    </div>

    <!-- Mobile menu button -->
    <button id="mobileMenuBtn" class="md:hidden fixed top-4 left-4 z-50 p-2 bg-white rounded-lg shadow-lg">
        ☰
    </button>

    <!-- Main Content -->
    <div class="md:ml-64 min-h-screen">
        <!-- Dashboard Section -->
        <div id="dashboard-section" class="section active p-6">
            <div class="max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Dashboard</h1>
                        <p class="text-gray-600 mt-1">Professional Coloring Book Creator Studio</p>
                    </div>
                    <button onclick="createNewProject()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                        ➕ New Project
                    </button>
                </div>

                <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3 mb-8">
                    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer" onclick="showSection('story')">
                        <div class="bg-blue-100 p-3 rounded-lg mb-4 w-fit">📖</div>
                        <h3 class="text-xl font-semibold mb-2">AI Story Generator</h3>
                        <p class="text-gray-600">Generate engaging stories with FREE AI models <span class="model-badge model-free">FREE</span></p>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer" onclick="showSection('images')">
                        <div class="bg-green-100 p-3 rounded-lg mb-4 w-fit">🖼️</div>
                        <h3 class="text-xl font-semibold mb-2">AI Image Generation</h3>
                        <p class="text-gray-600">Create custom coloring pages with AI prompting</p>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer" onclick="showSection('convert')">
                        <div class="bg-purple-100 p-3 rounded-lg mb-4 w-fit">🔄</div>
                        <h3 class="text-xl font-semibold mb-2">Photo Converter</h3>
                        <p class="text-gray-600">Convert photos to coloring pages using ML algorithms</p>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer" onclick="showSection('canvas')">
                        <div class="bg-yellow-100 p-3 rounded-lg mb-4 w-fit">🖌️</div>
                        <h3 class="text-xl font-semibold mb-2">Drawing Canvas</h3>
                        <p class="text-gray-600">Professional drawing tools with advanced features</p>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer" onclick="showSection('kdp')">
                        <div class="bg-green-100 p-3 rounded-lg mb-4 w-fit">✅</div>
                        <h3 class="text-xl font-semibold mb-2">KDP Compliance</h3>
                        <p class="text-gray-600">Check Amazon KDP publishing guidelines compliance</p>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer" onclick="showSection('pdf')">
                        <div class="bg-red-100 p-3 rounded-lg mb-4 w-fit">📄</div>
                        <h3 class="text-xl font-semibold mb-2">PDF Export</h3>
                        <p class="text-gray-600">Generate high-quality print-ready PDFs</p>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Recent Projects</h2>
                    <div id="recent-projects" class="space-y-4">
                        <p class="text-gray-500 text-center py-8">No recent projects. Create a new project to get started.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Projects Section -->
        <div id="projects-section" class="section p-6" style="display: none;">
            <div class="max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-900">Projects</h1>
                    <button onclick="createNewProject()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                        ➕ New Project
                    </button>
                </div>
                <div id="projects-grid" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3"></div>
            </div>
        </div>

        <!-- Story Section -->
        <div id="story-section" class="section p-6" style="display: none;">
            <div class="max-w-4xl mx-auto">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">🤖 AI Story Generator</h1>
                
                <div class="api-config" id="story-api-status">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">API Status: <span id="api-status">Not Configured</span></span>
                        <button onclick="openApiModal()" class="text-sm bg-blue-100 text-blue-600 px-3 py-1 rounded">Configure FREE AI</button>
                    </div>
                </div>
                
                <div class="grid gap-6 md:grid-cols-2 mb-8">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Story Parameters</h2>
                        <form id="story-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Theme/Setting</label>
                                <input type="text" id="story-theme" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., Magical forest adventure, Space exploration">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Main Characters</label>
                                <input type="text" id="story-characters" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., Brave rabbit named Luna, wise owl Professor Hoot">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Target Age Group</label>
                                <div class="flex gap-2 items-center">
                                    <input type="number" id="age-min" min="2" max="18" value="6" class="w-20 p-2 border border-gray-300 rounded-lg">
                                    <span class="text-gray-500">to</span>
                                    <input type="number" id="age-max" min="2" max="18" value="8" class="w-20 p-2 border border-gray-300 rounded-lg">
                                    <span class="text-gray-500">years, or</span>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="adult-audience" class="mr-2">
                                        <span class="text-sm">Adult</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Number of Pages</label>
                                    <input type="number" id="story-pages" min="1" max="50" value="5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Words per Page</label>
                                    <input type="number" id="words-per-page" min="10" max="500" value="80" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Image Style for Illustrations</label>
                                <select id="story-image-style" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="coloring-book">Coloring Book Style</option>
                                    <option value="cartoon">Cartoon</option>
                                    <option value="realistic">Realistic</option>
                                    <option value="manga">Manga/Anime</option>
                                    <option value="simple">Simple/Minimalist</option>
                                    <option value="detailed">Detailed/Complex</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Line Weight: <span id="story-line-weight-value">3</span></label>
                                    <input type="range" id="story-line-weight" min="1" max="10" value="3" class="w-full" oninput="document.getElementById('story-line-weight-value').textContent = this.value">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Aspect Ratio</label>
                                    <select id="story-aspect-ratio" class="w-full p-2 border border-gray-300 rounded-lg">
                                        <option value="square">Square (1:1)</option>
                                        <option value="landscape">Landscape (4:3)</option>
                                        <option value="portrait">Portrait (3:4)</option>
                                        <option value="wide">Wide (16:9)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Moral/Lesson (Optional)</label>
                                <input type="text" id="story-moral" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., Friendship, kindness, perseverance">
                            </div>
                            
                            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                                ✨ Generate Story + Image Prompts
                            </button>
                        </form>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Generated Story & Image Prompts</h2>
                        <div id="story-progress" class="progress-bar mb-4" style="display: none;">
                            <div id="story-progress-fill" class="progress-fill"></div>
                        </div>
                        <div id="generated-story" class="bg-gray-50 rounded-lg p-4 min-h-[300px] border-2 border-dashed border-gray-300 max-h-[400px] overflow-y-auto">
                            <div class="text-center text-gray-500 flex items-center justify-center h-full">
                                📖 Your AI-generated story cards will appear here
                                <p class="text-sm mt-2">Configure API and fill the form to generate</p>
                            </div>
                        </div>
                        <div class="mt-4 flex gap-2">
                            <button onclick="saveStory()" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors" disabled>
                                💾 Save Story
                            </button>
                            <button onclick="generateAllImages()" class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors" disabled>
                                🖼️ Generate All Images
                            </button>
                            <button onclick="exportStoryCards()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors" disabled>
                                📄 Export Cards
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Story Templates</h2>
                    <div class="grid gap-4 md:grid-cols-3">
                        <div class="p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition-colors" onclick="loadStoryTemplate('adventure')">
                            <h3 class="font-medium mb-2">🗺️ Adventure Quest</h
